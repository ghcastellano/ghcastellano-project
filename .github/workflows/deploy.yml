name: Deploy Production

on:
  push:
    branches:
      - main  # ou master

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID || 'projeto-poc-ap' }}
  REGION: ${{ secrets.GCP_LOCATION || 'us-central1' }}
  SERVICE_NAME: mvp-web

jobs:
  verify:
    name: ðŸ›¡ï¸ Verify & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "ðŸ“¦ DIP LIST:"
          pip list
          echo "ðŸ PYTHON INFO:"
          which python
          python --version
          
      - name: Run Sanity Check
        run: python scripts/sanity_check.py
        env:
          # Mock env vars needed for imports to work
          SECRET_KEY: "mock-key-for-test"

  deploy:
    name: ðŸš€ Build & Deploy
    needs: verify
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Auth with Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Create .env file from Secret
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env
          # Append specific secrets if not in ENV_FILE (redundancy safe)
          echo "FOLDER_ID_01_ENTRADA_RELATORIOS=${{ secrets.FOLDER_ID_01_ENTRADA_RELATORIOS }}" >> .env
          echo "FOLDER_ID_02_PLANOS_GERADOS=${{ secrets.FOLDER_ID_02_PLANOS_GERADOS }}" >> .env
          echo "FOLDER_ID_03_PROCESSADOS_BACKUP=${{ secrets.FOLDER_ID_03_PROCESSADOS_BACKUP }}" >> .env
          echo "FOLDER_ID_99_ERROS=${{ secrets.FOLDER_ID_99_ERROS }}" >> .env
          echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env
          echo "APP_PUBLIC_URL=${{ secrets.APP_PUBLIC_URL }}" >> .env
          echo "WHATSAPP_PHONE_ID=${{ secrets.WHATSAPP_PHONE_ID }}" >> .env
          echo "WHATSAPP_TOKEN=${{ secrets.WHATSAPP_TOKEN }}" >> .env
          echo "WHATSAPP_DESTINATION_PHONE=${{ secrets.WHATSAPP_DESTINATION_PHONE }}" >> .env

      - name: Execute Deploy Script
        run: |
          chmod +x deploy_and_register.sh
          # Export variables explicitly for the script
          export FOLDER_ID_01_ENTRADA_RELATORIOS="${{ secrets.FOLDER_ID_01_ENTRADA_RELATORIOS }}"
          export FOLDER_ID_02_PLANOS_GERADOS="${{ secrets.FOLDER_ID_02_PLANOS_GERADOS }}"
          export FOLDER_ID_03_PROCESSADOS_BACKUP="${{ secrets.FOLDER_ID_03_PROCESSADOS_BACKUP }}"
          export FOLDER_ID_99_ERROS="${{ secrets.FOLDER_ID_99_ERROS }}"
          export DRIVE_WEBHOOK_TOKEN="${{ secrets.DRIVE_WEBHOOK_TOKEN }}"
          export GCP_SA_KEY='${{ secrets.GCP_SA_KEY }}'
          export DATABASE_URL="${{ secrets.DATABASE_URL }}"
          export AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}"
          export AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          export AWS_SES_SENDER="${{ secrets.AWS_SES_SENDER }}"
          export OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
          export SECRET_KEY="${{ secrets.SECRET_KEY }}"
          export WHATSAPP_TOKEN="${{ secrets.WHATSAPP_TOKEN }}"
          export WHATSAPP_PHONE_ID="${{ secrets.WHATSAPP_PHONE_ID }}"
          export WHATSAPP_DESTINATION_PHONE="${{ secrets.WHATSAPP_DESTINATION_PHONE }}"
          export APP_PUBLIC_URL="${{ secrets.APP_PUBLIC_URL }}"
          
          # Run Deploy
          ./deploy_and_register.sh
