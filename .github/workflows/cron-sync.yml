name: Renew Drive Webhook

on:
  schedule:
    # Check every 5 days at 00:00 UTC for webhook renewal
    - cron: '0 0 */5 * *'
  workflow_dispatch:

env:
  PROJECT_ID: projeto-poc-ap
  REGION: us-central1
  SERVICE_NAME: mvp-web

jobs:
  renew-webhook:
    name: Renew Drive Webhook
    runs-on: ubuntu-latest

    steps:
      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get Cloud Run URL
        id: get-url
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --project ${{ env.PROJECT_ID }} \
            --format 'value(status.url)')
          echo "service_url=$URL" >> $GITHUB_OUTPUT

      - name: Renew Webhook
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ steps.get-url.outputs.service_url }}/api/cron/renew_webhook?secret=${{ secrets.WEBHOOK_SECRET_TOKEN }}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "Response ($HTTP_CODE): $BODY"

          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "::warning::Webhook renewal failed with HTTP $HTTP_CODE"
          else
            echo "Webhook renewed successfully!"
          fi
