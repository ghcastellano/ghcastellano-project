steps:
  - name: 'gcr.io/kaniko-project/executor:latest'
    args:
      - '--destination=gcr.io/$PROJECT_ID/mvp-web'
      - '--cache=false'
      # - '--cache-ttl=24h'
  
  # [CUSTOS] ZELADOR AUTOM√ÅTICO: Garante que a pol√≠tica de limpeza existe a cada deploy
  # Mant√©m apenas as 5 √∫ltimas vers√µes, deletando antigas automaticamente.
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üîß Configurando Pol√≠tica de Custos (Manter √∫ltimas 5 vers√µes)..."
        echo '{"rule":[{"action":{"type":"DELETE"},"condition":{"tagState":"ANY","olderThan":"7d"}},{"action":{"type":"DELETE"},"condition":{"tagState":"ANY","numNewerVersions":5}},{"action":{"type":"KEEP"},"condition":{"tagState":"TAGGED","tagPrefixes":["latest"]}}]}' > policy.json
        gcloud artifacts repositories set-cleanup-policies mvp-web --project=$PROJECT_ID --location=us-central1 --policy=policy.json --quiet || echo "‚ö†Ô∏è Aviso: N√£o foi poss√≠vel definir a pol√≠tica de limpeza (Permiss√µes de Admin necess√°rias). O build continuar√°."

timeout: 1200s
