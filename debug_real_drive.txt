2026-01-10 07:44:54,771 [WARNING] üìÇ Storage Service: Bucket n√£o definido. Usando armazenamento LOCAL.
2026-01-10 07:44:54,771 [INFO] ‚ö° Migra√ß√µes Puladas (Modo Dev)
2026-01-10 07:44:54,771 [INFO] üîß Carregando Blueprints...
2026-01-10 07:44:55,077 [INFO] üõ†Ô∏è Dev Routes registered at /dev
2026-01-10 07:44:55,082 [INFO] ‚úÖ Blueprints Registrados: auth, admin, manager
2026-01-10 07:44:55,082 [INFO] üìç Rotas Registradas: ['/static/<path:filename>', '/dev/', '/dev/manager/review', '/dev/consultant/review', '/dev/api/mock-save', '/dev/mock-pdf-test', '/auth/login', '/auth/logout', '/auth/change-password', '/admin/', '/admin/company/new', '/admin/company/<uuid:company_id>/delete', '/admin/establishment/new', '/admin/manager/new', '/admin/manager/<uuid:user_id>/delete', '/admin/test-job', '/admin/company/<uuid:company_id>/update', '/admin/manager/<uuid:user_id>/update', '/admin/api/monitor', '/admin/api/cron/sync_drive', '/dashboard/manager', '/manager/consultant/new', '/manager/consultant/<uuid:user_id>/update', '/manager/consultant/<uuid:user_id>/delete', '/manager/establishment/new', '/manager/establishment/<uuid:est_id>/update', '/manager/establishment/<uuid:est_id>/delete', '/manager/plan/<file_id>', '/manager/plan/<file_id>/save', '/api/status']
2026-01-10 07:44:55,083 [INFO] üîå Tentando conectar ao banco: ep-shiny-dream-a4i0k0a3-pooler.us-east-1.aws.neon.tech/neondb?channel_binding=require&sslmode=require
2026-01-10 07:44:55,083 [INFO] üîå Connection Pooling ENABLED (Size: 2, Overflow: 3)
2026-01-10 07:44:55,097 [INFO] ‚úÖ Conex√£o com Banco de Dados Inicializada
2026-01-10 07:44:55,097 [INFO] ‚úÖ Banco de dados inicializado com sucesso
2026-01-10 07:44:55,100 [INFO] üèóÔ∏è Criando tabelas (Schema Initialization)...
2026-01-10 07:44:55,100 [INFO] ‚ö° Inicializa√ß√£o de Schema Pulada (Modo Dev)
2026-01-10 07:44:55,100 [INFO] ‚ö° Migra√ß√µes Puladas (Modo Dev)
2026-01-10 07:44:55,291 [INFO] ‚úÖ Servi√ßo do Drive Inicializado
2026-01-10 07:44:55,292 [INFO] ‚úÖ Servi√ßo de Email Inicializado (MOCK)
2026-01-10 07:44:55,292 [INFO] ‚úÖ Servi√ßo de PDF Inicializado
2026-01-10 07:44:55 [info     ] Initializing ProcessorService (OpenAI Mode) folder_backup= folder_error= folder_in= folder_out=
2026-01-10 07:44:55 [info     ] OpenAI Key Status              prefix=sk-proj-UV... suffix=...kckA
2026-01-10 07:44:58,150 [INFO] üè¢ Using Company: Empresa 2
2026-01-10 07:44:58,151 [INFO] ‚öôÔ∏è Initializing ProcessorService (REAL DRIVE)...
2026-01-10 07:44:58 [info     ] Initializing ProcessorService (OpenAI Mode) folder_backup= folder_error= folder_in= folder_out=
2026-01-10 07:44:58 [info     ] OpenAI Key Status              prefix=sk-proj-UV... suffix=...kckA
2026-01-10 07:44:58,167 [WARNING] ‚ö†Ô∏è FOLDER_ID_01_ENTRADA_RELATORIOS not set. Searching Drive for '01_Entrada_Relatorios'...
2026-01-10 07:44:58,168 [INFO] üîë Autenticando usando arquivo: credentials.json
2026-01-10 07:44:58,174 [INFO] file_cache is only supported with oauth2client<4.0.0
2026-01-10 07:44:58,176 [INFO] ‚úÖ Servi√ßo do Drive Autenticado
2026-01-10 07:44:59,027 [INFO] ‚úÖ Auto-detected Folder: 01_ENTRADA_RELATORIOS (1F8NcC0aR9MQnHDCEJdbx_BuanK8rg08B)
2026-01-10 07:44:59,027 [WARNING] ‚ö†Ô∏è FOLDER_ID_02_PLANOS_GERADOS not set. Searching Drive for '02_Planos_Gerados'...
2026-01-10 07:44:59,505 [INFO] ‚úÖ Auto-detected Output Folder: 02_PLANOS_GERADOS (15Cip-MIZS8zWaXZen4n0jN8NWPo0LedP)
2026-01-10 07:44:59,505 [INFO] üìÇ INPUT FOLDER URL: https://drive.google.com/drive/u/0/folders/1F8NcC0aR9MQnHDCEJdbx_BuanK8rg08B
2026-01-10 07:44:59,505 [INFO] üëÄ Waiting for files in Input Folder (Polling)...
2026-01-10 07:44:59,796 [INFO] ‚úÖ Found 2 PDF file(s)!
2026-01-10 07:44:59,797 [INFO] üöÄ Starting Processing for: quest_resposta (3).pdf (1JMl8Y_l9to53ToG-Yh8NsC04Xdi82WCW)

üëâ POR FAVOR, ACESSE A PASTA E FA√áA UPLOAD DE UM ARQUIVO PDF AGORA:
   https://drive.google.com/drive/u/0/folders/1F8NcC0aR9MQnHDCEJdbx_BuanK8rg08B

2026-01-10 07:45:00 [info     ] üìù Trace [INIT]: Started processing quest_resposta (3).pdf file_id=1JMl8Y_l9to53ToG-Yh8NsC04Xdi82WCW
2026-01-10 07:45:01 [info     ] üìù Trace [DOWNLOAD]: Downloading from Drive... file_id=1JMl8Y_l9to53ToG-Yh8NsC04Xdi82WCW
2026-01-10 07:45:03 [info     ] üìù Trace [DOWNLOAD]: Download complete file_id=1JMl8Y_l9to53ToG-Yh8NsC04Xdi82WCW
2026-01-10 07:45:04 [info     ] üìù Trace [AI_ANALYSIS]: Sending to OpenAI... file_id=1JMl8Y_l9to53ToG-Yh8NsC04Xdi82WCW
2026-01-10 07:45:19,274 [INFO] HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2026-01-10 07:45:20 [info     ] üìù Trace [AI_ANALYSIS]: Analysis complete file_id=1JMl8Y_l9to53ToG-Yh8NsC04Xdi82WCW
2026-01-10 07:45:20 [info     ] üìù Trace [PDF_GEN]: Generating Action Plan PDF... file_id=1JMl8Y_l9to53ToG-Yh8NsC04Xdi82WCW
2026-01-10 07:45:20,893 [WARNING] Ignored `min-height: 100vh` at 80:5, invalid value.
2026-01-10 07:45:20,893 [WARNING] Ignored `position: sticky` at 91:5, invalid value.
2026-01-10 07:45:20,893 [WARNING] Ignored `box-shadow: var(--shadow-sm)` at 94:5, unknown property.
2026-01-10 07:45:20,893 [WARNING] Ignored `backdrop-filter: blur(8px)` at 95:5, unknown property.
2026-01-10 07:45:20,895 [WARNING] Ignored `box-shadow: var(--shadow-sm)` at 165:5, unknown property.
2026-01-10 07:45:20,895 [WARNING] Ignored `box-shadow: var(--shadow-md)` at 172:5, unknown property.
2026-01-10 07:45:20,896 [WARNING] Ignored `box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1)` at 261:5, unknown property.
2026-01-10 07:45:20,897 [WARNING] Ignored `box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1)` at 311:5, unknown property.
2026-01-10 07:45:20,897 [WARNING] Ignored `overflow-x: auto` at 316:5, unknown property.
2026-01-10 07:45:20,898 [WARNING] Expected a media type, got '(max-width: 768px)'
2026-01-10 07:45:20,898 [WARNING] Invalid media type ' (max-width: 768px) ' the whole @media rule was ignored at 407:1.
2026-01-10 07:45:20,946 [WARNING] Ignored `box-shadow: 0 2px 4px rgba(0,0,0,0.05)` at 1:105, unknown property.
2026-01-10 07:45:21 [info     ] üìÇ PDF Saved Locally: data/output/Plano_Acao_quest_resposta (3).pdf
2026-01-10 07:45:21,176 [INFO] üì§ Tentando upload para pasta Drive: '15Cip-MIZS8zWaXZen4n0jN8NWPo0LedP' (Arquivo: Plano_Acao_quest_resposta (3).pdf)
2026-01-10 07:45:23,294 [WARNING] Encountered 403 Forbidden with reason "storageQuotaExceeded"
2026-01-10 07:45:23,294 [WARNING] üõë Aborting retries for Plano_Acao_quest_resposta (3).pdf due to detailed error: <httperror 403 when requesting https://www.googleapis.com/upload/drive/v3/files?fields=id%2c+webviewlink&supportsalldrives=true&alt=json&uploadtype=resumable returned "service accounts do not have storage quota. leverage shared drives (https://developers.google.com/workspace/drive/api/guides/about-shareddrives), or use oauth delegation (http://support.google.com/a/answer/7281227) instead.". details: "[{'message': 'service accounts do not have storage quota. leverage shared drives (https://developers.google.com/workspace/drive/api/guides/about-shareddrives), or use oauth delegation (http://support.google.com/a/answer/7281227) instead.', 'domain': 'usagelimits', 'reason': 'storagequotaexceeded'}]">
2026-01-10 07:45:23 [warning  ] ‚ö†Ô∏è Drive Quota Limit for Output PDF. Falling back to StorageService for Plano_Acao_quest_resposta (3).pdf
2026-01-10 07:45:23,294 [ERROR] ‚ùå Erro no Upload Local: 'str' object has no attribute 'seek'
CRITICAL PDF ERROR: Traceback (most recent call last):
  File "/Users/gustavohenriquecastellano/.gemini/antigravity/scratch/mvp-inspecao-sanitaria/src/services/processor.py", line 317, in generate_pdf
    upload_res = self.drive_service.upload_file(temp_pdf, self.folder_out, output_filename)
  File "/Users/gustavohenriquecastellano/.gemini/antigravity/scratch/mvp-inspecao-sanitaria/src/services/drive_service.py", line 170, in upload_file
    raise e
  File "/Users/gustavohenriquecastellano/.gemini/antigravity/scratch/mvp-inspecao-sanitaria/src/services/drive_service.py", line 160, in upload_file
    ).execute()
      ~~~~~~~^^
  File "/opt/homebrew/lib/python3.14/site-packages/googleapiclient/_helpers.py", line 130, in positional_wrapper
    return wrapped(*args, **kwargs)
  File "/opt/homebrew/lib/python3.14/site-packages/googleapiclient/http.py", line 902, in execute
    _, body = self.next_chunk(http=http, num_retries=num_retries)
              ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/lib/python3.14/site-packages/googleapiclient/_helpers.py", line 130, in positional_wrapper
    return wrapped(*args, **kwargs)
  File "/opt/homebrew/lib/python3.14/site-packages/googleapiclient/http.py", line 1093, in next_chunk
    return self._process_response(resp, content)
           ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "/opt/homebrew/lib/python3.14/site-packages/googleapiclient/http.py", line 1124, in _process_response
    raise HttpError(resp, content, uri=self.uri)
googleapiclient.errors.HttpError: <HttpError 403 when requesting https://www.googleapis.com/upload/drive/v3/files?fields=id%2C+webViewLink&supportsAllDrives=true&alt=json&uploadType=resumable returned "Service Accounts do not have storage quota. Leverage shared drives (https://developers.google.com/workspace/drive/api/guides/about-shareddrives), or use OAuth delegation (http://support.google.com/a/answer/7281227) instead.". Details: "[{'message': 'Service Accounts do not have storage quota. Leverage shared drives (https://developers.google.com/workspace/drive/api/guides/about-shareddrives), or use OAuth delegation (http://support.google.com/a/answer/7281227) instead.', 'domain': 'usageLimits', 'reason': 'storageQuotaExceeded'}]">

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/gustavohenriquecastellano/.gemini/antigravity/scratch/mvp-inspecao-sanitaria/src/services/processor.py", line 333, in generate_pdf
    pdf_link = storage_service.upload_file(temp_pdf, "output", output_filename) # Using 'output' bucket/folder
  File "/Users/gustavohenriquecastellano/.gemini/antigravity/scratch/mvp-inspecao-sanitaria/src/services/storage_service.py", line 80, in upload_file
    raise e
  File "/Users/gustavohenriquecastellano/.gemini/antigravity/scratch/mvp-inspecao-sanitaria/src/services/storage_service.py", line 73, in upload_file
    file_obj.seek(0)
    ^^^^^^^^^^^^^
AttributeError: 'str' object has no attribute 'seek'

2026-01-10 07:45:23 [error    ] PDF Gen Error                  error="'str' object has no attribute 'seek'" traceback='Traceback (most recent call last):\n  File "/Users/gustavohenriquecastellano/.gemini/antigravity/scratch/mvp-inspecao-sanitaria/src/services/processor.py", line 317, in generate_pdf\n    upload_res = self.drive_service.upload_file(temp_pdf, self.folder_out, output_filename)\n  File "/Users/gustavohenriquecastellano/.gemini/antigravity/scratch/mvp-inspecao-sanitaria/src/services/drive_service.py", line 170, in upload_file\n    raise e\n  File "/Users/gustavohenriquecastellano/.gemini/antigravity/scratch/mvp-inspecao-sanitaria/src/services/drive_service.py", line 160, in upload_file\n    ).execute()\n      ~~~~~~~^^\n  File "/opt/homebrew/lib/python3.14/site-packages/googleapiclient/_helpers.py", line 130, in positional_wrapper\n    return wrapped(*args, **kwargs)\n  File "/opt/homebrew/lib/python3.14/site-packages/googleapiclient/http.py", line 902, in execute\n    _, body = self.next_chunk(http=http, num_retries=num_retries)\n              ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File "/opt/homebrew/lib/python3.14/site-packages/googleapiclient/_helpers.py", line 130, in positional_wrapper\n    return wrapped(*args, **kwargs)\n  File "/opt/homebrew/lib/python3.14/site-packages/googleapiclient/http.py", line 1093, in next_chunk\n    return self._process_response(resp, content)\n           ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^\n  File "/opt/homebrew/lib/python3.14/site-packages/googleapiclient/http.py", line 1124, in _process_response\n    raise HttpError(resp, content, uri=self.uri)\ngoogleapiclient.errors.HttpError: <HttpError 403 when requesting https://www.googleapis.com/upload/drive/v3/files?fields=id%2C+webViewLink&supportsAllDrives=true&alt=json&uploadType=resumable returned "Service Accounts do not have storage quota. Leverage shared drives (https://developers.google.com/workspace/drive/api/guides/about-shareddrives), or use OAuth delegation (http://support.google.com/a/answer/7281227) instead.". Details: "[{\'message\': \'Service Accounts do not have storage quota. Leverage shared drives (https://developers.google.com/workspace/drive/api/guides/about-shareddrives), or use OAuth delegation (http://support.google.com/a/answer/7281227) instead.\', \'domain\': \'usageLimits\', \'reason\': \'storageQuotaExceeded\'}]">\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File "/Users/gustavohenriquecastellano/.gemini/antigravity/scratch/mvp-inspecao-sanitaria/src/services/processor.py", line 333, in generate_pdf\n    pdf_link = storage_service.upload_file(temp_pdf, "output", output_filename) # Using \'output\' bucket/folder\n  File "/Users/gustavohenriquecastellano/.gemini/antigravity/scratch/mvp-inspecao-sanitaria/src/services/storage_service.py", line 80, in upload_file\n    raise e\n  File "/Users/gustavohenriquecastellano/.gemini/antigravity/scratch/mvp-inspecao-sanitaria/src/services/storage_service.py", line 73, in upload_file\n    file_obj.seek(0)\n    ^^^^^^^^^^^^^\nAttributeError: \'str\' object has no attribute \'seek\'\n'
2026-01-10 07:45:24 [info     ] üìù Trace [PDF_GEN]: PDF generated: None file_id=1JMl8Y_l9to53ToG-Yh8NsC04Xdi82WCW
2026-01-10 07:45:24 [info     ] Plano gerado e salvo           link=None
2026-01-10 07:45:24 [info     ] üìù Trace [DB_SAVE]: Saving to Database... file_id=1JMl8Y_l9to53ToG-Yh8NsC04Xdi82WCW
2026-01-10 07:45:25 [info     ] üìç Target Establishment: KFC BAURU (ID: 8b9b90fc-a536-434c-bdac-26eb77f89618)
2026-01-10 07:45:25 [info     ] ‚úÖ Inspection e9addec9-6445-4d75-a71e-479bb140c968 updated/created
2026-01-10 07:45:25 [info     ] üÜï ActionPlan created
2026-01-10 07:45:25 [info     ] üóëÔ∏è Deleted 0 old items
2026-01-10 07:45:25 [info     ] üîç Iterating 2 areas
2026-01-10 07:45:25 [info     ]   üìÇ Area: √Årea de atendimento / sal√£o de consumo (0 items)
2026-01-10 07:45:25 [info     ]   üìÇ Area: Cozinha / √Årea de Manipula√ß√£o 01 (4 items)
2026-01-10 07:45:25 [info     ] üìä Stats generated: 4 items, 4 NCs
2026-01-10 07:45:26 [info     ] ‚úÖ DB Save Success (ChecklistSanitario Structure)
2026-01-10 07:45:26 [info     ] üìù Trace [COMPLETED]: Processing completely finished. file_id=1JMl8Y_l9to53ToG-Yh8NsC04Xdi82WCW
2026-01-10 07:45:26,854 [INFO] ‚úÖ SUCCESS! Output Link: {'usage': {'prompt_tokens': 7111, 'completion_tokens': 690, 'total_tokens': 7801}, 'output_link': None}

üìÑ PDF FINAL GERADO: {'usage': {'prompt_tokens': 7111, 'completion_tokens': 690, 'total_tokens': 7801}, 'output_link': None}

