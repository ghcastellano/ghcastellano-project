{% extends "layout.html" %}

{% block title %}Admin Panel | InspetorAI{% endblock %}

{% block content %}

<div class="admin-wrapper">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
        <h3
            style="margin-bottom: 2rem; font-size: 1.1rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
            <i class="ph-fill ph-shield-check" style="color: var(--accent-color);"></i>
            Modera√ß√£o
        </h3>

        <div class="sidebar-header">Principal</div>
        <ul class="sidebar-menu">
            <li class="sidebar-item active" id="menu-overview" onclick="showSection('overview', this)">
                <div class="sidebar-dot"></div> Vis√£o Geral
            </li>
            <li class="sidebar-item" id="menu-companies" onclick="showSection('companies', this)">
                <div class="sidebar-dot"></div> Empresas (Tenants)
            </li>
            <li class="sidebar-item" id="menu-managers" onclick="showSection('managers', this)">
                <div class="sidebar-dot"></div> Acessos & Gestores
            </li>
        </ul>

        <div class="sidebar-header">Tecnico</div>
        <ul class="sidebar-menu">
            <li class="sidebar-item" id="menu-monitoring" onclick="showSection('monitoring', this)">
                <div class="sidebar-dot"></div> Monitoramento Jobs
            </li>
            <li class="sidebar-item" id="menu-system" onclick="showSection('system', this)">
                <div class="sidebar-dot"></div> Logs & Sistema
            </li>
        </ul>

        <div class="sidebar-header">Sistema</div>
        <ul class="sidebar-menu">
            <li class="sidebar-item" id="menu-settings" onclick="showSection('settings', this); loadSettings();">
                <div class="sidebar-dot"></div> Configuracoes
            </li>
        </ul>

        <!-- Company Filter -->
        <div style="margin-top: auto; padding-top: 2rem;">
            <label class="form-label" style="font-size: 0.75rem; color: var(--text-light);">FILTRAR POR EMPRESA</label>
            <select id="adminCompanyFilter" onchange="handleAdminCompanyFilter(this.value)" class="form-control"
                style="font-size: 0.85rem;">
                <option value="">Todas as Empresas</option>
                {% for company in companies %}
                <option value="{{ company.id }}">{{ company.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Info Box -->
        <div
            style="padding: 1rem; margin-top: 1rem; background: rgba(239, 246, 255, 0.6); border-radius: 12px; border: 1px solid rgba(219, 234, 254, 0.6); font-size: 0.8rem; color: #1e40af;">
            <i class="ph-bold ph-info"></i> Painel de Super Admin. Use com cautela. A√ß√µes aqui afetam toda a plataforma.
        </div>
    </aside>

    <!-- Main Content -->
    <div class="admin-main">
        <div class="content-wrapper">
            <!-- 1. Overview Section -->
            <div id="overview" class="section-view active">
                <!-- Modern Header -->
                <div style="margin-bottom: 2.5rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <span
                                style="font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: var(--accent-color); letter-spacing: 0.05em; display: block; margin-bottom: 0.25rem;">Painel
                                Administrativo</span>
                            <h1
                                style="font-size: 2.5rem; font-weight: 700; color: var(--text-primary); letter-spacing: -0.02em; margin: 0;">
                                Ol√°, {{ current_user.name.split()[0] }} <span
                                    style="animation: wave 2s infinite; display: inline-block; transform-origin: 70% 70%;">üëã</span>
                            </h1>
                        </div>
                    </div>
                    <!-- <p class="text-muted">Vis√£o geral do sistema.</p> -->
                </div>

                <style>
                    @keyframes wave {
                        0% {
                            transform: rotate(0.0deg)
                        }

                        10% {
                            transform: rotate(14.0deg)
                        }

                        20% {
                            transform: rotate(-8.0deg)
                        }

                        30% {
                            transform: rotate(14.0deg)
                        }

                        40% {
                            transform: rotate(-4.0deg)
                        }

                        50% {
                            transform: rotate(10.0deg)
                        }

                        60% {
                            transform: rotate(0.0deg)
                        }

                        100% {
                            transform: rotate(0.0deg)
                        }
                    }
                </style>
                <div class="stats-grid">
                    <div class="stat-card" onclick="document.getElementById('menu-companies').click()">
                        <span class="stat-label">Empresas</span>
                        <span class="stat-value" id="stat-companies-count">{{ companies|length if companies else 0
                            }}</span>
                        <div class="stat-trend trend-up"><i class="ph-bold ph-caret-right"></i> Gerenciar</div>
                    </div>
                    <div class="stat-card" onclick="document.getElementById('menu-managers').click()">
                        <span class="stat-label">Gestores</span>
                        <span class="stat-value">{{ managers|length if managers else 0 }}</span>
                        <div class="stat-trend trend-up"><i class="ph-bold ph-caret-right"></i> Gerenciar</div>
                    </div>
                    <div class="stat-card" onclick="document.getElementById('menu-monitoring').click()">
                        <span class="stat-label">Monitoramento</span>
                        <span class="stat-value"><i class="ph-bold ph-activity"></i></span>
                        <div class="stat-trend trend-neutral">Ver Status</div>
                    </div>
                </div>

                <div class="card" style="margin-top: 2rem;">
                    <div class="card-header">
                        <h3 class="card-title">Atividade Recente</h3>
                    </div>
                    <div class="card-body" style="color: var(--text-secondary);">
                        <p>O sistema est√° operando normalmente. (Cloud Run Rev 119)</p>
                    </div>
                </div>
            </div> <!-- End of Overview -->

            <!-- 2. Companies Section -->
            <div id="companies" class="section-view">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                    <h1 style="font-size: 1.8rem; margin: 0;">Empresas</h1>
                    <button class="btn btn-primary" onclick="toggleCreateCompany()">
                        <i class="ph-bold ph-plus"></i> Nova Empresa
                    </button>
                </div>

                <!-- Create Form (Hidden) -->
                <div class="card" id="createCompanyCard" style="margin-bottom: 2rem; display: none;">
                    <div class="card-body">
                        <form id="createCompanyForm" onsubmit="handleCreateCompany(event)">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <!-- Simplified Form Content, handled by JS normally -->
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end;">
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label">Nome</label>
                                    <input type="text" name="name" class="form-control" placeholder="Ex: Mercado X"
                                        required>
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label">CNPJ</label>
                                    <input type="text" name="cnpj" class="form-control"
                                        placeholder="00.000.000/0000-00">
                                </div>
                                <button type="submit" class="btn btn-accent" id="btnCreateCompany">Criar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Edit Form (Hidden) -->
                <div class="card" id="editCompanyCard"
                    style="margin-bottom: 2rem; display: none; border: 1px solid #3b82f6;">
                    <div class="card-header" style="background:none; padding-bottom:0;">
                        <h4 style="margin:0; color:#1e40af;">Editar Empresa</h4>
                    </div>
                    <div class="card-body">
                        <form id="editCompanyForm" onsubmit="handleUpdateCompany(event)">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <input type="hidden" name="company_id" id="edit_company_id">
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end;">
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label">Nome</label>
                                    <input type="text" name="name" id="edit_company_name" class="form-control" required>
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label">CNPJ</label>
                                    <input type="text" name="cnpj" id="edit_company_cnpj" class="form-control">
                                </div>
                                <div style="display:flex; gap:0.5rem;">
                                    <button type="button" class="btn btn-secondary"
                                        onclick="document.getElementById('editCompanyCard').style.display='none'">Cancelar</button>
                                    <button type="submit" class="btn btn-primary" id="btnUpdateCompany">Salvar</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table class="modern-table" id="companiesTable">
                            <thead>
                                <tr>
                                    <th>Empresa</th>
                                    <th>CNPJ</th>
                                    <th>Status</th>
                                    <th class="text-right">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for company in companies %}
                                <tr id="row-company-{{ company.id }}" data-company-id="{{ company.id }}">
                                    <td style="font-weight: 600;" class="col-name">{{ company.name }}</td>
                                    <td class="text-sm text-muted col-cnpj">{{ company.cnpj or '--' }}</td>
                                    <td><span class="badge badge-success">Ativo</span></td>
                                    <td class="text-right">
                                        <div class="btn-icon-group">
                                            <button class="btn-icon btn-icon-edit" data-id="{{ company.id }}"
                                                data-name="{{ company.name }}" data-cnpj="{{ company.cnpj or '' }}"
                                                onclick="openEditCompany(this.dataset.id, this.dataset.name, this.dataset.cnpj)"
                                                title="Editar">
                                                <i class="ph-bold ph-pencil-simple"></i>
                                            </button>
                                            <button class="btn-icon btn-icon-delete"
                                                onclick="deleteCompany('{{ company.id }}', '{{ company.name }}')"
                                                title="Excluir">
                                                <i class="ph-bold ph-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <div id="companiesPaginationControls"></div>
                    </div>
                </div>
            </div>

            <!-- 3. Managers Section -->
            <div id="managers" class="section-view">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                    <h1 style="font-size: 1.8rem; margin: 0;">Gestores</h1>
                    <button class="btn btn-primary" onclick="toggleCreateManager()">
                        <i class="ph-bold ph-plus"></i> Novo Gestor
                    </button>
                </div>

                <!-- Create Form (Hidden) -->
                <div class="card" id="createManagerCard" style="margin-bottom: 2rem; display: none;">
                    <!-- Standard Create Form -->
                    <div class="card-body">
                        <form id="createManagerForm" onsubmit="handleCreateManager(event)">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <!-- Content simplified -->
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end;">
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label">Nome</label>
                                    <input type="text" name="name" class="form-control" required>
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label">Email</label>
                                    <input type="email" name="email" class="form-control" required>
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label">Empresa</label>
                                    <select name="company_id" class="form-control" required>
                                        {% for c in companies %}
                                        <option value="{{ c.id }}">{{ c.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-accent" id="btnCreateManager">Salvar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Edit Form (Hidden) -->
                <div class="card" id="editManagerCard"
                    style="margin-bottom: 2rem; display: none; border: 1px solid #3b82f6;">
                    <div class="card-header" style="background:none; padding-bottom:0;">
                        <h4 style="margin:0; color:#1e40af;">Editar Gestor</h4>
                    </div>
                    <div class="card-body">
                        <form id="editManagerForm" onsubmit="handleUpdateManager(event)">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <input type="hidden" name="user_id" id="edit_manager_id">
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end;">
                                <div class="form-group">
                                    <label class="form-label">Nome</label>
                                    <input type="text" name="name" id="edit_manager_name" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="email" name="email" id="edit_manager_email" class="form-control"
                                        required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Empresa</label>
                                    <select name="company_id" id="edit_manager_company" class="form-control" required>
                                        {% for c in companies %}
                                        <option value="{{ c.id }}">{{ c.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Nova Senha (Opcional)</label>
                                    <input type="password" name="password" class="form-control"
                                        autocomplete="off" placeholder="Deixar em branco para manter">
                                </div>
                            </div>
                            <div style="margin-top: 1rem; text-align: right;">
                                <button type="button" class="btn btn-secondary"
                                    onclick="document.getElementById('editManagerCard').style.display='none'">Cancelar</button>
                                <button type="submit" class="btn btn-primary" id="btnUpdateManager">Atualizar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table class="modern-table" id="managersTable">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Email</th>
                                    <th>Empresa Vinculada</th>
                                    <th class="text-right">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set ns = namespace(last_company=None) %}
                                {% for manager in managers %}
                                {% set comp_name = manager.company.name if manager.company else "Sem Empresa/Admin" %}
                                {% if ns.last_company != comp_name %}
                                <tr class="group-header" data-group-name="{{ comp_name }}" data-company-id="{{ manager.company_id or '' }}">
                                    <td colspan="4"><i class="ph-bold ph-buildings"></i> {{ comp_name }}</td>
                                </tr>
                                {% set ns.last_company = comp_name %}
                                {% endif %}

                                <tr id="row-manager-{{ manager.id }}" data-company-name="{{ comp_name }}" data-company-id="{{ manager.company_id or '' }}">
                                    <td style="font-weight: 500; padding-left: 2rem;" class="col-name">{{ manager.name
                                        }}</td>
                                    <td class="text-sm text-muted col-email">{{ manager.email }}</td>
                                    <td>
                                        {% if manager.company %}
                                        <span class="badge badge-blue col-comp">{{ manager.company.name }}</span>
                                        {% else %}
                                        <span class="badge badge-warning col-comp">Super Admin</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-right">
                                        <div class="btn-icon-group">
                                            <button class="btn-icon btn-icon-edit" data-id="{{ manager.id }}"
                                                data-name="{{ manager.name }}" data-email="{{ manager.email }}"
                                                data-company="{{ manager.company_id or '' }}"
                                                onclick="openEditManager(this.dataset.id, this.dataset.name, this.dataset.email, this.dataset.company)"
                                                title="Editar">
                                                <i class="ph-bold ph-pencil-simple"></i>
                                            </button>
                                            <button class="btn-icon btn-icon-delete"
                                                onclick="deleteManager('{{ manager.id }}', '{{ manager.name }}')"
                                                title="Excluir">
                                                <i class="ph-bold ph-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <div id="managersPaginationControls"></div>
                    </div>
                </div>
            </div>

            <!-- 4. Monitoring Section -->
            <div id="monitoring" class="section-view">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap;">
                    <h1 style="font-size: 1.8rem; margin: 0;">Monitoramento de Jobs</h1>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Fila de Processamento Global</h3>
                        <button onclick="updateMonitoring()" class="btn btn-secondary"
                            style="padding: 0.25rem 0.5rem;"><i class="ph-bold ph-arrows-clockwise"></i></button>
                    </div>
                    <!-- Table (Same as before) -->
                    <div class="table-container">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Tipo</th>
                                    <th>Empresa</th>
                                    <th>Arquivo / Est.</th>
                                    <th>Status</th>
                                    <th>Tokens (In/Out)</th>
                                    <th>Custo Real</th>
                                    <th>Dura√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="monitoring-tbody">
                                <tr>
                                    <td colspan="8" class="text-center text-muted">Carregando dados globais...</td>
                                </tr>
                            </tbody>
                        </table>
                        <div id="monitorPaginationControls"></div>
                    </div>
                </div>
            </div>

            <!-- 5. System Logs -->
            <div id="system" class="section-view">
                <h1 style="font-size: 1.8rem; margin-bottom: 2rem;">Logs do Sistema</h1>
                <div class="card">
                    <div class="card-body">
                        <p>Log Stream disponivel no Google Cloud Console.</p>
                        <a href="https://console.cloud.google.com/run" target="_blank" class="btn btn-secondary">Abrir Cloud Console</a>
                    </div>
                </div>
            </div>

            <!-- 6. Settings Section -->
            <div id="settings" class="section-view">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                    <h1 style="font-size: 1.8rem; margin: 0;">
                        <i class="fas fa-cog" style="color: var(--accent-color);"></i> Configuracoes
                    </h1>
                </div>
                <p style="color: #64748b; font-size: 0.85rem; margin-bottom: 1.5rem;">
                    <i class="fas fa-info-circle"></i>
                    Valores salvos aqui tem prioridade sobre variaveis de ambiente. Alteracoes em credenciais de servicos (Drive, Email, OpenAI) requerem restart do servidor.
                </p>
                <div id="settingsContainer" style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <div class="card"><div class="card-body" style="text-align:center; color:#94a3b8;">
                        <i class="fas fa-spinner fa-spin"></i> Carregando configuracoes...
                    </div></div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    function showSection(sectionId, element) {
        // Hide all sections
        document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
        // Show target section
        document.getElementById(sectionId).classList.add('active');

        // Update Sidebar
        document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
        if (element) {
            element.classList.add('active');
        }
    }

    // Company Filter
    var selectedCompanyId = '';
    var allMonitorItems = [];

    function handleAdminCompanyFilter(companyId) {
        selectedCompanyId = companyId;

        // Filter Companies table
        document.querySelectorAll('#companiesTable tbody tr').forEach(row => {
            if (!companyId || row.dataset.companyId === companyId) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });

        // Filter Managers table (rows + group headers)
        document.querySelectorAll('#managersTable tbody tr').forEach(row => {
            if (!companyId || row.dataset.companyId === companyId) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });

        // Filter Monitoring (re-render from cached data)
        renderFilteredMonitor();
    }

    function renderFilteredMonitor() {
        if (!allMonitorItems.length) return;
        const filtered = selectedCompanyId
            ? allMonitorItems.filter(i => i.company_id === selectedCompanyId)
            : allMonitorItems;

        const tbody = document.getElementById('monitoring-tbody');
        if (filtered.length > 0) {
            if (monitorPaginator) {
                monitorPaginator.setData(filtered);
            } else {
                tbody.innerHTML = filtered.map(renderMonitorRow).join('');
            }
        } else {
            if (monitorPaginator) monitorPaginator.setData([]);
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Nenhum job encontrado para esta empresa.</td></tr>';
        }
    }

    // Monitoring
    var monitorPaginator = null;

    function renderMonitorRow(item) {
        const hasError = item.status === 'FAILED';
        const isSkipped = item.status === 'SKIPPED';
        const errorBadge = hasError && item.error_code ? `<span class="badge badge-danger" style="font-size:0.65em; margin-left:4px;">${item.error_code}</span>` : '';
        const skipBadge = isSkipped ? `<span class="badge badge-warning" style="font-size:0.65em; margin-left:4px;">DUPLICATA</span>` : '';
        return `
       <tr data-company-id="${item.company_id}" style="animation: fadeIn 0.5s; ${hasError ? 'background: #fef2f2;' : isSkipped ? 'background: #fffbeb;' : ''}">
           <td>
                <span title="${item.id}" style="font-family: monospace; font-size: 0.8em; color: var(--text-muted); cursor: help;">
                    ${item.id.substring(0, 8)}...
                </span>
           </td>
           <td style="font-size: 0.85em;">
                <span class="badge badge-secondary">${translate(item.type || 'N/A')}</span>
           </td>
           <td style="font-size: 0.9em; font-weight: 500;">
                ${item.company_name}
           </td>
           <td style="font-weight: 500; font-size: 0.9em;">
                <div style="display:flex; flex-direction:column;">
                    <span><i class="ph-file-pdf" style="color: #ef4444; margin-right: 4px;"></i> ${item.filename}</span>
                    <span style="font-size:0.8em; color:#64748b;">${item.establishment}</span>
                </div>
           </td>
            <td>
                <div style="display:flex; flex-direction:column; gap:4px;">
                    <div>
                        <span class="badge badge-${getStatusColor(item.status)}" style="cursor: pointer;" onclick="openTracker('${item.id}')" title="Ver Detalhes">${translate(item.status)}</span>
                        ${errorBadge}${skipBadge}
                    </div>
                    ${item.current_stage ? '<div style="font-size:0.75em; color:#64748b;">üìç ' + item.current_stage + '</div>' : ''}
                    ${hasError && item.error_log ? '<div style="font-size:0.7em; color:#dc2626; max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="' + item.error_log + '">‚ö†Ô∏è ' + item.error_log + '</div>' : ''}
                    ${isSkipped && item.error_log ? '<div style="font-size:0.7em; color:#d97706; max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="' + item.error_log + '">‚ö†Ô∏è ' + item.error_log + '</div>' : ''}
                    ${item.last_log_message && !hasError ? '<div style="font-size:0.7em; color:#059669; max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="' + item.last_log_message + '">‚úì ' + item.last_log_message + '</div>' : ''}
                </div>
            </td>
            <td class="text-sm">
                <div style="color: #475569;" title="Entrada / Sa√≠da">
                    <span style="color:#2563eb;">${(item.tokens_input || 0).toLocaleString()}</span> /
                    <span style="color:#16a34a;">${(item.tokens_output || 0).toLocaleString()}</span>
                </div>
                <div style="font-size: 0.75em; color: #94a3b8;">Total: ${(item.tokens_total || 0).toLocaleString()}</div>
            </td>
            <td class="text-sm">
                <div style="font-weight: 600; color: #475569;">R$ ${(item.cost_brl || 0).toFixed(4)}</div>
                <div style="font-size: 0.8em; color: #64748b;">$ ${(item.cost_usd || 0).toFixed(4)}</div>
            </td>
            <td class="text-sm text-muted">
                ${item.duration ? item.duration + 's' : '-'}
                ${item.attempts > 1 ? '<div style="font-size:0.7em; color:#f59e0b;">(' + item.attempts + ' tentativas)</div>' : ''}
            </td>
        </tr>`;
    }

    async function updateMonitoring() {
        const tbody = document.getElementById('monitoring-tbody');
        try {
            const res = await fetch('/admin/api/monitor', { headers: { 'Accept': 'application/json' } });

            if (res.status === 401) {
                const errorData = await res.json();
                tbody.innerHTML = `<tr><td colspan="8" class="text-center" style="color: #f59e0b;">
                    <p style="margin-bottom: 10px;">Sess√£o expirada.</p>
                    <a href="${errorData.redirect || '/auth/login'}" style="color: #3b82f6; text-decoration: underline;">
                        Clique aqui para fazer login novamente
                    </a>
                </td></tr>`;
                return;
            }

            if (res.ok) {
                const data = await res.json();
                allMonitorItems = data.items || [];
                const filtered = selectedCompanyId
                    ? allMonitorItems.filter(i => i.company_id === selectedCompanyId)
                    : allMonitorItems;
                if (filtered.length > 0) {
                    if (monitorPaginator) {
                        monitorPaginator.setData(filtered);
                    } else {
                        tbody.innerHTML = filtered.map(renderMonitorRow).join('');
                    }
                } else {
                    if (monitorPaginator) monitorPaginator.setData([]);
                    tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">Nenhum job recente encontrado.</td></tr>`;
                }
            } else {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">Erro ao carregar monitoramento.</td></tr>`;
            }
        } catch (err) {
            console.error(err);
            tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">Erro de conex√£o: ${err.message}</td></tr>`;
        }
    }

    const TRANSLATIONS = {
        'APPROVED': 'APROVADO',

        'PENDING_MANAGER_REVIEW': 'PENDENTE REVIS√ÉO',
        'PROCESSING': 'PROCESSANDO',
        'COMPLETED': 'CONCLU√çDO',
        'REJECTED': 'REJEITADO',
        'FAILED': 'FALHA',
        'PENDING_CONSULTANT_VERIFICATION': 'AGUARDANDO VISITA',
        'PENDING': 'PENDENTE',
        'QUEUED': 'NA FILA',
        'SYNC_PROCESS': 'SINCRONIZA√á√ÉO',
        'PROCESS_REPORT': 'RELAT√ìRIO',
        'upload': 'Upload',
        'ai_process': 'Processamento IA',
        'db_save': 'Salvando DB',
        'plan_gen': 'Gerando Plano',
        'analysis': 'An√°lise',
        'manager_review': 'Revis√£o Gestor',
        'consultant_check': 'Visita Consultor',
        'finished': 'Finalizado',
        'CANCELED': 'CANCELADO',
        'SKIPPED': 'PULADO (DUPLICATA)'
    };

    function translate(text) {
        if (!text) return '';
        const upper = text.toUpperCase();
        return TRANSLATIONS[text] || TRANSLATIONS[upper] || text.replace(/_/g, ' ');
    }

    function getStatusColor(status) {
        if (status === 'COMPLETED' || status === 'APPROVED') return 'success';
        if (status === 'PROCESSING') return 'primary';
        if (status === 'REJECTED' || status === 'FAILED') return 'danger';
        if (status === 'PENDING_MANAGER_REVIEW') return 'warning';
        if (status === 'PENDING_CONSULTANT_VERIFICATION') return 'info';
        if (status === 'SKIPPED') return 'secondary';
        return 'secondary';
    }

    function renderLogsPreview(logs) {
        if (!logs || logs.length === 0) return '';
        // Small dots for last 3 steps
        const last3 = logs.slice(-3);
        return `<div style="display:flex; gap:2px; margin-top:2px;">
    ${last3.map(l => {
            let color = '#cbd5e1';
            if (l.status == 'SUCCESS') color = '#34d399';
            if (l.status == 'FAILED') color = '#f87171';
            return `<div style="width:6px; height:6px; borderRadius:50%; background:${color};" title="${l.stage}"></div>`
        }).join('')}
</div>`;
    }

    // Pagination instances for CRUD tables
    var companiesPaginator = null;
    var managersPaginator = null;

    // Auto-load monitoring data + init paginators
    document.addEventListener('DOMContentLoaded', function() {
        // Companies table pagination
        if (document.querySelector('#companiesTable tbody')) {
            companiesPaginator = new Paginator({
                container: '#companiesTable tbody',
                itemSelector: 'tr',
                controlsTarget: '#companiesPaginationControls',
                perPage: 10,
                perPageOptions: [10, 25, 50, 0],
            });
        }

        // Managers table pagination (with group headers)
        if (document.querySelector('#managersTable tbody')) {
            managersPaginator = new Paginator({
                container: '#managersTable tbody',
                itemSelector: 'tr:not(.group-header)',
                controlsTarget: '#managersPaginationControls',
                perPage: 10,
                perPageOptions: [10, 25, 50, 0],
                skipSelector: '.group-header',
            });
        }

        // Monitoring table pagination (array mode)
        monitorPaginator = new Paginator({
            controlsTarget: '#monitorPaginationControls',
            perPage: 10,
            perPageOptions: [10, 25, 50, 0],
            mode: 'array',
            renderCallback: function(pageItems) {
                var tbody = document.getElementById('monitoring-tbody');
                if (!pageItems || pageItems.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Nenhum job recente encontrado.</td></tr>';
                    return;
                }
                tbody.innerHTML = pageItems.map(renderMonitorRow).join('');
            },
        });

        updateMonitoring();
        // Only poll when tab is visible (saves Cloud Run costs)
        var monitorInterval = setInterval(updateMonitoring, 30000);
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                clearInterval(monitorInterval);
            } else {
                updateMonitoring(); // Immediate refresh on return
                monitorInterval = setInterval(updateMonitoring, 30000);
            }
        });
    });

    // --- SETTINGS ---
    let settingsLoaded = false;

    async function loadSettings() {
        if (settingsLoaded) return;
        const container = document.getElementById('settingsContainer');
        try {
            const res = await fetch('/admin/api/settings', { headers: { 'Accept': 'application/json' } });

            // Handle session expiration (401)
            if (res.status === 401) {
                const errorData = await res.json();
                container.innerHTML = `<div class="card"><div class="card-body" style="color:#f59e0b;">
                    <p style="margin-bottom: 10px;">Sess√£o expirada.</p>
                    <a href="${errorData.redirect || '/auth/login'}" style="color: #3b82f6; text-decoration: underline;">
                        Clique aqui para fazer login novamente
                    </a>
                </div></div>`;
                return;
            }

            const data = await res.json();
            if (data.error) {
                container.innerHTML = `<div class="card"><div class="card-body" style="color:#ef4444;">${data.error}</div></div>`;
                return;
            }
            renderSettingsCards(data);
            settingsLoaded = true;
        } catch (err) {
            container.innerHTML = `<div class="card"><div class="card-body" style="color:#ef4444;">Erro: ${err.message}</div></div>`;
        }
    }

    function renderSettingsCards(groups) {
        const container = document.getElementById('settingsContainer');
        let html = '';
        for (const [groupId, group] of Object.entries(groups)) {
            const configured = group.fields.filter(f => f.is_configured).length;
            const total = group.fields.length;
            let badgeClass = 'badge-danger', badgeText = `0/${total}`;
            if (configured === total) { badgeClass = 'badge-success'; badgeText = `${configured}/${total}`; }
            else if (configured > 0) { badgeClass = 'badge-warning'; badgeText = `${configured}/${total}`; }

            html += `
            <div class="card">
                <div class="card-header" style="cursor:pointer; display:flex; justify-content:space-between; align-items:center;"
                     onclick="document.getElementById('sb-${groupId}').style.display = document.getElementById('sb-${groupId}').style.display === 'none' ? 'block' : 'none'">
                    <h3 class="card-title" style="margin:0; font-size:1rem; display:flex; align-items:center; gap:0.5rem;">
                        <i class="fas ${group.icon}" style="color:var(--accent-color);"></i> ${group.label}
                    </h3>
                    <div style="display:flex; align-items:center; gap:0.75rem;">
                        <span class="badge ${badgeClass}" style="font-size:0.75rem;">${badgeText}</span>
                        <button class="btn btn-accent" style="padding:0.25rem 0.75rem; font-size:0.8rem;"
                            onclick="event.stopPropagation(); saveGroupSettings('${groupId}')">
                            <i class="fas fa-save"></i> Salvar
                        </button>
                    </div>
                </div>
                <div class="card-body" id="sb-${groupId}" style="display:none;">
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px,1fr)); gap:1rem;">
                        ${group.fields.map(f => renderField(f)).join('')}
                    </div>
                </div>
            </div>`;
        }
        container.innerHTML = html;
    }

    function renderField(f) {
        const badge = f.is_configured
            ? `<span class="badge badge-success" style="font-size:0.65rem;">Configurado${f.source === 'env' ? ' (env)' : ''}</span>`
            : '<span class="badge badge-warning" style="font-size:0.65rem;">Nao configurado</span>';
        const inputType = f.type === 'password' ? 'password' : 'text';
        let inputHtml;
        if (f.type === 'textarea') {
            inputHtml = `<textarea class="form-control settings-input" data-key="${f.key}" rows="3" placeholder="${f.label}">${f.value_masked || ''}</textarea>`;
        } else {
            inputHtml = `<input type="${inputType}" class="form-control settings-input" data-key="${f.key}" placeholder="${f.label}" value="${f.value_masked || ''}">`;
        }
        return `
        <div class="form-group" style="margin:0;">
            <label class="form-label" style="display:flex; justify-content:space-between; align-items:center;">
                <span>${f.label}</span> ${badge}
            </label>
            ${inputHtml}
            <small style="color:#94a3b8; font-size:0.7rem;">${f.key}</small>
        </div>`;
    }

    async function saveGroupSettings(groupId) {
        const container = document.getElementById('sb-' + groupId);
        if (!container) return;
        const inputs = container.querySelectorAll('.settings-input');
        const payload = {};
        inputs.forEach(input => {
            const val = (input.value || '').trim();
            if (val && !val.startsWith('****')) {
                payload[input.dataset.key] = val;
            } else if (!val) {
                payload[input.dataset.key] = '';
            }
        });
        try {
            const res = await fetch('/admin/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
                body: JSON.stringify(payload)
            });

            // Handle session expiration (401)
            if (res.status === 401) {
                const errorData = await res.json();
                showToast('Sess√£o expirada. Redirecionando para login...', 'error');
                setTimeout(() => window.location.href = errorData.redirect || '/auth/login', 1500);
                return;
            }

            const data = await res.json();
            if (res.ok) {
                showToast(data.message || 'Salvo!', 'success');
                settingsLoaded = false;
                loadSettings();
            } else {
                showToast(data.error || 'Erro ao salvar', 'error');
            }
        } catch (err) {
            showToast('Erro de conexao: ' + err.message, 'error');
        }
    }

</script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script>
    $(document).ready(function () {
        // Mask for CNPJ
        $('input[name="cnpj"]').mask('00.000.000/0000-00', { reverse: true });

        // Mask for Phone (Generic 10 or 11 digits)
        var behavior = function (val) {
            return val.replace(/\D/g, '').length === 11 ? '(00) 00000-0000' : '(00) 0000-00009';
        },
            options = {
                onKeyPress: function (val, e, field, options) {
                    field.mask(behavior.apply({}, arguments), options);
                }
            };
        $('input[name="phone"]').mask(behavior, options);

        // Re-apply mask when modal is opened or dynamic content added?
        // jQuery Mask plugin usually attaches to selector, so dynamic elements might need re-init
        // But here inputs are static in the modal.
    });
</script>
<style>
    .spin-anim {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        100 % {
            transform: rotate(360deg);
        }
    }

    .btn-delete-icon {
        background: #fee2e2;
        color: #ef4444;
        border: none;
        padding: 0.5rem;
        border-radius: 6px;
        cursor: pointer;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
<!-- TRACKER MODAL (Admin) -->
<div id="trackerModal" class="modal-overlay"
    style="display: none; z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
    <div class="modal-content glass-panel" style="max-width: 600px; width: 90%; position: relative; padding: 2rem;">
        <button onclick="document.getElementById('trackerModal').style.display='none'"
            style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748B;">&times;</button>

        <div style="text-align: center; margin-bottom: 2rem;">
            <h3 style="margin:0; color: #1e293b; font-weight: 700;">Status do Processamento</h3>
            <p id="trackerFile" style="color: #64748b; font-size: 0.9rem; margin-top: 0.5rem;">Carregando...</p>
        </div>

        <!-- Stepper -->
        <div class="tracker-stepper"
            style="display: flex; justify-content: space-between; position: relative; margin-bottom: 2rem;">
            <!-- Line -->
            <div
                style="position: absolute; top: 15px; left: 0; right: 0; height: 3px; background: #e2e8f0; z-index: 0;">
            </div>
            <div id="trackerProgressLine"
                style="position: absolute; top: 15px; left: 0; width: 0%; height: 3px; background: #10b981; z-index: 0; transition: width 0.5s;">
            </div>

            <!-- Steps (Generated via JS) -->
            <div class="step-item" style="z-index: 1; text-align: center; background: white; padding: 0 5px;">
                <div class="step-circle"
                    style="width: 32px; height: 32px; background: #10b981; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; font-weight: bold;">
                    1</div>
                <div class="step-label" style="font-size: 0.8rem; margin-top: 5px; color: #10b981;">Upload</div>
            </div>
            <!-- More steps... -->
        </div>

        <div id="trackerLogs"
            style="background: #f8fafc; padding: 1rem; border-radius: 8px; font-family: monospace; font-size: 0.8rem; color: #475569; max-height: 150px; overflow-y: auto;">
            <div style="color: #94a3b8;">Aguardando detalhes...</div>
        </div>

        <div style="text-align: center; margin-top: 2rem;">
            <button onclick="document.getElementById('trackerModal').style.display='none'" class="btn btn-primary"
                style="padding: 0.5rem 2rem;">Fechar</button>
        </div>
    </div>
</div>

<script>
    async function openTracker(inspId) {
        const modal = document.getElementById('trackerModal');
        const titleEl = document.getElementById('trackerFile');
        const logsEl = document.getElementById('trackerLogs');
        const stepperEl = document.querySelector('.tracker-stepper');

        modal.style.display = 'flex';
        titleEl.innerText = "Buscando informa√ß√µes...";
        logsEl.innerHTML = '<div style="color: #94a3b8;">Carregando...</div>';

        try {
            const res = await fetch(`/admin/api/tracker/${inspId}`);

            // Handle session expiration (401 Unauthorized)
            if (res.status === 401) {
                const data = await res.json();
                titleEl.innerText = "Sess√£o expirada";
                logsEl.innerHTML = `<div style="color: #f59e0b;">
                    <p style="margin-bottom: 10px;">${data.error || 'Sua sess√£o expirou.'}</p>
                    <a href="${data.redirect || '/auth/login'}" style="color: #3b82f6; text-decoration: underline;">
                        Clique aqui para fazer login novamente
                    </a>
                </div>`;
                return;
            }

            const data = await res.json();

            if (data.error) {
                titleEl.innerText = "Erro ao carregar";
                logsEl.innerHTML = `<div style="color: red;">${data.error}</div>`;
                return;
            }

            titleEl.innerText = data.filename;

            // Render Logs
            if (data.logs && data.logs.length > 0) {
                logsEl.innerHTML = data.logs.map(l => `<div>‚Ä¢ ${l}</div>`).join('');
            } else {
                logsEl.innerHTML = '<div style="color: #94a3b8;">Nenhum log recente.</div>';
            }

            // Render Steps
            // Order: upload, ai_process, db_save, plan_gen, analysis
            const order = ['upload', 'ai_process', 'db_save', 'plan_gen', 'analysis'];
            let html = '';
            let activeCount = 0; // For progress line

            // Background Line
            html += '<div style="position: absolute; top: 15px; left: 10px; right: 10px; height: 3px; background: #e2e8f0; z-index: 0;"></div>';

            order.forEach((key, idx) => {
                const s = data.steps[key];
                let color = '#e2e8f0'; // Gray
                let icon = idx + 1;
                let labelColor = '#94a3b8';

                if (s.status === 'completed') {
                    color = '#10b981'; // Green
                    icon = '‚úì';
                    labelColor = '#059669';
                    activeCount = idx;
                } else if (s.status === 'current') {
                    color = '#3b82f6'; // Blue
                    icon = '<i class="ph-bold ph-spinner ph-spin"></i>';
                    labelColor = '#1e40af';
                    activeCount = idx; // Partial?
                } else if (s.status === 'error') {
                    color = '#ef4444'; // Red
                    icon = '!';
                    labelColor = '#dc2626';
                }

                html += `
                    <div class="step-item" style="z-index: 1; text-align: center; flex:1; position: relative;">
                        <div class="step-circle" style="width: 32px; height: 32px; background: ${color}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            ${icon}
                        </div>
                        <div class="step-label" style="font-size: 0.75rem; margin-top: 8px; font-weight: 600; color: ${labelColor};">
                            ${s.label}
                        </div>
                    </div>`;
            });

            // Progress Line
            const progressPct = (activeCount / (order.length - 1)) * 100;
            html += `<div style="position: absolute; top: 15px; left: 10px; width: ${progressPct}%; height: 3px; background: #10b981; z-index: 0; transition: width 0.5s;"></div>`;

            stepperEl.innerHTML = html;

        } catch (e) {
            console.error('Erro ao carregar tracker:', e);
            titleEl.innerText = "Erro de conex√£o";
            logsEl.innerHTML = `<div style="color: #ef4444;">
                <p>N√£o foi poss√≠vel carregar as informa√ß√µes.</p>
                <p style="font-size: 0.75rem; color: #94a3b8; margin-top: 5px;">
                    Verifique sua conex√£o e tente novamente.
                </p>
            </div>`;
        }
    }

    // --- Toggle Functions ---
    function toggleCreateCompany() {
        const card = document.getElementById('createCompanyCard');
        const editCard = document.getElementById('editCompanyCard');
        if (editCard) editCard.style.display = 'none';
        if (card.style.display === 'none' || card.style.display === '') {
            card.style.display = 'block';
            card.scrollIntoView({ behavior: 'smooth' });
        } else {
            card.style.display = 'none';
        }
    }

    function toggleCreateManager() {
        const card = document.getElementById('createManagerCard');
        const editCard = document.getElementById('editManagerCard');
        if (editCard) editCard.style.display = 'none';
        if (card.style.display === 'none' || card.style.display === '') {
            card.style.display = 'block';
            card.scrollIntoView({ behavior: 'smooth' });
        } else {
            card.style.display = 'none';
        }
    }

    // --- TOAST NOTIFICATION ---
    function showToast(message, type = 'success') {
        const toastId = 'toast-' + Math.random().toString(36).substr(2, 9);
        const color = type === 'success' ? '#10b981' : '#ef4444';
        const bg = type === 'success' ? '#ecfdf5' : '#fef2f2';
        const icon = type === 'success' ? 'ph-check-circle' : 'ph-warning-circle';
        const html = `
            <div id="${toastId}" style="
                position: fixed; top: 20px; right: 20px; z-index: 9999;
                background: ${bg}; border-left: 4px solid ${color};
                padding: 1rem 1.5rem; border-radius: 6px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
                display: flex; align-items: center; gap: 12px;
                transform: translateX(100%); transition: transform 0.3s ease-out;
            ">
                <i class="ph-bold ${icon}" style="color: ${color}; font-size: 1.2rem;"></i>
                <div style="font-weight: 500; color: #1f2937;">${message}</div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', html);
        setTimeout(() => { const el = document.getElementById(toastId); if (el) el.style.transform = 'translateX(0)'; }, 100);
        setTimeout(() => { const el = document.getElementById(toastId); if (el) { el.style.transform = 'translateX(120%)'; setTimeout(() => el.remove(), 300); } }, 4000);
    }

    function getCsrfToken() {
        const input = document.querySelector('input[name="csrf_token"]');
        return input ? input.value : null;
    }

    // --- COMPANY CRUD ---
    async function handleCreateCompany(e) {
        e.preventDefault();
        const form = e.target;
        const btn = document.getElementById('btnCreateCompany');
        if (btn) { btn.disabled = true; btn.innerHTML = 'Criando...'; }

        try {
            const formData = new FormData(form);
            const res = await fetch("{{ url_for('admin.create_company') }}", {
                method: 'POST',
                body: formData,
                headers: { 'Accept': 'application/json', 'X-CSRFToken': getCsrfToken() }
            });

            // Handle session expiration (401)
            if (res.status === 401) {
                const errorData = await res.json();
                showToast('Sess√£o expirada. Redirecionando para login...', 'error');
                setTimeout(() => window.location.href = errorData.redirect || '/auth/login', 1500);
                return;
            }

            const data = await res.json();

            if (res.ok) {
                showToast(data.message, 'success');
                form.reset();
                document.getElementById('createCompanyCard').style.display = 'none';

                // Add row to table
                const tbody = document.querySelector('#companiesTable tbody');
                if (tbody && data.company) {
                    const c = data.company;
                    const newRow = `
                        <tr id="row-company-${c.id}" style="animation: fadeIn 0.5s;">
                            <td style="font-weight: 600;" class="col-name">${c.name}</td>
                            <td class="text-sm text-muted col-cnpj">${c.cnpj || '--'}</td>
                            <td><span class="badge badge-success">Ativo</span></td>
                            <td class="text-right">
                                <div class="btn-icon-group">
                                    <button class="btn-icon btn-icon-edit" data-id="${c.id}" data-name="${c.name}" data-cnpj="${c.cnpj || ''}"
                                        onclick="openEditCompany(this.dataset.id, this.dataset.name, this.dataset.cnpj)" title="Editar">
                                        <i class="ph-bold ph-pencil-simple"></i>
                                    </button>
                                    <button class="btn-icon btn-icon-delete"
                                        onclick="deleteCompany('${c.id}', '${c.name}')" title="Excluir">
                                        <i class="ph-bold ph-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', newRow);
                    if (companiesPaginator) companiesPaginator.refresh();

                    // Also add to manager company dropdowns
                    document.querySelectorAll('select[name="company_id"]').forEach(sel => {
                        const opt = new Option(c.name, c.id);
                        sel.add(opt);
                    });
                }
            } else {
                showToast(data.error || 'Erro ao criar empresa', 'error');
            }
        } catch (err) {
            console.error(err);
            showToast('Erro de conex√£o: ' + err.message, 'error');
        } finally {
            if (btn) { btn.disabled = false; btn.innerHTML = 'Criar'; }
        }
    }

    function openEditCompany(id, name, cnpj) {
        document.getElementById('createCompanyCard').style.display = 'none';
        const card = document.getElementById('editCompanyCard');
        card.style.display = 'block';
        document.getElementById('edit_company_id').value = id;
        document.getElementById('edit_company_name').value = name;
        document.getElementById('edit_company_cnpj').value = cnpj || '';
        window.scrollTo({ top: card.offsetTop - 100, behavior: 'smooth' });
    }

    async function handleUpdateCompany(e) {
        e.preventDefault();
        const id = document.getElementById('edit_company_id').value;
        const btn = document.getElementById('btnUpdateCompany');
        if (btn) { btn.disabled = true; btn.innerHTML = 'Salvando...'; }

        try {
            const formData = new FormData(e.target);
            const res = await fetch(`/admin/company/${id}/update`, {
                method: 'POST',
                body: formData,
                headers: { 'Accept': 'application/json', 'X-CSRFToken': getCsrfToken() }
            });

            // Handle session expiration (401)
            if (res.status === 401) {
                const errorData = await res.json();
                showToast('Sess√£o expirada. Redirecionando para login...', 'error');
                setTimeout(() => window.location.href = errorData.redirect || '/auth/login', 1500);
                return;
            }

            const data = await res.json();

            if (res.ok) {
                showToast(data.message || 'Empresa atualizada!', 'success');
                document.getElementById('editCompanyCard').style.display = 'none';

                // Update row in table
                const row = document.getElementById(`row-company-${id}`);
                if (row) {
                    const name = formData.get('name');
                    const cnpj = formData.get('cnpj');
                    const nameCell = row.querySelector('.col-name');
                    const cnpjCell = row.querySelector('.col-cnpj');
                    if (nameCell) nameCell.textContent = name;
                    if (cnpjCell) cnpjCell.textContent = cnpj || '--';

                    // Update edit button data
                    const editBtn = row.querySelector('.btn-icon-edit');
                    if (editBtn) {
                        editBtn.dataset.name = name;
                        editBtn.dataset.cnpj = cnpj || '';
                    }
                }
            } else {
                showToast(data.error || 'Erro ao atualizar', 'error');
            }
        } catch (err) {
            console.error(err);
            showToast('Erro de conex√£o: ' + err.message, 'error');
        } finally {
            if (btn) { btn.disabled = false; btn.innerHTML = 'Salvar'; }
        }
    }

    async function deleteCompany(id, name) {
        if (!confirm(`Remover empresa "${name}" e TODOS os dados vinculados (lojas, gestores, inspe√ß√µes)? Esta a√ß√£o √© irrevers√≠vel.`)) return;

        try {
            const res = await fetch(`/admin/company/${id}/delete`, {
                method: 'POST',
                headers: { 'Accept': 'application/json', 'X-CSRFToken': getCsrfToken() }
            });

            // Handle session expiration (401)
            if (res.status === 401) {
                const errorData = await res.json();
                showToast('Sess√£o expirada. Redirecionando para login...', 'error');
                setTimeout(() => window.location.href = errorData.redirect || '/auth/login', 1500);
                return;
            }

            const data = await res.json();

            if (res.ok) {
                showToast(data.message || 'Empresa removida!', 'success');
                const row = document.getElementById(`row-company-${id}`);
                if (row) {
                    row.style.background = '#fee2e2';
                    setTimeout(function() { row.remove(); if (companiesPaginator) companiesPaginator.refresh(); }, 500);
                }

                // Remover empresa dos dropdowns de gestor
                document.querySelectorAll('select[name="company_id"]').forEach(sel => {
                    const opt = sel.querySelector(`option[value="${id}"]`);
                    if (opt) opt.remove();
                });

                // Remover gestores vinculados √† empresa da tabela
                document.querySelectorAll('#managersTable tbody tr').forEach(row => {
                    const editBtn = row.querySelector(`.btn-icon-edit[data-company="${id}"]`);
                    if (editBtn) {
                        row.style.background = '#fee2e2';
                        setTimeout(() => row.remove(), 500);
                    }
                });
            } else {
                showToast(data.error || 'Erro ao remover', 'error');
            }
        } catch (err) {
            console.error(err);
            showToast('Erro de conex√£o: ' + err.message, 'error');
        }
    }

    // --- MANAGER CRUD ---
    async function handleCreateManager(e) {
        e.preventDefault();
        const form = e.target;
        const btn = document.getElementById('btnCreateManager');
        if (btn) { btn.disabled = true; btn.innerHTML = 'Criando...'; }

        try {
            const formData = new FormData(form);
            const res = await fetch("{{ url_for('admin.create_manager') }}", {
                method: 'POST',
                body: formData,
                headers: { 'Accept': 'application/json', 'X-CSRFToken': getCsrfToken() }
            });

            // Handle session expiration (401)
            if (res.status === 401) {
                const errorData = await res.json();
                showToast('Sess√£o expirada. Redirecionando para login...', 'error');
                setTimeout(() => window.location.href = errorData.redirect || '/auth/login', 1500);
                return;
            }

            const data = await res.json();

            if (res.ok) {
                showToast(data.message, 'success');
                form.reset();
                document.getElementById('createManagerCard').style.display = 'none';

                // Add row to table (with proper grouping)
                const tbody = document.querySelector('#managersTable tbody');
                if (tbody && data.manager) {
                    const m = data.manager;
                    const companyName = m.company_name;

                    // Check if group header exists for this company
                    let groupHeader = tbody.querySelector(`tr.group-header[data-group-name="${companyName}"]`);

                    // If no group header, create one and find correct position
                    if (!groupHeader) {
                        const headerHtml = `
                            <tr class="group-header" data-group-name="${companyName}">
                                <td colspan="4"><i class="ph-bold ph-buildings"></i> ${companyName}</td>
                            </tr>
                        `;

                        // Find where to insert (alphabetically by company name)
                        const allHeaders = tbody.querySelectorAll('tr.group-header');
                        let insertBefore = null;
                        for (const header of allHeaders) {
                            if (header.dataset.groupName > companyName) {
                                insertBefore = header;
                                break;
                            }
                        }

                        if (insertBefore) {
                            insertBefore.insertAdjacentHTML('beforebegin', headerHtml);
                        } else {
                            tbody.insertAdjacentHTML('beforeend', headerHtml);
                        }
                        groupHeader = tbody.querySelector(`tr.group-header[data-group-name="${companyName}"]`);
                    }

                    // Create the manager row
                    const newRow = `
                        <tr id="row-manager-${m.id}" style="animation: fadeIn 0.5s;" data-company-name="${companyName}">
                            <td style="font-weight: 500; padding-left: 2rem;" class="col-name">${m.name}</td>
                            <td class="text-sm text-muted col-email">${m.email}</td>
                            <td><span class="badge badge-blue col-comp">${companyName}</span></td>
                            <td class="text-right">
                                <div class="btn-icon-group">
                                    <button class="btn-icon btn-icon-edit" data-id="${m.id}" data-name="${m.name}" data-email="${m.email}" data-company="${m.company_id}"
                                        onclick="openEditManager(this.dataset.id, this.dataset.name, this.dataset.email, this.dataset.company)" title="Editar">
                                        <i class="ph-bold ph-pencil-simple"></i>
                                    </button>
                                    <button class="btn-icon btn-icon-delete"
                                        onclick="deleteManager('${m.id}', '${m.name}')" title="Excluir">
                                        <i class="ph-bold ph-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;

                    // Find last row of this company group and insert after it
                    const companyRows = tbody.querySelectorAll(`tr[data-company-name="${companyName}"]:not(.group-header)`);
                    if (companyRows.length > 0) {
                        companyRows[companyRows.length - 1].insertAdjacentHTML('afterend', newRow);
                    } else {
                        // No rows yet, insert right after the header
                        groupHeader.insertAdjacentHTML('afterend', newRow);
                    }
                    if (managersPaginator) managersPaginator.refresh();
                }
            } else {
                showToast(data.error || 'Erro ao criar gestor', 'error');
            }
        } catch (err) {
            console.error(err);
            showToast('Erro de conex√£o: ' + err.message, 'error');
        } finally {
            if (btn) { btn.disabled = false; btn.innerHTML = 'Salvar'; }
        }
    }

    function openEditManager(id, name, email, companyId) {
        document.getElementById('createManagerCard').style.display = 'none';
        const card = document.getElementById('editManagerCard');
        card.style.display = 'block';
        document.getElementById('edit_manager_id').value = id;
        document.getElementById('edit_manager_name').value = name;
        document.getElementById('edit_manager_email').value = email;

        // Clear password field to prevent browser auto-fill from changing password
        const pwField = document.querySelector('#editManagerForm input[name="password"]');
        if (pwField) { pwField.value = ''; }

        const companySelect = document.getElementById('edit_manager_company');
        if (companySelect && companyId) {
            Array.from(companySelect.options).forEach(opt => {
                opt.selected = (opt.value === companyId);
            });
        }

        window.scrollTo({ top: card.offsetTop - 100, behavior: 'smooth' });
    }

    async function handleUpdateManager(e) {
        e.preventDefault();
        const id = document.getElementById('edit_manager_id').value;
        const btn = document.getElementById('btnUpdateManager');
        if (btn) { btn.disabled = true; btn.innerHTML = 'Salvando...'; }

        try {
            const formData = new FormData(e.target);
            const res = await fetch(`/admin/manager/${id}/update`, {
                method: 'POST',
                body: formData,
                headers: { 'Accept': 'application/json', 'X-CSRFToken': getCsrfToken() }
            });

            // Handle session expiration (401)
            if (res.status === 401) {
                const errorData = await res.json();
                showToast('Sess√£o expirada. Redirecionando para login...', 'error');
                setTimeout(() => window.location.href = errorData.redirect || '/auth/login', 1500);
                return;
            }

            const data = await res.json();

            if (res.ok) {
                showToast(data.message || 'Gestor atualizado!', 'success');
                document.getElementById('editManagerCard').style.display = 'none';

                // Update row and move to correct group if company changed
                const row = document.getElementById(`row-manager-${id}`);
                if (row) {
                    const name = formData.get('name');
                    const email = formData.get('email');
                    const companySelect = document.getElementById('edit_manager_company');
                    const companyName = companySelect ? companySelect.options[companySelect.selectedIndex].text : '';
                    const companyId = formData.get('company_id');
                    const oldCompanyName = row.dataset.companyName;

                    // Update cell contents
                    const nameCell = row.querySelector('.col-name');
                    const emailCell = row.querySelector('.col-email');
                    const compCell = row.querySelector('.col-comp');
                    if (nameCell) nameCell.textContent = name;
                    if (emailCell) emailCell.textContent = email;
                    if (compCell) compCell.textContent = companyName;

                    const editBtn = row.querySelector('.btn-icon-edit');
                    if (editBtn) {
                        editBtn.dataset.name = name;
                        editBtn.dataset.email = email;
                        editBtn.dataset.company = companyId;
                    }

                    // Move row to correct group if company changed
                    if (oldCompanyName !== companyName) {
                        row.dataset.companyName = companyName;
                        const tbody = document.querySelector('#managersTable tbody');

                        // Find or create group header for new company
                        let groupHeader = tbody.querySelector(`tr.group-header[data-group-name="${companyName}"]`);
                        if (!groupHeader) {
                            const headerHtml = `
                                <tr class="group-header" data-group-name="${companyName}">
                                    <td colspan="4"><i class="ph-bold ph-buildings"></i> ${companyName}</td>
                                </tr>
                            `;
                            // Find where to insert alphabetically
                            const allHeaders = tbody.querySelectorAll('tr.group-header');
                            let insertBefore = null;
                            for (const header of allHeaders) {
                                if (header.dataset.groupName > companyName) {
                                    insertBefore = header;
                                    break;
                                }
                            }
                            if (insertBefore) {
                                insertBefore.insertAdjacentHTML('beforebegin', headerHtml);
                            } else {
                                tbody.insertAdjacentHTML('beforeend', headerHtml);
                            }
                            groupHeader = tbody.querySelector(`tr.group-header[data-group-name="${companyName}"]`);
                        }

                        // Move row after the last row of its new company group (or after header)
                        const companyRows = tbody.querySelectorAll(`tr[data-company-name="${companyName}"]:not(.group-header)`);
                        if (companyRows.length > 0) {
                            companyRows[companyRows.length - 1].insertAdjacentElement('afterend', row);
                        } else {
                            groupHeader.insertAdjacentElement('afterend', row);
                        }

                        // Check if old company group is now empty, remove header if so
                        const oldCompanyRows = tbody.querySelectorAll(`tr[data-company-name="${oldCompanyName}"]:not(.group-header)`);
                        if (oldCompanyRows.length === 0) {
                            const oldHeader = tbody.querySelector(`tr.group-header[data-group-name="${oldCompanyName}"]`);
                            if (oldHeader) oldHeader.remove();
                        }
                    }
                }
            } else {
                showToast(data.error || 'Erro ao atualizar', 'error');
            }
        } catch (err) {
            console.error(err);
            showToast('Erro de conex√£o: ' + err.message, 'error');
        } finally {
            if (btn) { btn.disabled = false; btn.innerHTML = 'Atualizar'; }
        }
    }

    async function deleteManager(id, name) {
        if (!confirm(`Remover gestor "${name}"?`)) return;

        try {
            const res = await fetch(`/admin/manager/${id}/delete`, {
                method: 'POST',
                headers: { 'Accept': 'application/json', 'X-CSRFToken': getCsrfToken() }
            });

            // Handle session expiration (401)
            if (res.status === 401) {
                const errorData = await res.json();
                showToast('Sess√£o expirada. Redirecionando para login...', 'error');
                setTimeout(() => window.location.href = errorData.redirect || '/auth/login', 1500);
                return;
            }

            const data = await res.json();

            if (res.ok) {
                showToast(data.message || 'Gestor removido!', 'success');
                const row = document.getElementById(`row-manager-${id}`);
                if (row) {
                    const companyName = row.dataset.companyName;
                    row.style.background = '#fee2e2';
                    setTimeout(function() {
                        row.remove();
                        var tbody = document.querySelector('#managersTable tbody');
                        var remainingRows = tbody.querySelectorAll('tr[data-company-name="' + companyName + '"]:not(.group-header)');
                        if (remainingRows.length === 0) {
                            var header = tbody.querySelector('tr.group-header[data-group-name="' + companyName + '"]');
                            if (header) header.remove();
                        }
                        if (managersPaginator) managersPaginator.refresh();
                    }, 500);
                }
            } else {
                showToast(data.error || 'Erro ao remover', 'error');
            }
        } catch (err) {
            console.error(err);
            showToast('Erro de conex√£o: ' + err.message, 'error');
        }
    }
</script>
{% endblock %}