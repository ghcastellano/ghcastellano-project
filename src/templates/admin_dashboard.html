{% extends "layout.html" %}

{% block title %}Admin Panel | InspetorAI{% endblock %}

{% block content %}

<div class="admin-wrapper">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
        <h3
            style="margin-bottom: 2rem; font-size: 1.1rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
            <i class="ph-fill ph-shield-check" style="color: var(--accent-color);"></i>
            Modera√ß√£o
        </h3>

        <div class="sidebar-header">Principal</div>
        <ul class="sidebar-menu">
            <li class="sidebar-item active" id="menu-overview" onclick="showSection('overview', this)">
                <div class="sidebar-dot"></div> Vis√£o Geral
            </li>
            <li class="sidebar-item" id="menu-companies" onclick="showSection('companies', this)">
                <div class="sidebar-dot"></div> Empresas (Tenants)
            </li>
            <li class="sidebar-item" id="menu-managers" onclick="showSection('managers', this)">
                <div class="sidebar-dot"></div> Acessos & Gestores
            </li>
        </ul>

        <div class="sidebar-header">T√©cnico</div>
        <ul class="sidebar-menu">
            <li class="sidebar-item" id="menu-monitoring" onclick="showSection('monitoring', this)">
                <div class="sidebar-dot"></div> Monitoramento Jobs
            </li>
            <li class="sidebar-item" id="menu-system" onclick="showSection('system', this)">
                <div class="sidebar-dot"></div> Logs & Sistema
            </li>
        </ul>

        <!-- Info Box -->
        <div
            style="margin-top: auto; padding: 1rem; background: rgba(239, 246, 255, 0.6); border-radius: 12px; border: 1px solid rgba(219, 234, 254, 0.6); font-size: 0.8rem; color: #1e40af;">
            <i class="ph-bold ph-info"></i> Painel de Super Admin. Use com cautela. A√ß√µes aqui afetam toda a plataforma.
        </div>
    </aside>

    <!-- Main Content -->
    <div class="admin-main">
        <div class="content-wrapper">
            <!-- 1. Overview Section -->
            <div id="overview" class="section-view active">
                <!-- Modern Header -->
                <div style="margin-bottom: 2.5rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <span
                                style="font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: var(--accent-color); letter-spacing: 0.05em; display: block; margin-bottom: 0.25rem;">Painel
                                Administrativo</span>
                            <h1
                                style="font-size: 2.5rem; font-weight: 700; color: var(--text-primary); letter-spacing: -0.02em; margin: 0;">
                                Ol√°, {{ current_user.name.split()[0] }} <span
                                    style="animation: wave 2s infinite; display: inline-block; transform-origin: 70% 70%;">üëã</span>
                            </h1>
                        </div>
                    </div>
                    <!-- <p class="text-muted">Vis√£o geral do sistema.</p> -->
                </div>

                <style>
                    @keyframes wave {
                        0% {
                            transform: rotate(0.0deg)
                        }

                        10% {
                            transform: rotate(14.0deg)
                        }

                        20% {
                            transform: rotate(-8.0deg)
                        }

                        30% {
                            transform: rotate(14.0deg)
                        }

                        40% {
                            transform: rotate(-4.0deg)
                        }

                        50% {
                            transform: rotate(10.0deg)
                        }

                        60% {
                            transform: rotate(0.0deg)
                        }

                        100% {
                            transform: rotate(0.0deg)
                        }
                    }
                </style>
                <div class="stats-grid">
                    <div class="stat-card" onclick="document.getElementById('menu-companies').click()">
                        <span class="stat-label">Empresas</span>
                        <span class="stat-value" id="stat-companies-count">{{ companies|length if companies else 0
                            }}</span>
                        <div class="stat-trend trend-up"><i class="ph-bold ph-caret-right"></i> Gerenciar</div>
                    </div>
                    <div class="stat-card" onclick="document.getElementById('menu-managers').click()">
                        <span class="stat-label">Gestores</span>
                        <span class="stat-value">{{ managers|length if managers else 0 }}</span>
                        <div class="stat-trend trend-up"><i class="ph-bold ph-caret-right"></i> Gerenciar</div>
                    </div>
                    <div class="stat-card" onclick="document.getElementById('menu-monitoring').click()">
                        <span class="stat-label">Monitoramento</span>
                        <span class="stat-value"><i class="ph-bold ph-activity"></i></span>
                        <div class="stat-trend trend-neutral">Ver Status</div>
                    </div>
                </div>

                <div class="card" style="margin-top: 2rem;">
                    <div class="card-header">
                        <h3 class="card-title">Atividade Recente</h3>
                    </div>
                    <div class="card-body" style="color: var(--text-secondary);">
                        <p>O sistema est√° operando normalmente. (Cloud Run Rev 119)</p>
                    </div>
                </div>
            </div> <!-- End of Overview -->

            <!-- 2. Companies Section -->
            <div id="companies" class="section-view">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                    <h1 style="font-size: 1.8rem; margin: 0;">Empresas</h1>
                    <button class="btn btn-primary" onclick="toggleCreateCompany()">
                        <i class="ph-bold ph-plus"></i> Nova Empresa
                    </button>
                </div>

                <!-- Create Form (Hidden) -->
                <div class="card" id="createCompanyCard" style="margin-bottom: 2rem; display: none;">
                    <div class="card-body">
                        <form id="createCompanyForm" onsubmit="handleCreateCompany(event)">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <!-- Simplified Form Content, handled by JS normally -->
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end;">
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label">Nome</label>
                                    <input type="text" name="name" class="form-control" placeholder="Ex: Mercado X"
                                        required>
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label">CNPJ</label>
                                    <input type="text" name="cnpj" class="form-control"
                                        placeholder="00.000.000/0000-00">
                                </div>
                                <button type="submit" class="btn btn-accent" id="btnCreateCompany">Criar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Edit Form (Hidden) -->
                <div class="card" id="editCompanyCard"
                    style="margin-bottom: 2rem; display: none; border: 1px solid #3b82f6;">
                    <div class="card-header" style="background:none; padding-bottom:0;">
                        <h4 style="margin:0; color:#1e40af;">Editar Empresa</h4>
                    </div>
                    <div class="card-body">
                        <form id="editCompanyForm" onsubmit="handleUpdateCompany(event)">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <input type="hidden" name="company_id" id="edit_company_id">
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end;">
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label">Nome</label>
                                    <input type="text" name="name" id="edit_company_name" class="form-control" required>
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label">CNPJ</label>
                                    <input type="text" name="cnpj" id="edit_company_cnpj" class="form-control">
                                </div>
                                <div style="display:flex; gap:0.5rem;">
                                    <button type="button" class="btn btn-secondary"
                                        onclick="document.getElementById('editCompanyCard').style.display='none'">Cancelar</button>
                                    <button type="submit" class="btn btn-primary" id="btnUpdateCompany">Salvar</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table class="modern-table" id="companiesTable">
                            <thead>
                                <tr>
                                    <th>Empresa</th>
                                    <th>CNPJ</th>
                                    <th>Status</th>
                                    <th class="text-right">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for company in companies %}
                                <tr id="row-company-{{ company.id }}">
                                    <td style="font-weight: 600;" class="col-name">{{ company.name }}</td>
                                    <td class="text-sm text-muted col-cnpj">{{ company.cnpj or '--' }}</td>
                                    <td><span class="badge badge-success">Ativo</span></td>
                                    <td class="text-right">
                                        <div class="btn-icon-group">
                                            <button class="btn-icon btn-icon-edit" data-id="{{ company.id }}"
                                                data-name="{{ company.name }}" data-cnpj="{{ company.cnpj or '' }}"
                                                onclick="openEditCompany(this.dataset.id, this.dataset.name, this.dataset.cnpj)"
                                                title="Editar">
                                                <i class="ph-bold ph-pencil-simple"></i>
                                            </button>
                                            <button class="btn-icon btn-icon-delete"
                                                onclick="deleteCompany('{{ company.id }}', '{{ company.name }}')"
                                                title="Excluir">
                                                <i class="ph-bold ph-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 3. Managers Section -->
            <div id="managers" class="section-view">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                    <h1 style="font-size: 1.8rem; margin: 0;">Gestores</h1>
                    <button class="btn btn-primary" onclick="toggleCreateManager()">
                        <i class="ph-bold ph-plus"></i> Novo Gestor
                    </button>
                </div>

                <!-- Create Form (Hidden) -->
                <div class="card" id="createManagerCard" style="margin-bottom: 2rem; display: none;">
                    <!-- Standard Create Form -->
                    <div class="card-body">
                        <form id="createManagerForm" onsubmit="handleCreateManager(event)">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <!-- Content simplified -->
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end;">
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label">Nome</label>
                                    <input type="text" name="name" class="form-control" required>
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label">Email</label>
                                    <input type="email" name="email" class="form-control" required>
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label">Empresa</label>
                                    <select name="company_id" class="form-control" required>
                                        {% for c in companies %}
                                        <option value="{{ c.id }}">{{ c.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-accent" id="btnCreateManager">Salvar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Edit Form (Hidden) -->
                <div class="card" id="editManagerCard"
                    style="margin-bottom: 2rem; display: none; border: 1px solid #3b82f6;">
                    <div class="card-header" style="background:none; padding-bottom:0;">
                        <h4 style="margin:0; color:#1e40af;">Editar Gestor</h4>
                    </div>
                    <div class="card-body">
                        <form id="editManagerForm" onsubmit="handleUpdateManager(event)">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <input type="hidden" name="user_id" id="edit_manager_id">
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end;">
                                <div class="form-group">
                                    <label class="form-label">Nome</label>
                                    <input type="text" name="name" id="edit_manager_name" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="email" name="email" id="edit_manager_email" class="form-control"
                                        required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Empresa</label>
                                    <select name="company_id" id="edit_manager_company" class="form-control" required>
                                        {% for c in companies %}
                                        <option value="{{ c.id }}">{{ c.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Nova Senha (Opcional)</label>
                                    <input type="password" name="password" class="form-control"
                                        placeholder="Deixar em branco to keep">
                                </div>
                            </div>
                            <div style="margin-top: 1rem; text-align: right;">
                                <button type="button" class="btn btn-secondary"
                                    onclick="document.getElementById('editManagerCard').style.display='none'">Cancelar</button>
                                <button type="submit" class="btn btn-primary" id="btnUpdateManager">Atualizar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table class="modern-table" id="managersTable">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Email</th>
                                    <th>Empresa Vinculada</th>
                                    <th class="text-right">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set ns = namespace(last_company=None) %}
                                {% for manager in managers %}
                                {% set comp_name = manager.company.name if manager.company else "Sem Empresa/Admin" %}
                                {% if ns.last_company != comp_name %}
                                <tr class="group-header" data-group-name="{{ comp_name }}">
                                    <td colspan="4"><i class="ph-bold ph-buildings"></i> {{ comp_name }}</td>
                                </tr>
                                {% set ns.last_company = comp_name %}
                                {% endif %}

                                <tr id="row-manager-{{ manager.id }}" data-company-name="{{ comp_name }}">
                                    <td style="font-weight: 500; padding-left: 2rem;" class="col-name">{{ manager.name
                                        }}</td>
                                    <td class="text-sm text-muted col-email">{{ manager.email }}</td>
                                    <td>
                                        {% if manager.company %}
                                        <span class="badge badge-blue col-comp">{{ manager.company.name }}</span>
                                        {% else %}
                                        <span class="badge badge-warning col-comp">Super Admin</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-right">
                                        <div class="btn-icon-group">
                                            <button class="btn-icon btn-icon-edit" data-id="{{ manager.id }}"
                                                data-name="{{ manager.name }}" data-email="{{ manager.email }}"
                                                data-company="{{ manager.company_id or '' }}"
                                                onclick="openEditManager(this.dataset.id, this.dataset.name, this.dataset.email, this.dataset.company)"
                                                title="Editar">
                                                <i class="ph-bold ph-pencil-simple"></i>
                                            </button>
                                            <button class="btn-icon btn-icon-delete"
                                                onclick="deleteManager('{{ manager.id }}', '{{ manager.name }}')"
                                                title="Excluir">
                                                <i class="ph-bold ph-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 4. Monitoring Section -->
            <div id="monitoring" class="section-view">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap;">
                    <h1 style="font-size: 1.8rem; margin: 0;">Monitoramento de Jobs</h1>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Fila de Processamento Global</h3>
                        <button onclick="updateMonitoring()" class="btn btn-secondary"
                            style="padding: 0.25rem 0.5rem;"><i class="ph-bold ph-arrows-clockwise"></i></button>
                    </div>
                    <!-- Table (Same as before) -->
                    <div class="table-container">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Tipo</th>
                                    <th>Empresa</th>
                                    <th>Arquivo / Est.</th>
                                    <th>Status</th>
                                    <th>Tokens (In/Out)</th>
                                    <th>Custo Real</th>
                                    <th>Dura√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="monitoring-tbody">
                                <tr>
                                    <td colspan="8" class="text-center text-muted">Carregando dados globais...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 5. System Logs -->
            <div id="system" class="section-view">
                <!-- Same as before -->
                <h1 style="font-size: 1.8rem; margin-bottom: 2rem;">Logs do Sistema</h1>
                <div class="card">
                    <div class="card-body">
                        <p>Log Stream dispon√≠vel no Google Cloud Console.</p>
                        <a href="https://console.cloud.google.com/run" target="_blank" class="btn btn-secondary">Abrir
                            Cloud
                            Console</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Functions -->
<script>
    // ... [Existing Functions] ...

    // Monitoring
    async function updateMonitoring() {
        const tbody = document.getElementById('monitoring-tbody');
        try {
            const res = await fetch('/admin/api/monitor', { headers: { 'Accept': 'application/json' } });
            if (res.ok) {
                const data = await res.json();
                if (data.items && data.items.length > 0) {
                    tbody.innerHTML = data.items.map(item => `
                       <tr style="animation: fadeIn 0.5s">
                           <td>
                                <span title="${item.id}" style="font-family: monospace; font-size: 0.8em; color: var(--text-muted); cursor: help;">
                                    ${item.id.substring(0, 8)}...
                                </span>
                           </td>
                           <td style="font-size: 0.85em;">
                                <span class="badge badge-secondary">${item.type}</span>
                           </td>
                           <td style="font-size: 0.9em; font-weight: 500;">
                                ${item.company_name}
                           </td>
                           <td style="font-weight: 500; font-size: 0.9em;">
                                <div style="display:flex; flex-direction:column;">
                                    <span><i class="ph-file-pdf" style="color: #ef4444; margin-right: 4px;"></i> ${item.filename}</span>
                                    <span style="font-size:0.8em; color:#64748b;">${item.establishment}</span>
                                </div>
                           </td>
                            <td>
                                <span class="badge badge-${getStatusColor(item.status)}" style="cursor: pointer;" onclick="openTracker('${item.id}')" title="Ver Erros/Logs">${translate(item.status)}</span>
                                ${item.status === 'FAILED' ? '<div style="font-size:0.7em; color:red; max-width:150px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">' + (item.error_log || '') + '</div>' : ''}
                            </td>
                            <td class="text-sm">
                                <div style="color: #475569;" title="Entrada / Sa√≠da">
                                    <span style="color:#2563eb;">${(item.tokens_input || 0).toLocaleString()}</span> / 
                                    <span style="color:#16a34a;">${(item.tokens_output || 0).toLocaleString()}</span>
                                </div>
                                <div style="font-size: 0.75em; color: #94a3b8;">Total: ${(item.tokens_total || 0).toLocaleString()}</div>
                            </td>
                            <td class="text-sm">
                                <div style="font-weight: 600; color: #475569;">R$ ${(item.cost_brl || 0).toFixed(4)}</div>
                                <div style="font-size: 0.8em; color: #64748b;">$ ${(item.cost_usd || 0).toFixed(4)}</div>
                            </td>
                            <td class="text-sm text-muted">${item.duration ? item.duration + 's' : '-'}</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">Nenhum job recente encontrado.</td></tr>`;
                }
            } else {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">Erro ao carregar monitoramento.</td></tr>`;
            }
        } catch (err) {
            console.error(err);
            tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">Erro de conex√£o: ${err.message}</td></tr>`;
        }
    }

    const TRANSLATIONS = {
        'APPROVED': 'APROVADO',
        'WAITING_APPROVAL': 'AGUARDANDO APROVA√á√ÉO',
        'PENDING_MANAGER_REVIEW': 'PENDENTE REVIS√ÉO',
        'PROCESSING': 'PROCESSANDO',
        'COMPLETED': 'CONCLU√çDO',
        'REJECTED': 'REJEITADO',
        'FAILED': 'FALHA',
        'PENDING_VERIFICATION': 'EM VERIFICA√á√ÉO',
        'upload': 'Upload',
        'ai_process': 'Processamento IA',
        'db_save': 'Salvando DB',
        'plan_gen': 'Gerando Plano',
        'analysis': 'An√°lise',
        'manager_review': 'Revis√£o Gestor',
        'consultant_check': 'Visita Consultor',
        'finished': 'Finalizado'
    };

    function translate(text) {
        if (!text) return '';
        const upper = text.toUpperCase();
        return TRANSLATIONS[text] || TRANSLATIONS[upper] || text.replace(/_/g, ' ');
    }

    function getStatusColor(status) {
        if (status === 'COMPLETED' || status === 'APPROVED') return 'success';
        if (status === 'PROCESSING') return 'primary';
        if (status === 'REJECTED' || status === 'FAILED') return 'danger';
        if (status === 'PENDING_MANAGER_REVIEW' || status === 'WAITING_APPROVAL') return 'warning';
        if (status === 'PENDING_VERIFICATION') return 'info';
        return 'secondary';
    }

    function renderLogsPreview(logs) {
        if (!logs || logs.length === 0) return '';
        // Small dots for last 3 steps
        const last3 = logs.slice(-3);
        return `<div style="display:flex; gap:2px; margin-top:2px;">
    ${last3.map(l => {
            let color = '#cbd5e1';
            if (l.status == 'SUCCESS') color = '#34d399';
            if (l.status == 'FAILED') color = '#f87171';
            return `<div style="width:6px; height:6px; borderRadius:50%; background:${color};" title="${l.stage}"></div>`
        }).join('')}
</div>`;
    }


</script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script>
    $(document).ready(function () {
        // Mask for CNPJ
        $('input[name="cnpj"]').mask('00.000.000/0000-00', { reverse: true });

        // Mask for Phone (Generic 10 or 11 digits)
        var behavior = function (val) {
            return val.replace(/\D/g, '').length === 11 ? '(00) 00000-0000' : '(00) 0000-00009';
        },
            options = {
                onKeyPress: function (val, e, field, options) {
                    field.mask(behavior.apply({}, arguments), options);
                }
            };
        $('input[name="phone"]').mask(behavior, options);

        // Re-apply mask when modal is opened or dynamic content added?
        // jQuery Mask plugin usually attaches to selector, so dynamic elements might need re-init
        // But here inputs are static in the modal.
    });
</script>
<style>
    .spin-anim {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        100 % {
            transform: rotate(360deg);
        }
    }

    .btn-delete-icon {
        background: #fee2e2;
        color: #ef4444;
        border: none;
        padding: 0.5rem;
        border-radius: 6px;
        cursor: pointer;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
<!-- TRACKER MODAL (Admin) -->
<div id="trackerModal" class="modal-overlay"
    style="display: none; z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
    <div class="modal-content glass-panel" style="max-width: 600px; width: 90%; position: relative; padding: 2rem;">
        <button onclick="document.getElementById('trackerModal').style.display='none'"
            style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748B;">&times;</button>

        <div style="text-align: center; margin-bottom: 2rem;">
            <h3 style="margin:0; color: #1e293b; font-weight: 700;">Status do Processamento</h3>
            <p id="trackerFile" style="color: #64748b; font-size: 0.9rem; margin-top: 0.5rem;">Carregando...</p>
        </div>

        <!-- Stepper -->
        <div class="tracker-stepper"
            style="display: flex; justify-content: space-between; position: relative; margin-bottom: 2rem;">
            <!-- Line -->
            <div
                style="position: absolute; top: 15px; left: 0; right: 0; height: 3px; background: #e2e8f0; z-index: 0;">
            </div>
            <div id="trackerProgressLine"
                style="position: absolute; top: 15px; left: 0; width: 0%; height: 3px; background: #10b981; z-index: 0; transition: width 0.5s;">
            </div>

            <!-- Steps (Generated via JS) -->
            <div class="step-item" style="z-index: 1; text-align: center; background: white; padding: 0 5px;">
                <div class="step-circle"
                    style="width: 32px; height: 32px; background: #10b981; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; font-weight: bold;">
                    1</div>
                <div class="step-label" style="font-size: 0.8rem; margin-top: 5px; color: #10b981;">Upload</div>
            </div>
            <!-- More steps... -->
        </div>

        <div id="trackerLogs"
            style="background: #f8fafc; padding: 1rem; border-radius: 8px; font-family: monospace; font-size: 0.8rem; color: #475569; max-height: 150px; overflow-y: auto;">
            <div style="color: #94a3b8;">Aguardando detalhes...</div>
        </div>

        <div style="text-align: center; margin-top: 2rem;">
            <button onclick="document.getElementById('trackerModal').style.display='none'" class="btn btn-primary"
                style="padding: 0.5rem 2rem;">Fechar</button>
        </div>
    </div>
</div>

<script>
    async function openTracker(inspId) {
        const modal = document.getElementById('trackerModal');
        const titleEl = document.getElementById('trackerFile');
        const logsEl = document.getElementById('trackerLogs');
        const stepperEl = document.querySelector('.tracker-stepper');

        modal.style.display = 'flex';
        titleEl.innerText = "Buscando informa√ß√µes...";
        logsEl.innerHTML = '<div style="color: #94a3b8;">Carregando...</div>';

        try {
            const res = await fetch(`/ admin / api / tracker / ${inspId}`);
            const data = await res.json();

            if (data.error) {
                titleEl.innerText = "Erro ao carregar";
                logsEl.innerHTML = `< div style = "color: red;" > ${data.error}</div > `;
                return;
            }

            titleEl.innerText = data.filename;

            // Render Logs
            if (data.logs && data.logs.length > 0) {
                logsEl.innerHTML = data.logs.map(l => `< div >‚Ä¢ ${l}</div > `).join('');
            } else {
                logsEl.innerHTML = '<div style="color: #94a3b8;">Nenhum log recente.</div>';
            }

            // Render Steps
            // Order: upload, ai_process, db_save, plan_gen, analysis
            const order = ['upload', 'ai_process', 'db_save', 'plan_gen', 'analysis'];
            let html = '';
            let activeCount = 0; // For progress line

            // Background Line
            html += '<div style="position: absolute; top: 15px; left: 10px; right: 10px; height: 3px; background: #e2e8f0; z-index: 0;"></div>';

            order.forEach((key, idx) => {
                const s = data.steps[key];
                let color = '#e2e8f0'; // Gray
                let icon = idx + 1;
                let labelColor = '#94a3b8';

                if (s.status === 'completed') {
                    color = '#10b981'; // Green
                    icon = '‚úì';
                    labelColor = '#059669';
                    activeCount = idx;
                } else if (s.status === 'current') {
                    color = '#3b82f6'; // Blue
                    icon = '<i class="ph-bold ph-spinner ph-spin"></i>';
                    labelColor = '#1e40af';
                    activeCount = idx; // Partial?
                } else if (s.status === 'error') {
                    color = '#ef4444'; // Red
                    icon = '!';
                    labelColor = '#dc2626';
                }

                html += `
                    < div class= "step-item" style = "z-index: 1; text-align: center; flex:1; position: relative;" >
                <div class="step-circle" style="width: 32px; height: 32px; background: ${color}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    ${icon}
                </div>
                <div class="step-label" style="font-size: 0.75rem; margin-top: 8px; font-weight: 600; color: ${labelColor};">
                    ${s.label}
                </div>
            </div > `;
            });

            // Progress Line
            const progressPct = (activeCount / (order.length - 1)) * 100;
            html += `< div style = "position: absolute; top: 15px; left: 10px; width: ${progressPct}%; height: 3px; background: #10b981; z-index: 0; transition: width 0.5s;" ></div >`;

            stepperEl.innerHTML = html;

        } catch (e) {
            console.error(e);
            titleEl.innerText = "Erro de conex√£o";
        }
    }
</script>
{% endblock %}