{% extends "layout.html" %}

{% block title %}Admin Panel | InspetorAI{% endblock %}

{% block content %}

<div class="admin-wrapper">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
        <h3
            style="margin-bottom: 2rem; font-size: 1.1rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
            <i class="ph-fill ph-shield-check" style="color: var(--accent-color);"></i>
            Modera√ß√£o
        </h3>

        <div class="sidebar-header">Principal</div>
        <ul class="sidebar-menu">
            <li class="sidebar-item active" id="menu-overview" onclick="showSection('overview', this)">
                <div class="sidebar-dot"></div> Vis√£o Geral
            </li>
            <li class="sidebar-item" id="menu-companies" onclick="showSection('companies', this)">
                <div class="sidebar-dot"></div> Empresas (Tenants)
            </li>
            <li class="sidebar-item" id="menu-managers" onclick="showSection('managers', this)">
                <div class="sidebar-dot"></div> Acessos & Gestores
            </li>
        </ul>

        <div class="sidebar-header">T√©cnico</div>
        <ul class="sidebar-menu">
            <li class="sidebar-item" id="menu-monitoring" onclick="showSection('monitoring', this)">
                <div class="sidebar-dot"></div> Monitoramento Jobs
            </li>
            <li class="sidebar-item" id="menu-system" onclick="showSection('system', this)">
                <div class="sidebar-dot"></div> Logs & Sistema
            </li>
        </ul>

        <!-- Info Box -->
        <div
            style="margin-top: auto; padding: 1rem; background: rgba(239, 246, 255, 0.6); border-radius: 12px; border: 1px solid rgba(219, 234, 254, 0.6); font-size: 0.8rem; color: #1e40af;">
            <i class="ph-bold ph-info"></i> Painel de Super Admin. Use com cautela. A√ß√µes aqui afetam toda a plataforma.
        </div>
    </aside>

    <!-- Main Content -->
    <div class="admin-main">
        <div class="content-wrapper">
            <!-- 1. Overview Section -->
            <div id="overview" class="section-view active">
                <!-- Modern Header -->
                <div style="margin-bottom: 2.5rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <div>
                            <span
                                style="font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: var(--accent-color); letter-spacing: 0.05em; display: block; margin-bottom: 0.25rem;">Painel
                                Administrativo</span>
                            <h1
                                style="font-size: 2.5rem; font-weight: 700; color: var(--text-primary); letter-spacing: -0.02em; margin: 0;">
                                Ol√°, {{ current_user.name.split()[0] }} <span
                                    style="animation: wave 2s infinite; display: inline-block; transform-origin: 70% 70%;">üëã</span>
                            </h1>
                        </div>
                        <div style="text-align: right;">
                            <div
                                style="background: white; padding: 0.5rem 1rem; border-radius: 50px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; font-weight: 500; color: var(--text-secondary); border: 1px solid rgba(0,0,0,0.02);">
                                <i class="ph-fill ph-calendar-blank" style="color: var(--accent-color);"></i>
                                <span style="text-transform: capitalize;">
                                    <script>document.write(new Date().toLocaleDateString('pt-BR', { weekday: 'short', day: 'numeric', month: 'long' }))</script>
                                </span>
                            </div>
                        </div>
                    </div>
                    <!-- <p class="text-muted">Vis√£o geral do sistema.</p> -->
                </div>

                <style>
                    @keyframes wave {
                        0% {
                            transform: rotate(0.0deg)
                        }

                        10% {
                            transform: rotate(14.0deg)
                        }

                        20% {
                            transform: rotate(-8.0deg)
                        }

                        30% {
                            transform: rotate(14.0deg)
                        }

                        40% {
                            transform: rotate(-4.0deg)
                        }

                        50% {
                            transform: rotate(10.0deg)
                        }

                        60% {
                            transform: rotate(0.0deg)
                        }

                        100% {
                            transform: rotate(0.0deg)
                        }
                    }
                </style>
                <div class="stats-grid">
                    <div class="stat-card" onclick="document.getElementById('menu-companies').click()">
                        <span class="stat-label">Empresas</span>
                        <span class="stat-value" id="stat-companies-count">{{ companies|length if companies else 0
                            }}</span>
                        <div class="stat-trend trend-up"><i class="ph-bold ph-caret-right"></i> Gerenciar</div>
                    </div>
                    <div class="stat-card" onclick="document.getElementById('menu-managers').click()">
                        <span class="stat-label">Gestores</span>
                        <span class="stat-value">{{ managers|length if managers else 0 }}</span>
                        <div class="stat-trend trend-up"><i class="ph-bold ph-caret-right"></i> Gerenciar</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--success-color);"
                        onclick="document.getElementById('menu-monitoring').click()">
                        <span class="stat-label" style="color: var(--success-color);">Jobs Recentes</span>
                        <span class="stat-value" style="color: var(--success-color);" id="stat-jobs-24h">-</span>
                        <div class="stat-trend" style="color: var(--success-color);"><i class="ph-bold ph-activity"></i>
                            Ver Monitoramento</div>
                    </div>
                </div>

                <div class="card" style="margin-top: 2rem;">
                    <div class="card-header">
                        <h3 class="card-title">Atividade Recente</h3>
                    </div>
                    <div class="card-body" style="color: var(--text-secondary);">
                        <p>O sistema est√° operando normalmente. (Cloud Run Rev 119)</p>
                    </div>
                </div>
            </div>

            <!-- 2. Companies Section -->
            <div id="companies" class="section-view">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h1 style="font-size: 1.8rem; margin: 0;">Empresas</h1>
                    <button class="btn btn-primary" onclick="toggleCreateCompany()">
                        <i class="ph-bold ph-plus"></i> Nova Empresa
                    </button>
                </div>

                <!-- Create Form (Hidden) -->
                <div class="card" id="createCompanyCard" style="margin-bottom: 2rem; display: none;">
                    <div class="card-body">
                        <form id="createCompanyForm" onsubmit="handleCreateCompany(event)">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <!-- Simplified Form Content, handled by JS normally -->
                            <div
                                style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: end;">
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label">Nome</label>
                                    <input type="text" name="name" class="form-control" placeholder="Ex: Mercado X"
                                        required>
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label">CNPJ</label>
                                    <input type="text" name="cnpj" class="form-control"
                                        placeholder="00.000.000/0000-00">
                                </div>
                                <button type="submit" class="btn btn-accent" id="btnCreateCompany">Criar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Edit Form (Hidden) -->
                <div class="card" id="editCompanyCard"
                    style="margin-bottom: 2rem; display: none; border: 1px solid #3b82f6;">
                    <div class="card-header" style="background:none; padding-bottom:0;">
                        <h4 style="margin:0; color:#1e40af;">Editar Empresa</h4>
                    </div>
                    <div class="card-body">
                        <form id="editCompanyForm" onsubmit="handleUpdateCompany(event)">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <input type="hidden" name="company_id" id="edit_company_id">
                            <div
                                style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: end;">
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label">Nome</label>
                                    <input type="text" name="name" id="edit_company_name" class="form-control" required>
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label">CNPJ</label>
                                    <input type="text" name="cnpj" id="edit_company_cnpj" class="form-control">
                                </div>
                                <div style="display:flex; gap:0.5rem;">
                                    <button type="button" class="btn btn-secondary"
                                        onclick="document.getElementById('editCompanyCard').style.display='none'">Cancelar</button>
                                    <button type="submit" class="btn btn-primary" id="btnUpdateCompany">Salvar</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table class="modern-table" id="companiesTable">
                            <thead>
                                <tr>
                                    <th>Empresa</th>
                                    <th>CNPJ</th>
                                    <th>Status</th>
                                    <th class="text-right">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for company in companies %}
                                <tr id="row-company-{{ company.id }}">
                                    <td style="font-weight: 600;">{{ company.name }}</td>
                                    <td class="text-sm text-muted">{{ company.cnpj or '--' }}</td>
                                    <td><span class="badge badge-success">Ativo</span></td>
                                    <td class="text-right">
                                        <button class="btn-edit-icon" data-id="{{ company.id }}"
                                            data-name="{{ company.name }}" data-cnpj="{{ company.cnpj or '' }}"
                                            onclick="openEditCompany(this.dataset.id, this.dataset.name, this.dataset.cnpj)">
                                            <i class="ph-bold ph-pencil-simple"></i>
                                        </button>
                                        <button class="btn-delete-icon"
                                            onclick="deleteCompany('{{ company.id }}', '{{ company.name }}')">
                                            <i class="ph-bold ph-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 3. Managers Section -->
            <div id="managers" class="section-view">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h1 style="font-size: 1.8rem; margin: 0;">Gestores</h1>
                    <button class="btn btn-primary" onclick="toggleCreateManager()">
                        <i class="ph-bold ph-plus"></i> Novo Gestor
                    </button>
                </div>

                <!-- Create Form (Hidden) -->
                <div class="card" id="createManagerCard" style="margin-bottom: 2rem; display: none;">
                    <!-- Standard Create Form -->
                    <div class="card-body">
                        <form id="createManagerForm" onsubmit="handleCreateManager(event)">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <!-- Content simplified -->
                            <div
                                style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label">Nome</label>
                                    <input type="text" name="name" class="form-control" required>
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label">Email</label>
                                    <input type="email" name="email" class="form-control" required>
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label">Empresa</label>
                                    <select name="company_id" class="form-control" required>
                                        {% for c in companies %}
                                        <option value="{{ c.id }}">{{ c.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-accent" id="btnCreateManager">Salvar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Edit Form (Hidden) -->
                <div class="card" id="editManagerCard"
                    style="margin-bottom: 2rem; display: none; border: 1px solid #3b82f6;">
                    <div class="card-header" style="background:none; padding-bottom:0;">
                        <h4 style="margin:0; color:#1e40af;">Editar Gestor</h4>
                    </div>
                    <div class="card-body">
                        <form id="editManagerForm" onsubmit="handleUpdateManager(event)">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <input type="hidden" name="user_id" id="edit_manager_id">
                            <div
                                style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem; align-items: end;">
                                <div class="form-group">
                                    <label class="form-label">Nome</label>
                                    <input type="text" name="name" id="edit_manager_name" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="email" name="email" id="edit_manager_email" class="form-control"
                                        required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Empresa</label>
                                    <select name="company_id" id="edit_manager_company" class="form-control" required>
                                        {% for c in companies %}
                                        <option value="{{ c.id }}">{{ c.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Nova Senha (Opcional)</label>
                                    <input type="password" name="password" class="form-control"
                                        placeholder="Deixar em branco to keep">
                                </div>
                            </div>
                            <div style="margin-top: 1rem; text-align: right;">
                                <button type="button" class="btn btn-secondary"
                                    onclick="document.getElementById('editManagerCard').style.display='none'">Cancelar</button>
                                <button type="submit" class="btn btn-primary" id="btnUpdateManager">Atualizar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table class="modern-table" id="managersTable">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Email</th>
                                    <th>Empresa Vinculada</th>
                                    <th class="text-right">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set ns = namespace(last_company=None) %}
                                {% for manager in managers %}
                                {% set comp_name = manager.company.name if manager.company else "Sem Empresa/Admin" %}
                                {% if ns.last_company != comp_name %}
                                <tr class="group-header">
                                    <td colspan="4"><i class="ph-bold ph-buildings"></i> {{ comp_name }}</td>
                                </tr>
                                {% set ns.last_company = comp_name %}
                                {% endif %}

                                <tr>
                                    <td style="font-weight: 500; padding-left: 2rem;">{{ manager.name }}</td>
                                    <td class="text-sm text-muted">{{ manager.email }}</td>
                                    <td>
                                        {% if manager.company %}
                                        <span class="badge badge-blue">{{ manager.company.name }}</span>
                                        {% else %}
                                        <span class="badge badge-warning">Super Admin</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-right">
                                        <div class="btn-icon-group">
                                            <button class="btn-icon btn-icon-edit" data-id="{{ manager.id }}"
                                                data-name="{{ manager.name }}" data-email="{{ manager.email }}"
                                                data-company="{{ manager.company_id or '' }}"
                                                onclick="openEditManager(this.dataset.id, this.dataset.name, this.dataset.email, this.dataset.company)"
                                                title="Editar">
                                                <i class="ph-bold ph-pencil-simple"></i>
                                            </button>
                                            <button class="btn-icon btn-icon-delete"
                                                onclick="deleteManager('{{ manager.id }}', '{{ manager.name }}')"
                                                title="Excluir">
                                                <i class="ph-bold ph-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 4. Monitoring Section -->
            <div id="monitoring" class="section-view">
                <h1 style="font-size: 1.8rem; margin-bottom: 2rem;">Monitoramento de Jobs (Global)</h1>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Fila de Processamento</h3>
                        <button onclick="updateMonitoring()" class="btn btn-secondary"
                            style="padding: 0.25rem 0.5rem;"><i class="ph-bold ph-arrows-clockwise"></i></button>
                    </div>
                    <!-- Table (Same as before) -->
                    <div class="table-container">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Arquivo</th>
                                    <th>Estabelecimento</th>
                                    <th>Status</th>
                                    <th>Etapa</th>
                                    <th>Dura√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="monitoring-tbody">
                                <tr>
                                    <td colspan="6" class="text-center text-muted">Carregando dados globais...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 5. System Logs -->
            <div id="system" class="section-view">
                <!-- Same as before -->
                <h1 style="font-size: 1.8rem; margin-bottom: 2rem;">System Logs</h1>
                <div class="card">
                    <div class="card-body">
                        <p>Log Stream dispon√≠vel no Google Cloud Console.</p>
                        <a href="https://console.cloud.google.com/run" target="_blank" class="btn btn-secondary">Abrir
                            Cloud
                            Console</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Functions -->
<script>
    function showSection(sectionId, element) {
        document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
        if (element) element.classList.add('active');
        document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
        document.getElementById(sectionId).classList.add('active');
        if (sectionId === 'monitoring') { updateMonitoring(); }
    }

    function toggleCreateCompany() {
        const el = document.getElementById('createCompanyCard');
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
        document.getElementById('editCompanyCard').style.display = 'none';
    }

    function openEditCompany(id, name, cnpj) {
        document.getElementById('createCompanyCard').style.display = 'none';
        document.getElementById('editCompanyCard').style.display = 'block';
        document.getElementById('edit_company_id').value = id;
        document.getElementById('edit_company_name').value = name;
        document.getElementById('edit_company_cnpj').value = cnpj;
        window.scrollTo(0, 0);
    }

    // --- TOAST SYSTEM (Ported from Manager) ---
    function showToast(message, type = 'success') {
        const toastId = 'toast-' + Math.random().toString(36).substr(2, 9);
        const color = type === 'success' ? '#10b981' : '#ef4444';
        const bg = type === 'success' ? '#ecfdf5' : '#fef2f2';

        const html = `
            <div id="${toastId}" style="
                position: fixed; top: 20px; right: 20px; z-index: 9999;
                background: ${bg}; border-left: 4px solid ${color};
                padding: 1rem 1.5rem; border-radius: 6px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
                display: flex; align-items: center; gap: 12px;
                transform: translateX(100%); transition: transform 0.3s ease-out;
            ">
                <i class="ph-bold ${type === 'success' ? 'ph-check-circle' : 'ph-warning-circle'}" style="color: ${color}; font-size: 1.2rem;"></i>
                <div style="font-weight: 500; color: #1f2937;">${message}</div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', html);

        setTimeout(() => {
            const el = document.getElementById(toastId);
            if (el) el.style.transform = 'translateX(0)';
        }, 100);

        setTimeout(() => {
            const el = document.getElementById(toastId);
            if (el) {
                el.style.transform = 'translateX(120%)';
                setTimeout(() => el.remove(), 300);
            }
        }, 4000);
    }

    // --- AJAX DELETE ACTIONS ---
    async function deleteCompany(id, name) {
        if (!confirm(`ATEN√á√ÉO: Apagar ${name} remover√° TODOS os dados da empresa. Continuar?`)) return;
        try {
            const res = await fetch(`/admin/company/${id}/delete`, {
                method: 'POST',
                headers: { 'Accept': 'application/json', 'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value }
            });
            const data = await res.json();

            if (res.ok) {
                showToast('Empresa removida com sucesso', 'success');
                const row = document.getElementById(`row-company-${id}`);
                if (row) row.remove();
            } else {
                showToast(data.error || 'Erro ao remover', 'error');
            }
        } catch (err) { console.error(err); showToast('Erro de conex√£o', 'error'); }
    }

    async function deleteManager(id, name) {
        if (!confirm(`Remover acesso de ${name}?`)) return;
        try {
            const res = await fetch(`/admin/manager/${id}/delete`, {
                method: 'POST',
                headers: { 'Accept': 'application/json', 'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value }
            });
            const data = await res.json();

            if (res.ok) {
                showToast('Gestor removido com sucesso', 'success');
                // Remove row. Note: Managers might be in complex hierarchy, but simple row removal usually works visually.
                // If row is inside a group that becomes empty, it stays empty visually (acceptable).
                // Or we reload if we want perfection.
                // window.location.reload(); // Safer for managers list structure?
                // Users requested "fluid", so removing row is better.
                window.location.reload();
            } else {
                showToast(data.error || 'Erro ao remover', 'error');
            }
        } catch (err) { console.error(err); showToast('Erro de conex√£o', 'error'); }
    }

    // --- UPDATED HANDLERS ---
    async function handleCreateCompany(e) {
        e.preventDefault();
        const btn = document.getElementById('btnCreateCompany');
        btn.disabled = true; btn.innerHTML = 'Criando...';
        try {
            const formData = new FormData(e.target);
            const res = await fetch("{{ url_for('admin.create_company') }}", { method: 'POST', body: formData, headers: { 'Accept': 'application/json' } });
            const data = await res.json();
            if (res.ok) {
                showToast('Empresa criada!', 'success');
                setTimeout(() => window.location.reload(), 1000);
            } else { showToast(data.error || 'Erro', 'error'); }
        } catch (err) { showToast('Erro de conex√£o', 'error'); }
        finally { btn.disabled = false; btn.innerHTML = 'Criar'; }
    }

    async function handleUpdateCompany(e) {
        e.preventDefault();
        const btn = document.getElementById('btnUpdateCompany');
        btn.disabled = true; btn.innerHTML = 'Salvando...';
        try {
            const formData = new FormData(e.target);
            const id = document.getElementById('edit_company_id').value;
            const res = await fetch(`/admin/company/${id}/update`, { method: 'POST', body: formData, headers: { 'Accept': 'application/json' } });
            const data = await res.json();
            if (res.ok) {
                showToast('Atualizado!', 'success');
                setTimeout(() => window.location.reload(), 1000);
            } else { showToast(data.error || 'Erro', 'error'); }
        } catch (err) { showToast('Erro', 'error'); }
        finally { btn.disabled = false; btn.innerHTML = 'Salvar'; }
    }

    async function handleCreateManager(e) {
        e.preventDefault();
        const btn = document.getElementById('btnCreateManager');
        btn.disabled = true; btn.innerHTML = 'Criando...';
        try {
            const formData = new FormData(e.target);
            const res = await fetch("{{ url_for('admin.create_manager') }}", { method: 'POST', body: formData, headers: { 'Accept': 'application/json' } });
            const data = await res.json();
            if (res.ok) {
                showToast(data.message || 'Gestor criado!', 'success');
                setTimeout(() => window.location.reload(), 1500);
            } else { showToast(data.error || 'Erro', 'error'); }
        } catch (err) { showToast('Erro de conex√£o', 'error'); }
        finally { btn.disabled = false; btn.innerHTML = 'Salvar'; }
    }

    async function handleUpdateManager(e) {
        e.preventDefault();
        const btn = document.getElementById('btnUpdateManager');
        btn.disabled = true; btn.innerHTML = 'Salvando...';
        try {
            const formData = new FormData(e.target);
            const id = document.getElementById('edit_manager_id').value;
            const res = await fetch(`/admin/manager/${id}/update`, { method: 'POST', body: formData, headers: { 'Accept': 'application/json' } });
            const data = await res.json();
            if (res.ok) {
                showToast('Gestor atualizado!', 'success');
                setTimeout(() => window.location.reload(), 1000);
            } else { showToast(data.error || 'Erro', 'error'); }
        } catch (err) { showToast('Erro', 'error'); }
        finally { btn.disabled = false; btn.innerHTML = 'Atualizar'; }
    }

    // Monitoring
    async function updateMonitoring() {
        const tbody = document.getElementById('monitoring-tbody');
        try {
            const res = await fetch('/admin/api/monitor', { headers: { 'Accept': 'application/json' } });
            if (res.ok) {
                const data = await res.json();
                if (data.items && data.items.length > 0) {
                    tbody.innerHTML = data.items.map(item => `
                       <tr style="animation: fadeIn 0.5s">
                           <td>
                                <span title="${item.id}" style="font-family: monospace; font-size: 0.8em; color: var(--text-muted); cursor: help;">
                                    ${item.id.substring(0, 8)}...
                                </span>
                           </td>
                           <td style="font-weight: 500; font-size: 0.9em;">
                                <i class="ph-file-pdf" style="color: #ef4444; margin-right: 4px;"></i>
                                ${item.filename}
                           </td>
                           <td>
                                ${item.establishment !== 'Detectando...'
                            ? `<span class="badge badge-blue">${item.establishment}</span>`
                            : `<span class="badge badge-warning" style="opacity: 0.7;">Detectando...</span>`
                        }
                           </td>
                           <td>
                                <span class="badge badge-${getStatusColor(item.status)}">${item.status}</span>
                           </td>
                           <td style="font-size: 0.85em;">
                                <div style="font-weight: 600; color: var(--text-primary);">${item.stage}</div>
                                <div style="color: var(--text-muted); max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${item.message}">
                                    ${item.message}
                                </div>
                                ${renderLogsPreview(item.logs)}
                           </td>
                           <td class="text-sm text-muted">${item.duration ? item.duration + 's' : '-'}</td>
                       </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Nenhum log de inspe√ß√£o recente.</td></tr>`;
                }
            } else {
                const errData = await res.json();
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Erro ao carregar monitor: ${errData.error || res.statusText}</td></tr>`;
            }
        } catch (err) {
            console.error(err);
            tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Erro de conex√£o: ${err.message}</td></tr>`;
        }
    }

    function getStatusColor(status) {
        if (status === 'COMPLETED' || status === 'APPROVED') return 'success';
        if (status === 'PROCESSING') return 'primary';
        if (status === 'REJECTED' || status === 'FAILED') return 'danger';
        return 'secondary';
    }

    function toggleLogs(id) {
        const row = document.getElementById(`logs-${id}`);
        if (row) {
            row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
        }
    }

    function renderLogsDetail(logs) {
        if (!logs || logs.length === 0) return '<div class="text-muted p-2">Sem logs detalhados.</div>';
        return logs.map(l => {
            let color = 'text-muted';
            if (l.status === 'SUCCESS') color = 'text-success';
            if (l.status === 'FAILED') color = 'text-danger';
            if (l.status === 'RUNNING') color = 'text-primary';
            return `<div style="font-family:monospace; font-size:0.85em; padding: 2px 0;" class="${color}">
                [${l.timestamp.split('T')[1].split('.')[0]}] <b>${l.stage}:</b> ${l.message}
            </div>`;
        }).join('');
    }

    function renderLogsPreview(logs) {
        if (!logs || logs.length === 0) return '';
        // Small dots for last 3 steps
        const last3 = logs.slice(-3);
        return `<div style="display:flex; gap:2px; margin-top:2px;">
            ${last3.map(l => {
            let color = '#cbd5e1';
            if (l.status == 'SUCCESS') color = '#34d399';
            if (l.status == 'FAILED') color = '#f87171';
            return `<div style="width:6px; height:6px; borderRadius:50%; background:${color};" title="${l.stage}"></div>`
        }).join('')}
        </div>`;
    }
</script>
</div>`;
}).join('');
}

function renderLogsPreview(logs) {
// Optional: Draw a mini progress bar or dots
if (!logs || logs.length === 0) return '';
// 5 steps: INIT, DOWNLOAD, AI, PDF, DB
const count = logs.length;
// Simple visual indicator of depth
return `<div style="display: flex; gap: 2px; margin-top: 4px;">
    ${logs.map(l => {
    let color = '#e5e7eb';
    if (l.status === 'SUCCESS') color = '#22c55e';
    if (l.status === 'RUNNING') color = '#3b82f6';
    if (l.status === 'FAILED') color = '#ef4444';
    return `<div style="width: 6px; height: 6px; border-radius: 50%; background: ${color};"
        title="${l.stage}: ${l.message}"></div>`;
    }).join('')}
</div>`;
}

setInterval(() => {
if (document.getElementById('monitoring').classList.contains('active')) {
updateMonitoring();
}
}, 10000);
</script>
<style>
    .btn-delete-icon {
        background: #fee2e2;
        color: #ef4444;
        border: none;
        padding: 0.5rem;
        border-radius: 6px;
        cursor: pointer;
    }
</style>
{% endblock %}