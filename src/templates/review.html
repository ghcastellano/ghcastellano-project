{% extends "layout.html" %}

{% block title %}Verificação Técnica (Consultor){% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Process Status Stepper -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body py-3 px-4">
                    <div class="d-flex justify-content-between align-items-center position-relative">
                        <!-- Progress Line -->
                        <div class="position-absolute w-100"
                            style="top: 15px; left: 0; height: 2px; background: #e9ecef; z-index: 0;"></div>

                        <!-- Step 1: Gestor (Completed) -->
                        <div class="text-center position-relative bg-white px-2" style="z-index: 2;">
                            <div class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center mx-auto mb-2 shadow-sm"
                                style="width: 32px; height: 32px; font-weight: bold;"><i class="ph-bold ph-check"></i>
                            </div>
                            <span class="d-block text-xs font-weight-bold text-success text-uppercase"
                                style="font-size: 0.7rem;">Validação</span>
                        </div>

                        <!-- Step 2: Consultor (Active) -->
                        <div class="text-center position-relative bg-white px-2" style="z-index: 2;">
                            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center mx-auto mb-2 shadow-sm"
                                style="width: 32px; height: 32px; font-weight: bold;">2</div>
                            <span class="d-block text-xs font-weight-bold text-primary text-uppercase"
                                style="font-size: 0.7rem;">Visita</span>
                        </div>

                        <!-- Step 3: Conclusão -->
                        <div class="text-center position-relative bg-white px-2" style="z-index: 2;">
                            <div class="rounded-circle bg-white border d-flex align-items-center justify-content-center mx-auto mb-2"
                                style="width: 32px; height: 32px; color: #adb5bd;">3</div>
                            <span class="d-block text-xs font-weight-bold text-muted text-uppercase"
                                style="font-size: 0.7rem;">Fim</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Standard Header -->
    <div class="row align-items-center mb-4">
        <div class="col-12 d-flex align-items-center">
            <a href="/dashboard/consultant" class="btn btn-link text-decoration-none text-muted p-0 me-3">
                <i class="ph-bold ph-arrow-left fa-lg"></i>
            </a>
            <div>
                <h1 class="h3 mb-1 text-gray-800">Verificação Técnica</h1>
                <p class="text-muted mb-0">
                    {{ report_data.nome_estabelecimento }} • {{ report_data.data_inspecao }}
                </p>
            </div>
        </div>
    </div>

    <!-- Summary Card (Same as Manager) -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white py-3">
            <h5 class="m-0 font-weight-bold text-primary">Resumo Executivo</h5>
        </div>
        <div class="card-body">
            <p class="text-muted mb-4">{{ report_data.resumo_geral }}</p>

            <div class="table-responsive">
                <table class="table table-bordered table-hover mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th>Área Auditada</th>
                            <th class="text-center">Pontuação</th>
                            <th class="text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for area in report_data.areas_inspecionadas %}
                        <tr>
                            <td class="align-middle fw-bold text-dark">{{ area.nome_area }}</td>
                            <td class="align-middle text-center">{{ area.pontuacao_obtida|default(0) }} / {{
                                area.pontuacao_maxima|default(0) }}</td>
                            <td class="align-middle text-center">
                                {% if "parcial" in area.status|default('')|lower or (area.aproveitamento > 0 and
                                area.aproveitamento < 100) %} <span class="badge bg-warning text-dark">Parcialmente
                                    Conforme ({{ area.aproveitamento }}%)</span>
                                    {% elif area.aproveitamento >= 100 %}
                                    <span class="badge bg-success">Conforme ({{ area.aproveitamento }}%)</span>
                                    {% else %}
                                    <span class="badge bg-danger">Não Conforme ({{ area.aproveitamento }}%)</span>
                                    {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Resumo Geral da Inspeção -->
    {% set score_color = '#10b981' if report_data.aproveitamento_geral|default(0) >= 70 else ('#f59e0b' if report_data.aproveitamento_geral|default(0) >= 50 else '#ef4444') %}
    <div class="card shadow-sm mb-4" style="border-left: 4px solid #0ea5e9;">
        <div class="card-body p-4" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
            <h5 class="mb-3 font-weight-bold" style="color: #0c4a6e;">
                <i class="fas fa-chart-line me-2" style="color: #0ea5e9;"></i>
                Resumo Geral da Inspeção
            </h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="text-center p-3 bg-white rounded shadow-sm">
                        <div class="text-muted mb-1" style="font-size: 0.875rem;">Pontuação Obtida</div>
                        <div class="h2 mb-0 font-weight-bold" style="color: #0ea5e9;">
                            {{ report_data.pontuacao_geral|default(0)|round(2) }}
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center p-3 bg-white rounded shadow-sm">
                        <div class="text-muted mb-1" style="font-size: 0.875rem;">Pontuação Máxima</div>
                        <div class="h2 mb-0 font-weight-bold" style="color: #64748b;">
                            {{ report_data.pontuacao_maxima_geral|default(0)|round(2) }}
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center p-3 bg-white rounded shadow-sm">
                        <div class="text-muted mb-1" style="font-size: 0.875rem;">Aproveitamento</div>
                        <div class="h2 mb-0 font-weight-bold" style="color: {{ score_color }}">
                            {{ report_data.aproveitamento_geral|default(0)|round(2) }}%
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Details Section -->
    <h4 class="mb-3 text-gray-800">Checklist de Verificação</h4>

    <div class="accordion shadow-sm" id="accordionAreas">
        {% for area in report_data.areas_inspecionadas %}
        {% if area.items_nc > 0 %}
        <div class="accordion-item mb-3 border rounded overflow-hidden">
            <h2 class="accordion-header" id="heading{{ loop.index }}">
                <button class="accordion-button collapsed bg-white text-dark fw-bold" type="button"
                    data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}">
                    <div class="d-flex align-items-center w-100 me-3">
                        <span class="me-auto">{{ area.nome_area }}</span>
                        <span class="badge bg-light text-dark border me-2">{{ area.items_nc }} apontamentos</span>
                    </div>
                </button>
            </h2>
            <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#accordionAreas">
                <div class="accordion-body bg-light p-4">
                    {% for item in area.itens %}
                    {# Strict filtering: only show if Not Conforming (Points < Max or Status !=Conforme) #} {% if
                        item.status !='Conforme' and item.pontuacao|float < area.pontuacao_maxima_item|default(10)|float
                        %} <div class="card border-0 shadow-sm mb-3">
                        <div class="card-header bg-white d-flex justify-content-between align-items-start py-3">
                            <div class="me-3 flex-grow-1">
                                <h6 class="m-0 font-weight-bold text-dark">{{ item.item_verificado }}</h6>
                                <small class="text-muted">{{ item.fundamento_legal }}</small>
                            </div>
                            <div class="text-end flex-shrink-0 text-nowrap">
                                {% if "parcial" in (item.status or '')|lower or (item.pontuacao|float > 0 and
                                item.pontuacao|float < area.pontuacao_maxima_item|default(10)|float) %} <span
                                    class="badge bg-warning text-dark rounded-pill px-3">Parcialmente Conforme</span>
                                    {% else %}
                                    <span class="badge bg-danger rounded-pill px-3">Não Conforme</span>
                                    {% endif %}
                                    <span class="badge bg-secondary rounded-pill ms-1">{{ item.pontuacao }} pts</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row g-4">
                                <!-- Problem + Manager Plan (Read Only for Consultant) -->
                                <div class="col-md-7 border-end">
                                    <div class="mb-3">
                                        <label class="text-xs fw-bold text-muted text-uppercase mb-1">Problema
                                            Identificado</label>
                                        <div
                                            class="alert alert-danger bg-danger bg-opacity-10 border-0 py-2 px-3 text-sm mb-0">
                                            {{ item.observacao }}
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-8">
                                            <label class="text-xs fw-bold text-muted text-uppercase mb-1">Ação Planejada
                                                (Gestor)</label>
                                            <textarea class="form-control bg-light" rows="3" readonly disabled
                                                style="font-size: 0.9rem; resize: none;">{{ item.acao_corretiva_sugerida or '' }}</textarea>
                                        </div>
                                        <div class="col-4">
                                            <label class="text-xs fw-bold text-muted text-uppercase mb-1">Prazo
                                                Definido</label>
                                            <input type="text" class="form-control bg-light"
                                                value="{{ item.prazo_sugerido }}" readonly disabled
                                                style="font-size: 0.9rem;">
                                        </div>
                                    </div>
                                </div>

                                <!-- Consultant Follow-up Area -->
                                <div class="col-md-5 bg-white">
                                    <div class="p-3 border rounded bg-light">
                                        <label class="d-block text-xs fw-bold text-primary text-uppercase mb-2">
                                            <i class="ph-bold ph-eye me-1"></i> Resultado da Verificação
                                        </label>

                                        <!-- Follow-up Toggle -->
                                        <div class="d-flex gap-2 mb-3">
                                            <input type="radio" class="btn-check" name="status_{{ item.id }}"
                                                id="status_ok_{{ loop.index }}_{{ item.id }}" autocomplete="off"
                                                onchange="toggleEvidence('{{ item.id }}'); saveItem('{{ item.id }}')"
                                                {% if item.status_atual=='Corrigido' %}checked{% endif %}>
                                            <label class="btn btn-outline-success btn-sm flex-fill"
                                                for="status_ok_{{ loop.index }}_{{ item.id }}">
                                                <i class="ph-bold ph-check me-1"></i> Corrigido
                                            </label>

                                            <input type="radio" class="btn-check" name="status_{{ item.id }}"
                                                id="status_pend_{{ loop.index }}_{{ item.id }}" autocomplete="off"
                                                onchange="toggleEvidence('{{ item.id }}'); saveItem('{{ item.id }}')"
                                                {% if item.status_atual=='Pendente' %}checked{% endif %}>
                                            <label class="btn btn-outline-warning btn-sm flex-fill"
                                                for="status_pend_{{ loop.index }}_{{ item.id }}">
                                                <i class="ph-bold ph-clock me-1"></i> Pendente
                                            </label>
                                        </div>

                                        <!-- Evidence Upload (Conditional) -->
                                        <div id="evidence_container_{{ item.id }}"
                                            class="mb-3 {% if item.status_atual != 'Corrigido' %}d-none{% endif %}">
                                            <label class="text-xs fw-bold text-muted text-uppercase mb-1">
                                                Evidência de Correção
                                            </label>

                                            <!-- Preview Area -->
                                            <div id="preview_area_{{ item.id }}"
                                                class="position-relative mb-2 {% if not item.evidence_image_url %}d-none{% endif %}">
                                                <img src="{{ item.evidence_image_url or '' }}"
                                                    id="img_preview_{{ item.id }}"
                                                    class="img-fluid rounded border shadow-sm w-100"
                                                    style="max-height: 200px; object-fit: cover;">
                                                <button
                                                    class="btn btn-danger btn-sm position-absolute top-0 end-0 m-2 rounded-circle hover-scale"
                                                    onclick="removeEvidence('{{ item.id }}')">
                                                    <i class="ph-bold ph-trash"></i>
                                                </button>
                                            </div>

                                            <!-- Upload Button -->
                                            <div id="upload_btn_{{ item.id }}"
                                                class="{% if item.evidence_image_url %}d-none{% endif %}">
                                                <input type="file" id="file_input_{{ item.id }}" class="d-none"
                                                    accept="image/*" onchange="uploadEvidence(this, '{{ item.id }}')">
                                                <button class="btn btn-outline-primary btn-sm w-100 border-dashed"
                                                    onclick="document.getElementById('file_input_{{ item.id }}').click()">
                                                    <i class="ph-bold ph-camera me-1"></i> Adicionar Foto
                                                </button>
                                            </div>
                                            <!-- Hidden Input for URL storage -->
                                            <input type="hidden" id="evidence_url_{{ item.id }}"
                                                value="{{ item.evidence_image_url or '' }}">
                                        </div>

                                        <!-- Notes -->
                                        <textarea class="form-control text-sm" rows="2" id="notes_{{ item.id }}"
                                            placeholder="Observações do consultor... (OBRIGATÓRIO)"
                                            data-original="{{ item.manager_notes or '' }}"
                                            oninput="markAsModified(this)"
                                            onblur="saveItem('{{ item.id }}')"
                                            required>{{ item.manager_notes or '' }}</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    {% endfor %}
</div>

<!-- Actions Area -->
<div class="card mt-5 mb-5 border-0 bg-white shadow-sm">
    <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div class="d-flex gap-2">
                {% set is_finalized = (inspection.status.value == 'COMPLETED') %}
                <!-- Unified Share Button (Matches Manager View) -->
                <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#shareModal"
                    {% if not is_finalized %}disabled{% endif %}>
                    <i class="ph-bold ph-share-network me-2"></i> Compartilhar
                </button>
                <!-- Download -->
                <button class="btn btn-outline-primary" onclick="exportPDF()"
                    {% if not is_finalized %}disabled{% endif %}>
                    <i class="ph-bold ph-file-pdf me-2"></i> Baixar Relatório
                </button>
            </div>
            <div>
                {% if not is_finalized %}
                <button class="btn btn-primary px-4 fw-bold" onclick="finishConsultantReview()"
                    id="btn-finish-consultant">
                    <i class="ph-bold ph-paper-plane-right me-2"></i> Finalizar Visita
                </button>
                {% else %}
                <button class="btn btn-success px-4 fw-bold" disabled>
                    <i class="ph-bold ph-check me-2"></i> Visita Finalizada
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>
</div>

<!-- Share Modal (Unified) -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Compartilhar Plano de Ação</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs mb-3" id="shareTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="whatsapp-tab" data-bs-toggle="tab"
                            data-bs-target="#whatsapp" type="button" role="tab" aria-selected="true">
                            <i class="ph-bold ph-whatsapp-logo me-2"></i>WhatsApp
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="email-tab" data-bs-toggle="tab" data-bs-target="#email"
                            type="button" role="tab" aria-selected="false">
                            <i class="ph-bold ph-envelope-simple me-2"></i>Email
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="shareTabContent">
                    <!-- WhatsApp Tab -->
                    <div class="tab-pane fade show active" id="whatsapp" role="tabpanel" aria-labelledby="whatsapp-tab">
                        <div class="list-group mb-3">
                            <label class="list-group-item">
                                <input class="form-check-input me-1" type="radio" name="waRecipient" value="custom"
                                    checked onchange="toggleCustom('wa', true)">
                                Outro número
                            </label>
                            {% for c in contacts %}
                            {% if c.phone %}
                            <label class="list-group-item">
                                <input class="form-check-input me-1" type="radio" name="waRecipient"
                                    value="{{ c.phone }}" data-name="{{ c.name }}" onchange="toggleCustom('wa', false)">
                                <div class="d-inline-block align-middle ms-2">
                                    <strong>{{ c.name }}</strong> <span class="badge bg-light text-dark ms-1">{{ c.role
                                        or 'Contato' }}</span><br>
                                    <small class="text-muted">{{ c.phone }}</small>
                                </div>
                            </label>
                            {% endif %}
                            {% endfor %}
                        </div>
                        <div id="waCustomInput">
                            <label class="form-label text-xs fw-bold text-uppercase">Número do WhatsApp (DDD +
                                Número)</label>
                            <input type="text" id="customPhone" class="form-control" placeholder="Ex: 5511999999999">
                        </div>
                        <button class="btn btn-success w-100 mt-3" onclick="sendWhatsApp()">
                            Enviar WhatsApp <i class="ph-bold ph-paper-plane-right ms-2"></i>
                        </button>
                    </div>

                    <!-- Email Tab -->
                    <div class="tab-pane fade" id="email" role="tabpanel" aria-labelledby="email-tab">
                        <div class="list-group mb-3">
                            <label class="list-group-item">
                                <input class="form-check-input me-1" type="radio" name="emailRecipient" value="custom"
                                    checked onchange="toggleCustom('email', true)">
                                Outro email
                            </label>
                            {% for c in contacts %}
                            {% if c.email %}
                            <label class="list-group-item">
                                <input class="form-check-input me-1" type="radio" name="emailRecipient"
                                    value="{{ c.email }}" data-name="{{ c.name }}"
                                    onchange="toggleCustom('email', false)">
                                <div class="d-inline-block align-middle ms-2">
                                    <strong>{{ c.name }}</strong> <span class="badge bg-light text-dark ms-1">{{ c.role
                                        or 'Contato' }}</span><br>
                                    <small class="text-muted">{{ c.email }}</small>
                                </div>
                            </label>
                            {% endif %}
                            {% endfor %}
                        </div>
                        <div id="emailCustomInput">
                            <label class="form-label text-xs fw-bold text-uppercase">Email do Destinatário</label>
                            <input type="email" id="customEmail" class="form-control" placeholder="nome@exemplo.com">
                        </div>
                        <button class="btn btn-primary w-100 mt-3" onclick="sendEmail()">
                            Enviar Email <i class="ph-bold ph-paper-plane-right ms-2"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Minimal safe overrides */
    .accordion-button:not(.collapsed) {
        background-color: #f8f9fa;
        color: #212529;
        box-shadow: none;
    }

    .accordion-button:focus {
        box-shadow: none;
        border-color: rgba(0, 0, 0, .125);
    }

    .contact-option {
        cursor: pointer;
        transition: all 0.2s;
    }

    .contact-option:hover {
        background-color: #f8f9fa;
        border-color: #2563eb !important;
    }

    .contact-option:has(:checked) {
        border-color: #2563eb !important;
        background-color: #eff6ff;
    }

    .text-sm {
        font-size: 0.875rem;
    }

    /* High Contrast Warning Button override for Consultant */
    .btn-outline-warning {
        color: #d97706 !important;
        /* Amber 600 - High Contrast */
        border-color: #d97706 !important;
    }

    .btn-outline-warning:hover,
    .btn-check:checked+.btn-outline-warning {
        background-color: #d97706 !important;
        color: white !important;
    }

    .border-dashed {
        border-style: dashed !important;
    }

    .hover-scale:hover {
        transform: scale(1.1);
        transition: transform 0.2s;
    }
</style>

<!-- CSS for Auto-Save Feedback -->
<style>
    .modified-field {
        border-left: 3px solid #2563eb !important;
        background-color: #eff6ff;
    }

    .status-saved {
        color: #10b981;
        font-size: 0.75rem;
        font-weight: 600;
        animation: fadeIn 0.3s;
    }

    .status-saving {
        color: #64748b;
        font-size: 0.75rem;
        animation: pulse 1s infinite;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @keyframes pulse {
        0% {
            opacity: 0.6;
        }

        50% {
            opacity: 1;
        }

        100% {
            opacity: 0.6;
        }
    }
</style>

<script>
    const IS_DEV_MODE = {{ is_dev_mode|default (false) | tojson }};
    let contactModal;

    document.addEventListener('DOMContentLoaded', function () {
        // Init Modal
        contactModal = new bootstrap.Modal(document.getElementById('contactModal'));

        // Initialize evidence containers based on current status
        document.querySelectorAll('[id^="status_ok_"]').forEach(radio => {
            if (radio.checked) {
                const itemId = radio.name.replace('status_', '');
                console.log('Initializing evidence for item:', itemId);

                // Show evidence container
                toggleEvidence(itemId);

                // Check if there's an evidence URL
                const evidenceUrl = document.getElementById(`evidence_url_${itemId}`)?.value;
                console.log('Evidence URL for', itemId, ':', evidenceUrl);

                if (evidenceUrl) {
                    // Show preview area
                    const previewArea = document.getElementById(`preview_area_${itemId}`);
                    const uploadBtn = document.getElementById(`upload_btn_${itemId}`);

                    if (previewArea) {
                        previewArea.classList.remove('d-none');
                        console.log('Showing preview area for', itemId);
                    }
                    if (uploadBtn) {
                        uploadBtn.classList.add('d-none');
                    }
                }
            }
        });
    });

    // --- UI Helpers ---
    function markAsModified(input) {
        if (input.value !== input.dataset.original) {
            input.classList.add('modified-field');
        } else {
            input.classList.remove('modified-field');
        }
    }

    // --- Evidence Logic ---
    function toggleEvidence(itemId) {
        // Encontra o radio 'Corrigido' específico deste item
        const radioOk = document.querySelector(`input[name="status_${itemId}"][id*="status_ok_"]:checked`);
        const show = !!radioOk; // Se o radio OK estiver checado, show = true

        const container = document.getElementById(`evidence_container_${itemId}`);
        if (show) container.classList.remove('d-none');
        else container.classList.add('d-none');
    }

    async function uploadEvidence(input, itemId) {
        if (!input.files || !input.files[0]) return;

        const file = input.files[0];
        const formData = new FormData();
        formData.append('file', file);

        const btn = input.nextElementSibling;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Enviando...';
        btn.disabled = true;

        // Mock Dev Mode Bypass
        if (IS_DEV_MODE) {
            console.warn("Dev Mode: Mocking upload...");
            setTimeout(async () => {
                const mockUrl = "https://placehold.co/400x300?text=Evidencia+Mock";
                document.getElementById(`img_preview_${itemId}`).src = mockUrl;
                document.getElementById(`evidence_url_${itemId}`).value = mockUrl;
                document.getElementById(`preview_area_${itemId}`).classList.remove('d-none');
                document.getElementById(`upload_btn_${itemId}`).classList.add('d-none');
                await saveItem(itemId);

                btn.innerHTML = originalText;
                btn.disabled = false;
                input.value = '';
            }, 1000);
            return;
        }

        try {
            const res = await fetch('/api/upload_evidence', {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token() }}' },
                body: formData
            });

            if (!res.ok) throw new Error('Upload falhou');

            const data = await res.json();

            // Update UI
            document.getElementById(`img_preview_${itemId}`).src = data.url;
            document.getElementById(`evidence_url_${itemId}`).value = data.url;

            document.getElementById(`preview_area_${itemId}`).classList.remove('d-none');
            document.getElementById(`upload_btn_${itemId}`).classList.add('d-none');

            // Auto-save the item with the new URL
            await saveItem(itemId);

        } catch (err) {
            console.error(err);
            alert('Erro ao enviar imagem.');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
            input.value = ''; // Reset
        }
    }

    function removeEvidence(itemId) {
        if (!confirm('Remover esta evidência?')) return;

        document.getElementById(`evidence_url_${itemId}`).value = '';
        document.getElementById(`preview_area_${itemId}`).classList.add('d-none');
        document.getElementById(`upload_btn_${itemId}`).classList.remove('d-none');
        saveItem(itemId);
    }


    // --- Save Logic with Visual Feedback ---
    async function saveItem(itemId) {
        // Find indicator logic
        // Note: Indicators need to be added to HTML first. 
        // We assume they are added in the HTML block (separate tool call or previous step if I had edited it).
        // Actually I need to add them to HTML first. 
        // I'll assume they exist or add logic to creating them dynamically? 
        // Better to update HTML first. 
        // But this script replaces the logic. Let's make it robust.

        const radioChecked = document.querySelector(`input[name="status_${itemId}"]:checked`);
        const isOk = radioChecked && radioChecked.id.includes('status_ok');
        const notes = document.getElementById(`notes_${itemId}`).value;
        const evidenceUrl = document.getElementById(`evidence_url_${itemId}`).value;

        // Visual Feedback
        const indicatorId = `indicator_${itemId}`;
        let indicator = document.getElementById(indicatorId);
        if (!indicator) {
            // Try to find the container to insert if not exists (fallback)
            const notesInput = document.getElementById(`notes_${itemId}`);
            if (notesInput) {
                // Insert after
                indicator = document.createElement('div');
                indicator.id = indicatorId;
                indicator.className = 'mt-1 text-end';
                notesInput.parentNode.insertBefore(indicator, notesInput.nextSibling);
            }
        }
        if (indicator) indicator.innerHTML = '<span class="status-saving"><i class="ph-bold ph-arrows-clockwise"></i> Salvando...</span>';

        const payload = {};
        payload[itemId] = {
            is_corrected: isOk,
            correction_notes: notes,
            evidence_image_url: evidenceUrl
        };

        console.log('[SAVE_ITEM] Payload being sent:', payload);
        console.log('[SAVE_ITEM] Evidence URL:', evidenceUrl);

        try {
            // Mock Save in Dev Mode (if no backend endpoint)
            if (IS_DEV_MODE) {
                await new Promise(r => setTimeout(r, 600));
                console.log("Dev Save:", payload);
            } else {
                const fileId = "{{ inspection.drive_file_id }}";
                await fetch(`/api/save_review/${fileId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
                    body: JSON.stringify(payload)
                });
            }

            if (indicator) {
                indicator.innerHTML = '<span class="status-saved"><i class="ph-bold ph-check"></i> Salvo</span>';

                // Update original data to remove "modified" state
                const notesInput = document.getElementById(`notes_${itemId}`);
                if (notesInput) {
                    notesInput.dataset.original = notesInput.value;
                    notesInput.classList.remove('modified-field');
                }

                setTimeout(() => { indicator.innerHTML = ''; }, 2000);
            }
        } catch (e) {
            console.error("Auto-save failed", e);
            if (indicator) indicator.innerHTML = '<span class="text-danger text-xs">Erro ao salvar</span>';
        }
    }

    async function finishConsultantReview() {
        // Validação: Verificar se todos os itens não conformes têm status selecionado e observações
        const allItems = document.querySelectorAll('[id^="notes_"]');
        const missingItems = [];

        allItems.forEach(notesTextarea => {
            const itemId = notesTextarea.id.replace('notes_', '');

            // Verificar se há um status selecionado
            const statusSelected = document.querySelector(`input[name="status_${itemId}"]:checked`);

            // Verificar se há observações
            const notes = notesTextarea.value.trim();

            if (!statusSelected) {
                missingItems.push(`Item sem status selecionado`);
            } else if (!notes) {
                missingItems.push(`Item sem observações`);
            }
        });

        if (missingItems.length > 0) {
            alert('Por favor, complete todos os campos obrigatórios:\n\n' +
                  '• Todos os itens devem ter um status selecionado (Corrigido ou Pendente)\n' +
                  '• Todos os itens devem ter observações preenchidas\n\n' +
                  `Faltam ${missingItems.length} item(ns) para preencher.`);
            return;
        }

        const btn = document.getElementById('btn-finish-consultant');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enviando...';
        btn.disabled = true;

        try {
            const res = await fetch('/api/finalize_verification/{{ inspection.drive_file_id }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' }
            });
            const data = await res.json();

            if (res.ok) {
                alert('Visita Finalizada com Sucesso!');
                window.location.href = '/dashboard/consultant'; // Redirect to dashboard
            } else {
                alert('Erro ao finalizar: ' + (data.error || 'Erro desconhecido'));
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        } catch (e) {
            console.error(e);
            alert('Erro de conexão.');
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    // --- Unified Sharing Logic ---
    function toggleCustom(type, isCustom) {
        const inputDiv = document.getElementById(type === 'wa' ? 'waCustomInput' : 'emailCustomInput');
        inputDiv.style.display = isCustom ? 'block' : 'none';
    }

    function sendWhatsApp() {
        const selected = document.querySelector('input[name="waRecipient"]:checked');
        if (!selected) return alert('Selecione um destinatário.');

        let phone = selected.value;
        let name = "Responsável";

        if (phone === 'custom') {
            phone = document.getElementById('customPhone').value;
            name = "Responsável";
        } else {
            name = selected.dataset.name || "Responsável";
        }

        // Clean Phone
        phone = phone.replace(/\D/g, '');
        if (phone.length === 0) return alert('Telefone inválido.');
        if (phone.length <= 11) phone = '55' + phone;

        // Use the revised PDF link
        const downloadUrl = "{{ url_for('download_revised_pdf', file_id=inspection.drive_file_id, _external=True) }}";
        const msg = `Olá ${name}, segue o link do seu Plano de Ação: ${downloadUrl}`;

        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');

        // Optional: Close modal
        // const modal = bootstrap.Modal.getInstance(document.getElementById('shareModal'));
        // modal.hide();
    }

    async function sendEmail() {
        const selected = document.querySelector('input[name="emailRecipient"]:checked');
        if (!selected) return alert('Selecione um destinatário.');

        let email = selected.value;
        let name = "Responsável";

        if (email === 'custom') {
            email = document.getElementById('customEmail').value;
            name = "Responsável";
            if (!email) return alert('Digite um email.');
        } else {
            name = selected.dataset.name || "Responsável";
        }

        const btn = event.target; // Get clicked button
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enviando...';
        btn.disabled = true;

        try {
            // Using existing API route
            const response = await fetch(`/api/email_plan/{{ inspection.drive_file_id }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({
                    target_email: email,
                    target_name: name
                })
            });

            const data = await response.json();
            if (response.ok) {
                alert('Email enviado com sucesso!');
                const modal = bootstrap.Modal.getInstance(document.getElementById('shareModal'));
                if (modal) modal.hide();
            } else {
                alert('Erro: ' + (data.error || 'Falha no envio'));
            }
        } catch (e) {
            console.error(e);
            alert('Erro de conexão.');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    function exportPDF() { window.open('/download_revised_pdf/{{ inspection.drive_file_id }}', '_blank'); }
</script>
{% endblock %}