{% extends "layout.html" %}

{% block title %}Verificação Técnica (Consultor){% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Process Status Stepper -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body py-3 px-4">
                    <div class="d-flex justify-content-between align-items-center position-relative">
                        <!-- Progress Line -->
                        <div class="position-absolute w-100"
                            style="top: 15px; left: 0; height: 2px; background: #e9ecef; z-index: 0;"></div>

                        <!-- Step 1: Gestor (Completed) -->
                        <div class="text-center position-relative bg-white px-2" style="z-index: 2;">
                            <div class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center mx-auto mb-2 shadow-sm"
                                style="width: 32px; height: 32px; font-weight: bold;"><i class="ph-bold ph-check"></i>
                            </div>
                            <span class="d-block text-xs font-weight-bold text-success text-uppercase"
                                style="font-size: 0.7rem;">Validação</span>
                        </div>

                        <!-- Step 2: Consultor (Active) -->
                        <div class="text-center position-relative bg-white px-2" style="z-index: 2;">
                            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center mx-auto mb-2 shadow-sm"
                                style="width: 32px; height: 32px; font-weight: bold;">2</div>
                            <span class="d-block text-xs font-weight-bold text-primary text-uppercase"
                                style="font-size: 0.7rem;">Visita</span>
                        </div>

                        <!-- Step 3: Conclusão -->
                        <div class="text-center position-relative bg-white px-2" style="z-index: 2;">
                            <div class="rounded-circle bg-white border d-flex align-items-center justify-content-center mx-auto mb-2"
                                style="width: 32px; height: 32px; color: #adb5bd;">3</div>
                            <span class="d-block text-xs font-weight-bold text-muted text-uppercase"
                                style="font-size: 0.7rem;">Fim</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Standard Header -->
    <div class="row align-items-center mb-4">
        <div class="col-md-8">
            <h1 class="h3 mb-1 text-gray-800">Verificação Técnica</h1>
            <p class="text-muted mb-0">
                {{ report_data.nome_estabelecimento }} • {{ report_data.data_inspecao }}
            </p>
        </div>
        <div class="col-md-4 text-end">
            <!-- Reuse same Stats Card -->
            <div class="card border-0 shadow-sm d-inline-block">
                <div class="card-body py-2 px-3">
                    <span class="text-xs font-weight-bold text-muted text-uppercase d-block">Aproveitamento</span>
                    <span
                        class="h2 font-weight-bold {% if report_data.aproveitamento_geral|default(0) >= 70 %}text-success{% else %}text-danger{% endif %} mb-0">
                        {{ report_data.aproveitamento_geral|default(0) }}%
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Card (Same as Manager) -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white py-3">
            <h5 class="m-0 font-weight-bold text-primary">Resumo Executivo</h5>
        </div>
        <div class="card-body">
            <p class="text-muted mb-4">{{ report_data.resumo_geral }}</p>

            <div class="table-responsive">
                <table class="table table-bordered table-hover mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th>Área Auditada</th>
                            <th class="text-center">Pontuação</th>
                            <th class="text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for area in report_data.areas_inspecionadas %}
                        {% if area.items_nc > 0 %}
                        <tr>
                            <td class="align-middle fw-bold text-dark">{{ area.nome_area }}</td>
                            <td class="align-middle text-center">{{ area.pontuacao_obtida|default(0) }} / {{
                                area.pontuacao_maxima|default(0) }}</td>
                            <td class="align-middle text-center">
                                {% if "parcial" in area.status|default('')|lower or (area.aproveitamento > 0 and
                                area.aproveitamento < 100) %} <span class="badge bg-warning text-dark">Parcialmente
                                    Conforme ({{ area.aproveitamento|int }}%)</span>
                                    {% elif area.aproveitamento >= 100 %}
                                    <span class="badge bg-success">Conforme ({{ area.aproveitamento|int }}%)</span>
                                    {% else %}
                                    <span class="badge bg-danger">Não Conforme ({{ area.aproveitamento|int }}%)</span>
                                    {% endif %}
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Details Section -->
    <h4 class="mb-3 text-gray-800">Checklist de Verificação</h4>

    <div class="accordion shadow-sm" id="accordionAreas">
        {% for area in report_data.areas_inspecionadas %}
        {% if area.items_nc > 0 %}
        <div class="accordion-item mb-3 border rounded overflow-hidden">
            <h2 class="accordion-header" id="heading{{ loop.index }}">
                <button class="accordion-button collapsed bg-white text-dark fw-bold" type="button"
                    data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}">
                    <div class="d-flex align-items-center w-100 me-3">
                        <span class="me-auto">{{ area.nome_area }}</span>
                        <span class="badge bg-light text-dark border me-2">{{ area.items_nc }} apontamentos</span>
                    </div>
                </button>
            </h2>
            <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#accordionAreas">
                <div class="accordion-body bg-light p-4">
                    {% for item in area.itens %}
                    {# Strict filtering: only show if Not Conforming (Points < Max or Status !=Conforme) #} {% if
                        item.status !='Conforme' and item.pontuacao|float < area.pontuacao_maxima_item|default(10)|float
                        %} <div class="card border-0 shadow-sm mb-3">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                            <div>
                                <h6 class="m-0 font-weight-bold text-dark">{{ item.item_verificado }}</h6>
                                <small class="text-muted">{{ item.fundamento_legal }}</small>
                            </div>
                            <div>
                                {% if "parcial" in item.status|default('')|lower or (item.pontuacao|float > 0 and
                                item.pontuacao|float < area.pontuacao_maxima_item|default(10)|float) %} <span
                                    class="badge bg-warning text-dark rounded-pill px-3">Parcialmente Conforme</span>
                                    {% else %}
                                    <span class="badge bg-danger rounded-pill px-3">Não Conforme</span>
                                    {% endif %}
                                    <span class="badge bg-secondary rounded-pill ms-1">{{ item.pontuacao }} pts</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row g-4">
                                <!-- Problem + Manager Plan (Read Only for Consultant) -->
                                <div class="col-md-7 border-end">
                                    <div class="mb-3">
                                        <label class="text-xs fw-bold text-muted text-uppercase mb-1">Problema
                                            Identificado</label>
                                        <div
                                            class="alert alert-danger bg-danger bg-opacity-10 border-0 py-2 px-3 text-sm mb-0">
                                            {{ item.observacao }}
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-8">
                                            <label class="text-xs fw-bold text-muted text-uppercase mb-1">Ação Planejada
                                                (Gestor)</label>
                                            <input type="text" class="form-control bg-light"
                                                value="{{ item.acao_corretiva_sugerida }}" readonly disabled
                                                style="font-size: 0.9rem;">
                                        </div>
                                        <div class="col-4">
                                            <label class="text-xs fw-bold text-muted text-uppercase mb-1">Prazo
                                                Definido</label>
                                            <input type="text" class="form-control bg-light"
                                                value="{{ item.prazo_sugerido }}" readonly disabled
                                                style="font-size: 0.9rem;">
                                        </div>
                                    </div>
                                </div>

                                <!-- Consultant Follow-up Area -->
                                <div class="col-md-5 bg-white">
                                    <div class="p-3 border rounded bg-light">
                                        <label class="d-block text-xs fw-bold text-primary text-uppercase mb-2">
                                            <i class="ph-bold ph-eye me-1"></i> Resultado da Verificação
                                        </label>

                                        <!-- Follow-up Toggle -->
                                        <div class="d-flex gap-2 mb-3">
                                            <input type="radio" class="btn-check" name="status_{{ item.id }}"
                                                id="status_ok_{{ loop.index }}_{{ item.id }}" autocomplete="off"
                                                onchange="toggleEvidence('{{ item.id }}'); saveItem('{{ item.id }}')" {%
                                                if item.status_atual=='Corrigido' %}checked{% endif %}>
                                            <label class="btn btn-outline-success btn-sm flex-fill"
                                                for="status_ok_{{ loop.index }}_{{ item.id }}">
                                                <i class="ph-bold ph-check me-1"></i> Corrigido
                                            </label>

                                            <input type="radio" class="btn-check" name="status_{{ item.id }}"
                                                id="status_pend_{{ loop.index }}_{{ item.id }}" autocomplete="off"
                                                onchange="toggleEvidence('{{ item.id }}'); saveItem('{{ item.id }}')" {%
                                                if item.status_atual !='Corrigido' %}checked{% endif %}>
                                            <label class="btn btn-outline-warning btn-sm flex-fill"
                                                for="status_pend_{{ loop.index }}_{{ item.id }}">
                                                <i class="ph-bold ph-clock me-1"></i> Pendente
                                            </label>
                                        </div>

                                        <!-- Evidence Upload (Conditional) -->
                                        <div id="evidence_container_{{ item.id }}"
                                            class="mb-3 {% if item.status_atual != 'Corrigido' %}d-none{% endif %}">
                                            <label class="text-xs fw-bold text-muted text-uppercase mb-1">
                                                Evidência de Correção
                                            </label>

                                            <!-- Preview Area -->
                                            <div id="preview_area_{{ item.id }}"
                                                class="position-relative mb-2 {% if not item.evidence_image_url %}d-none{% endif %}">
                                                <img src="{{ item.evidence_image_url or '' }}"
                                                    id="img_preview_{{ item.id }}"
                                                    class="img-fluid rounded border shadow-sm w-100"
                                                    style="max-height: 200px; object-fit: cover;">
                                                <button
                                                    class="btn btn-danger btn-sm position-absolute top-0 end-0 m-2 rounded-circle hover-scale"
                                                    onclick="removeEvidence('{{ item.id }}')">
                                                    <i class="ph-bold ph-trash"></i>
                                                </button>
                                            </div>

                                            <!-- Upload Button -->
                                            <div id="upload_btn_{{ item.id }}"
                                                class="{% if item.evidence_image_url %}d-none{% endif %}">
                                                <input type="file" id="file_input_{{ item.id }}" class="d-none"
                                                    accept="image/*" onchange="uploadEvidence(this, '{{ item.id }}')">
                                                <button class="btn btn-outline-primary btn-sm w-100 border-dashed"
                                                    onclick="document.getElementById('file_input_{{ item.id }}').click()">
                                                    <i class="ph-bold ph-camera me-1"></i> Adicionar Foto
                                                </button>
                                            </div>
                                            <!-- Hidden Input for URL storage -->
                                            <input type="hidden" id="evidence_url_{{ item.id }}"
                                                value="{{ item.evidence_image_url or '' }}">
                                        </div>

                                        <!-- Notes -->
                                        <textarea class="form-control text-sm" rows="2" id="notes_{{ item.id }}"
                                            placeholder="Observações do consultor... (Opcional)"
                                            onblur="saveItem('{{ item.id }}')">{{ item.manager_notes or '' }}</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    {% endfor %}
</div>

<!-- Actions Area -->
<div class="card mt-5 mb-5 border-0 bg-white shadow-sm">
    <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div class="d-flex gap-2">
                <!-- Share Actions -->
                <button class="btn btn-outline-success" onclick="shareAction('whatsapp')">
                    <i class="ph-bold ph-whatsapp-logo me-2"></i> WhatsApp
                </button>
                <button class="btn btn-outline-secondary" onclick="shareAction('email')">
                    <i class="ph-bold ph-envelope-simple me-2"></i> Email
                </button>
                <!-- Download -->
                <button class="btn btn-outline-primary" onclick="exportPDF()">
                    <i class="ph-bold ph-file-pdf me-2"></i> Baixar Relatório
                </button>
            </div>
            <div>

                <button class="btn btn-primary px-4 fw-bold" onclick="finishConsultantReview()"
                    id="btn-finish-consultant">
                    <i class="ph-bold ph-paper-plane-right me-2"></i> Finalizar Verificação
                </button>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Contact Selection Modal -->
<div class="modal fade" id="contactModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-white border-bottom-0">
                <h5 class="modal-title font-weight-bold">
                    <i class="ph-bold ph-paper-plane-tilt me-2 text-primary"></i> Enviar Relatório
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <p class="text-muted text-sm mb-4">Selecione o responsável para receber o Plano de Ação.</p>

                <!-- Platform Selection (Hidden state) -->
                <input type="hidden" id="sharePlatform" value="whatsapp">

                <!-- Contact List -->
                <div class="list-group mb-3" id="contactsListGroup">
                    {% for contact in contacts %}
                    <label
                        class="list-group-item list-group-item-action d-flex align-items-center gap-3 p-3 border rounded mb-2 shadow-sm contact-option pointer-cursor">
                        <input class="form-check-input flex-shrink-0" type="radio" name="selectedContact"
                            value="{{ contact.id }}" data-phone="{{ contact.phone }}" data-email="{{ contact.email }}"
                            data-name="{{ contact.name }}" {% if loop.first %}checked{% endif %}>
                        <div class="d-flex flex-column">
                            <span class="fw-bold text-dark">{{ contact.name }}</span>
                            <span class="text-xs text-muted">
                                <i class="ph-bold ph-phone me-1"></i> {{ contact.phone }}
                            </span>
                        </div>
                    </label>
                    {% else %}
                    <div class="text-center py-4 bg-light rounded text-muted">
                        <i class="ph-bold ph-user-minus h4 mb-2"></i>
                        <p class="mb-0 text-sm">Nenhum contato cadastrado.</p>
                    </div>
                    {% endfor %}
                </div>

                <div class="d-grid">
                    <button class="btn btn-primary py-2 fw-bold" onclick="confirmShare()">
                        Confirmar Envio
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Minimal safe overrides */
    .accordion-button:not(.collapsed) {
        background-color: #f8f9fa;
        color: #212529;
        box-shadow: none;
    }

    .accordion-button:focus {
        box-shadow: none;
        border-color: rgba(0, 0, 0, .125);
    }

    .contact-option {
        cursor: pointer;
        transition: all 0.2s;
    }

    .contact-option:hover {
        background-color: #f8f9fa;
        border-color: #2563eb !important;
    }

    .contact-option:has(:checked) {
        border-color: #2563eb !important;
        background-color: #eff6ff;
    }

    .text-sm {
        font-size: 0.875rem;
    }

    /* High Contrast Warning Button override for Consultant */
    .btn-outline-warning {
        color: #d97706 !important;
        /* Amber 600 - High Contrast */
        border-color: #d97706 !important;
    }

    .btn-outline-warning:hover,
    .btn-check:checked+.btn-outline-warning {
        background-color: #d97706 !important;
        color: white !important;
    }

    .border-dashed {
        border-style: dashed !important;
    }

    .hover-scale:hover {
        transform: scale(1.1);
        transition: transform 0.2s;
    }
</style>

<!-- CSS for Auto-Save Feedback -->
<style>
    .modified-field {
        border-left: 3px solid #2563eb !important;
        background-color: #eff6ff;
    }

    .status-saved {
        color: #10b981;
        font-size: 0.75rem;
        font-weight: 600;
        animation: fadeIn 0.3s;
    }

    .status-saving {
        color: #64748b;
        font-size: 0.75rem;
        animation: pulse 1s infinite;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @keyframes pulse {
        0% {
            opacity: 0.6;
        }

        50% {
            opacity: 1;
        }

        100% {
            opacity: 0.6;
        }
    }
</style>

<script>
    const IS_DEV_MODE = {{ is_dev_mode|default (false) | tojson }};
    let contactModal;

    document.addEventListener('DOMContentLoaded', function () {
        // Init Modal
        contactModal = new bootstrap.Modal(document.getElementById('contactModal'));
    });

    // --- Evidence Logic ---
    // --- Evidence Logic ---
    function toggleEvidence(itemId) {
        // Encontra o radio 'Corrigido' específico deste item
        // Precisamos ser espertos no seletor pq itemId é único mas tem loop.index no ID.
        // Melhor usar o name="status_{{ item.id }}" e verificar qual está checked.

        const radioOk = document.querySelector(`input[name="status_${itemId}"][id*="status_ok_"]:checked`);
        const show = !!radioOk; // Se o radio OK estiver checado, show = true

        const container = document.getElementById(`evidence_container_${itemId}`);
        if (show) container.classList.remove('d-none');
        else container.classList.add('d-none');
    }

    async function uploadEvidence(input, itemId) {
        if (!input.files || !input.files[0]) return;

        const file = input.files[0];
        const formData = new FormData();
        formData.append('file', file);

        const btn = input.nextElementSibling;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Enviando...';
        btn.disabled = true;

        // Mock Dev Mode Bypass
        if (IS_DEV_MODE) {
            console.warn("Dev Mode: Mocking upload...");
            setTimeout(async () => {
                const mockUrl = "https://placehold.co/400x300?text=Evidencia+Mock";
                document.getElementById(`img_preview_${itemId}`).src = mockUrl;
                document.getElementById(`evidence_url_${itemId}`).value = mockUrl;
                document.getElementById(`preview_area_${itemId}`).classList.remove('d-none');
                document.getElementById(`upload_btn_${itemId}`).classList.add('d-none');
                await saveItem(itemId);

                btn.innerHTML = originalText;
                btn.disabled = false;
                input.value = '';
            }, 1000);
            return;
        }

        try {
            const res = await fetch('/api/upload_evidence', {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token() }}' },
                body: formData
            });

            if (!res.ok) throw new Error('Upload falhou');

            const data = await res.json();

            // Update UI
            document.getElementById(`img_preview_${itemId}`).src = data.url;
            document.getElementById(`evidence_url_${itemId}`).value = data.url;

            document.getElementById(`preview_area_${itemId}`).classList.remove('d-none');
            document.getElementById(`upload_btn_${itemId}`).classList.add('d-none');

            // Auto-save the item with the new URL
            await saveItem(itemId);

        } catch (err) {
            console.error(err);
            alert('Erro ao enviar imagem.');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
            input.value = ''; // Reset
        }
    }

    function removeEvidence(itemId) {
        if (!confirm('Remover esta evidência?')) return;

        document.getElementById(`evidence_url_${itemId}`).value = '';
        document.getElementById(`preview_area_${itemId}`).classList.add('d-none');
        document.getElementById(`upload_btn_${itemId}`).classList.remove('d-none');
        saveItem(itemId);
    }


    // --- Save Logic with Visual Feedback ---
    async function saveItem(itemId) {
        // Find indicator logic
        // Note: Indicators need to be added to HTML first. 
        // We assume they are added in the HTML block (separate tool call or previous step if I had edited it).
        // Actually I need to add them to HTML first. 
        // I'll assume they exist or add logic to creating them dynamically? 
        // Better to update HTML first. 
        // But this script replaces the logic. Let's make it robust.

        const radioChecked = document.querySelector(`input[name="status_${itemId}"]:checked`);
        const isOk = radioChecked && radioChecked.id.includes('status_ok');
        const notes = document.getElementById(`notes_${itemId}`).value;
        const evidenceUrl = document.getElementById(`evidence_url_${itemId}`).value;

        // Visual Feedback
        const indicatorId = `indicator_${itemId}`;
        let indicator = document.getElementById(indicatorId);
        if (!indicator) {
            // Try to find the container to insert if not exists (fallback)
            const notesInput = document.getElementById(`notes_${itemId}`);
            if (notesInput) {
                // Insert after
                indicator = document.createElement('div');
                indicator.id = indicatorId;
                indicator.className = 'mt-1 text-end';
                notesInput.parentNode.insertBefore(indicator, notesInput.nextSibling);
            }
        }
        if (indicator) indicator.innerHTML = '<span class="status-saving"><i class="ph-bold ph-arrows-clockwise"></i> Salvando...</span>';

        const payload = {};
        payload[itemId] = {
            is_corrected: isOk,
            correction_notes: notes,
            evidence_image_url: evidenceUrl
        };

        try {
            // Mock Save in Dev Mode (if no backend endpoint)
            if (IS_DEV_MODE) {
                await new Promise(r => setTimeout(r, 600));
                console.log("Dev Save:", payload);
            } else {
                const fileId = "{{ inspection.drive_file_id }}";
                await fetch(`/api/save_review/${fileId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
                    body: JSON.stringify(payload)
                });
            }

            if (indicator) {
                indicator.innerHTML = '<span class="status-saved"><i class="ph-bold ph-check"></i> Salvo</span>';
                setTimeout(() => { indicator.innerHTML = ''; }, 2000);
            }
        } catch (e) {
            console.error("Auto-save failed", e);
            if (indicator) indicator.innerHTML = '<span class="text-danger text-xs">Erro ao salvar</span>';
        }
    }

    function finishConsultantReview() {
        const btn = document.getElementById('btn-finish-consultant');
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enviando...';
        btn.disabled = true;

        try {
            const res = await fetch('/api/finalize_verification/{{ inspection.drive_file_id }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' }
            });
            const data = await res.json();

            if (res.ok) {
                alert('Verificação Concluída com Sucesso!');
                window.location.href = '/dashboard/consultant'; // Redirect to dashboard
            } else {
                alert('Erro ao finalizar: ' + (data.error || 'Erro desconhecido'));
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        } catch (e) {
            console.error(e);
            alert('Erro de conexão.');
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    function shareAction(platform) {
        // Set platform in hidden field
        document.getElementById('sharePlatform').value = platform;

        // Check if there are contacts
        const hasContacts = document.querySelectorAll('input[name="selectedContact"]').length > 0;

        if (!hasContacts) {
            alert('Nenhum contato cadastrado para este estabelecimento.');
            // Optional: allow manual entry? kept simple for now.
            return;
        }

        // Show Modal
        if (contactModal) contactModal.show();
    }

    async function confirmShare() {
        const platform = document.getElementById('sharePlatform').value;
        const selected = document.querySelector('input[name="selectedContact"]:checked');

        if (!selected) {
            alert("Selecione um contato.");
            return;
        }

        const contactId = selected.value;
        const contactName = selected.dataset.name;
        const contactPhone = selected.dataset.phone;
        const contactEmail = selected.dataset.email;

        // Hide modal
        if (contactModal) contactModal.hide();

        try {
            if (IS_DEV_MODE) {
                alert(`Dev Mode: Enviando para ${contactName} (${platform})`);
                return;
            }

            const payload = {
                via: platform,
                contact_id: contactId,
                phone: contactPhone, # Override or use backend logic based on ID
                email: contactEmail
            };

            const res = await fetch('/api/share_plan/{{ inspection.drive_file_id }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            if (data.success) {
                // Show Success Toast (reusing existing or alert)
                alert('Processo de envio iniciado (Background).');
            }
            else {
                alert('Erro: ' + data.error);
            }
        } catch (e) {
            console.error(e);
            alert('Erro de conexão ao tentar compartilhar.');
        }
    }

    function exportPDF() { window.open('/download_pdf/{{ inspection.drive_file_id }}', '_blank'); }
</script>
{% endblock %}