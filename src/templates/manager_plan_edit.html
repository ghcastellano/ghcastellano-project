{% extends "layout.html" %}

{% block title %}Validação do Plano (Gestor){% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Process Status Stepper -->
    {% set status_val = inspection.status.value if inspection.status.value is defined else inspection.status|string %}
    {% set step_completed = status_val in ['COMPLETED'] %}
    {% set step_consultant = status_val in ['APPROVED', 'PENDING_CONSULTANT_VERIFICATION'] %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body py-3 px-4">
                    <div class="d-flex justify-content-between align-items-center position-relative">
                        <!-- Progress Line -->
                        <div class="position-absolute w-100"
                            style="top: 15px; left: 0; height: 2px; background: #e9ecef; z-index: 0;"></div>

                        <!-- Step 1: Validação -->
                        <div class="text-center position-relative bg-white px-2" style="z-index: 2;">
                            {% if step_completed or step_consultant %}
                            <div class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center mx-auto mb-2 shadow-sm"
                                style="width: 32px; height: 32px; font-weight: bold;"><i class="ph-bold ph-check"></i></div>
                            <span class="d-block text-xs font-weight-bold text-success text-uppercase"
                                style="font-size: 0.7rem;">Validação</span>
                            {% else %}
                            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center mx-auto mb-2 shadow-sm"
                                style="width: 32px; height: 32px; font-weight: bold;">1</div>
                            <span class="d-block text-xs font-weight-bold text-primary text-uppercase"
                                style="font-size: 0.7rem;">Validação</span>
                            {% endif %}
                        </div>

                        <!-- Step 2: Visita -->
                        <div class="text-center position-relative bg-white px-2" style="z-index: 2;">
                            {% if step_completed %}
                            <div class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center mx-auto mb-2 shadow-sm"
                                style="width: 32px; height: 32px; font-weight: bold;"><i class="ph-bold ph-check"></i></div>
                            <span class="d-block text-xs font-weight-bold text-success text-uppercase"
                                style="font-size: 0.7rem;">Visita</span>
                            {% elif step_consultant %}
                            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center mx-auto mb-2 shadow-sm"
                                style="width: 32px; height: 32px; font-weight: bold;">2</div>
                            <span class="d-block text-xs font-weight-bold text-primary text-uppercase"
                                style="font-size: 0.7rem;">Visita</span>
                            {% else %}
                            <div class="rounded-circle bg-white border d-flex align-items-center justify-content-center mx-auto mb-2"
                                style="width: 32px; height: 32px; color: #adb5bd;">2</div>
                            <span class="d-block text-xs font-weight-bold text-muted text-uppercase"
                                style="font-size: 0.7rem;">Visita</span>
                            {% endif %}
                        </div>

                        <!-- Step 3: Fim -->
                        <div class="text-center position-relative bg-white px-2" style="z-index: 2;">
                            {% if step_completed %}
                            <div class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center mx-auto mb-2 shadow-sm"
                                style="width: 32px; height: 32px; font-weight: bold;"><i class="ph-bold ph-check"></i></div>
                            <span class="d-block text-xs font-weight-bold text-success text-uppercase"
                                style="font-size: 0.7rem;">Fim</span>
                            {% else %}
                            <div class="rounded-circle bg-white border d-flex align-items-center justify-content-center mx-auto mb-2"
                                style="width: 32px; height: 32px; color: #adb5bd;">3</div>
                            <span class="d-block text-xs font-weight-bold text-muted text-uppercase"
                                style="font-size: 0.7rem;">Fim</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Standard Header -->
    <div class="row align-items-center mb-4">
        <div class="col-12 d-flex align-items-center">
            <a href="{{ url_for('manager.dashboard_manager') if current_user.role == 'MANAGER' else url_for('root') }}"
                class="btn btn-link text-decoration-none text-muted p-0 me-3">
                <i class="ph-bold ph-arrow-left fa-lg"></i>
            </a>
            <div>
                <h1 class="h3 mb-1 text-gray-800">Validação do Plano</h1>
                <p class="text-muted mb-0">
                    {{ report_data.nome_estabelecimento }} • {{ report_data.data_inspecao }}
                </p>
            </div>
        </div>
    </div>

    <!-- Resumo Geral da Inspeção -->
    {% set score_color = '#10b981' if report_data.aproveitamento_geral|default(0) >= 70 else ('#f59e0b' if report_data.aproveitamento_geral|default(0) >= 50 else '#ef4444') %}
    <div class="card shadow-sm mb-4" style="border-left: 4px solid #0ea5e9;">
        <div class="card-body p-4" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
            <h5 class="mb-3 font-weight-bold" style="color: #0c4a6e;">
                <i class="fas fa-chart-line me-2" style="color: #0ea5e9;"></i>
                Resumo Geral da Inspeção
            </h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="text-center p-3 bg-white rounded shadow-sm">
                        <div class="text-muted mb-1" style="font-size: 0.875rem;">Pontuação Obtida</div>
                        <div class="h2 mb-0 font-weight-bold" style="color: #0ea5e9;">
                            {{ report_data.pontuacao_geral|default(0)|round(2) }}
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center p-3 bg-white rounded shadow-sm">
                        <div class="text-muted mb-1" style="font-size: 0.875rem;">Pontuação Máxima</div>
                        <div class="h2 mb-0 font-weight-bold" style="color: #64748b;">
                            {{ report_data.pontuacao_maxima_geral|default(0)|round(2) }}
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center p-3 bg-white rounded shadow-sm">
                        <div class="text-muted mb-1" style="font-size: 0.875rem;">Aproveitamento</div>
                        <div class="h2 mb-0 font-weight-bold" style="color: {{ score_color }}">
                            {{ report_data.aproveitamento_geral|default(0)|round(2) }}%
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resumo Executivo -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white py-3">
            <h5 class="m-0 font-weight-bold text-primary">Resumo Executivo</h5>
        </div>
        <div class="card-body">
            <p class="text-muted mb-4">{{ report_data.resumo_geral }}</p>

            <!-- Areas Table -->
            <div class="table-responsive">
                <table class="table table-bordered table-hover mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th>Área Auditada</th>
                            <th class="text-center">Pontuação</th>
                            <th class="text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for area in report_data.areas_inspecionadas %}
                        <tr>
                            <td class="align-middle fw-bold text-dark">{{ area.nome_area }}</td>
                            <td class="align-middle text-center">{{ area.pontuacao_obtida }} / {{ area.pontuacao_maxima
                                }}</td>
                            <td class="align-middle text-center">
                                {% if area.aproveitamento >= 100 %}
                                <span class="badge bg-success">Conforme ({{ area.aproveitamento }}%)</span>
                                {% elif area.aproveitamento > 0 %}
                                <span class="badge bg-warning text-dark">Parcialmente Conforme ({{ area.aproveitamento
                                    }}%)</span>
                                {% else %}
                                <span class="badge bg-danger">Não Conforme ({{ area.aproveitamento }}%)</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Details Section -->
    <h4 class="mb-3 text-gray-800">Detalhamento e Ações</h4>
    {# is_locked and is_approved are computed in the backend (manager_routes.py) #}

    <div class="accordion shadow-sm" id="accordionAreas">
        {% for area in report_data.areas_inspecionadas %}
        <div class="accordion-item mb-3 border rounded overflow-hidden">
            <h2 class="accordion-header" id="heading{{ loop.index }}">
                {% if area.items_nc > 0 %}
                <button class="accordion-button collapsed bg-white text-dark fw-bold" type="button"
                    data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}">
                    <div class="d-flex align-items-center w-100 me-3">
                        <span class="me-auto">{{ area.nome_area }}</span>
                        <span class="badge bg-light text-dark border me-2">{{ area.items_nc }} apontamentos</span>
                        <span class="badge bg-light text-dark border me-2">{{ area.pontuacao_obtida|round(2) }} / {{ area.pontuacao_maxima|round(2) }}</span>
                    </div>
                </button>
                {% else %}
                <div class="accordion-button collapsed bg-white text-dark fw-bold" style="cursor: default;">
                    <div class="d-flex align-items-center w-100 me-3">
                        <span class="me-auto">{{ area.nome_area }}</span>
                        <span class="badge bg-success rounded-pill px-3 me-2">Conforme</span>
                        <span class="badge bg-light text-dark border me-2">{{ area.pontuacao_obtida|round(2) }} / {{ area.pontuacao_maxima|round(2) }}</span>
                    </div>
                </div>
                {% endif %}
            </h2>
            {% if area.items_nc > 0 %}
            <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#accordionAreas">
                <div class="accordion-body bg-light p-4">
                    {% for item in area.itens %}
                    {# Filter out conforming items #}
                    {% if item.status != 'Conforme' %}
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-header bg-white d-flex justify-content-between align-items-start py-3">
                            <div class="me-3 flex-grow-1">
                                <h6 class="m-0 font-weight-bold text-dark">{{ item.item_verificado }}</h6>
                                <small class="text-muted">{{ item.fundamento_legal }}</small>
                            </div>
                            <div class="text-end flex-shrink-0 text-nowrap">
                                {% if 'parcial' in (item.status or '')|lower or (item.pontuacao|float > 0 and
                                item.pontuacao|float < area.pontuacao_maxima_item|default(10)|float) %} <span
                                    class="badge bg-warning text-dark rounded-pill px-3">Parcialmente Conforme</span>
                                    {% else %}
                                    <span class="badge bg-danger rounded-pill px-3">Não Conforme</span>
                                    {% endif %}
                                    <span class="badge bg-secondary rounded-pill ms-1">{{ item.pontuacao }} PTS</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row g-0">
                                <!-- Problem Section -->
                                <div class="col-md-5 pe-md-4 mb-3 mb-md-0 border-end">
                                    <label class="text-xs fw-bold text-muted text-uppercase mb-2">Problema
                                        Identificado</label>
                                    <div
                                        class="p-3 bg-danger bg-opacity-10 border border-danger border-opacity-25 rounded text-danger">
                                        {{ item.observacao }}
                                    </div>
                                </div>

                                <!-- Action Section -->
                                <div class="col-md-7 ps-md-4">
                                    <div class="mb-3">
                                        <label class="text-xs fw-bold text-muted text-uppercase mb-2">Ação Corretiva
                                            Sugerida</label>
                                        <div class="position-relative">
                                            <textarea class="form-control" rows="3"
                                                data-original="{{ item.acao_corretiva_sugerida }}"
                                                data-item-id="{{ item.id }}" oninput="markAsModified(this)"
                                                onblur="autoSaveItem(this)" {% if is_locked %}disabled{% endif
                                                %}>{{ item.acao_corretiva_sugerida }}</textarea>
                                            {% if not is_locked %}
                                            <div class="status-indicator position-absolute bottom-0 end-0 m-2"></div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="row align-items-center">
                                        <label
                                            class="col-auto col-form-label text-xs fw-bold text-muted text-uppercase">Prazo:</label>
                                        <div class="col position-relative">
                                            <input type="text" class="form-control" value="{{ item.prazo_sugerido }}"
                                                data-original="{{ item.prazo_sugerido }}" data-item-id="{{ item.id }}"
                                                oninput="markAsModified(this)" onblur="autoSaveItem(this)" {% if
                                                is_locked %}disabled{% endif %}>
                                            {% if not is_locked %}
                                            <div
                                                class="status-indicator position-absolute top-50 end-0 translate-middle-y me-3">
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- Actions Area -->
    <div class="card mt-5 mb-5 border-0 bg-white shadow-sm">
        <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div class="d-flex gap-2">
                    <!-- Share and Download buttons - disabled until approval -->
                    <button id="btn-share" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#shareModal"
                        {% if not is_approved %}disabled{% endif %}>
                        <i class="ph-bold ph-share-network me-2"></i> Compartilhar
                    </button>

                    <button id="btn-download" class="btn btn-outline-primary"
                        onclick="window.open('/download_revised_pdf/{{ inspection.drive_file_id }}', '_blank')"
                        {% if not is_approved %}disabled{% endif %}>
                        <i class="ph-bold ph-file-pdf me-2"></i> Baixar Relatório
                    </button>
                </div>
                <div>
                    {% if is_locked %}
                    <button class="btn btn-success px-4" disabled>
                        <i class="ph-bold ph-check me-2"></i> Plano Validado
                    </button>
                    {% else %}
                    {% if current_user.role != 'CONSULTANT' %}
                    <button class="btn btn-primary px-4 fw-bold" onclick="approvePlan()" id="btn-approve">
                        <i class="ph-bold ph-check-circle me-2"></i> Aprovar Plano
                    </button>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="border-bottom: 2px solid #e2e8f0;">
                <h5 class="modal-title fw-bold">Compartilhar Plano de Ação</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body px-4 py-4">
                <!-- Responsável da Loja -->
                <div class="mb-4 p-3 bg-light rounded border">
                    <h6 class="fw-bold text-muted text-uppercase mb-3" style="font-size: 0.75rem; letter-spacing: 0.5px;">Responsável da Loja</h6>
                    <div class="row g-2">
                        <div class="col-12">
                            <input type="text" id="shareRespName" class="form-control form-control-sm" placeholder="Nome do responsável"
                                value="{{ recipients[0].name if recipients else '' }}">
                        </div>
                        <div class="col-6">
                            <input type="tel" id="shareRespPhone" class="form-control form-control-sm" placeholder="Telefone (DDD + Numero)"
                                value="{{ recipients[0].phone if recipients and recipients[0].phone else '' }}">
                        </div>
                        <div class="col-6">
                            <input type="email" id="shareRespEmail" class="form-control form-control-sm" placeholder="Email"
                                value="{{ recipients[0].email if recipients and recipients[0].email else '' }}">
                        </div>
                        <div class="col-12 mt-2">
                            <button class="btn btn-sm btn-outline-secondary w-100" onclick="saveResponsible()">
                                <i class="ph-bold ph-floppy-disk me-1"></i> Salvar Dados do Responsável
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Envio -->
                <h6 class="fw-bold text-muted text-uppercase mb-3" style="font-size: 0.75rem; letter-spacing: 0.5px;">Enviar via</h6>
                <ul class="nav nav-pills mb-3" id="shareTabs" role="tablist" style="gap: 0.5rem;">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active px-4 py-2" id="whatsapp-tab" data-bs-toggle="tab"
                            data-bs-target="#whatsapp" type="button" role="tab" aria-selected="true"
                            style="border-radius: 8px; font-size: 0.9rem;">
                            <i class="ph-bold ph-whatsapp-logo me-2"></i>WhatsApp
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link px-4 py-2" id="email-tab" data-bs-toggle="tab" data-bs-target="#email"
                            type="button" role="tab" aria-selected="false"
                            style="border-radius: 8px; font-size: 0.9rem;">
                            <i class="ph-bold ph-envelope-simple me-2"></i>Email
                        </button>
                    </li>
                </ul>

                <div class="tab-content pt-2 pb-1" id="shareTabContent">
                    <!-- WhatsApp Tab -->
                    <div class="tab-pane fade show active" id="whatsapp" role="tabpanel" aria-labelledby="whatsapp-tab">
                        <p class="text-muted mb-3" style="font-size: 0.85rem;">Uma mensagem com o link do relatorio sera enviada via WhatsApp Business API.</p>
                        <button class="btn btn-success w-100 py-2" onclick="sendWhatsApp()" style="font-size: 0.95rem;">
                            <i class="ph-bold ph-whatsapp-logo me-2"></i> Enviar via WhatsApp
                        </button>
                    </div>

                    <!-- Email Tab -->
                    <div class="tab-pane fade" id="email" role="tabpanel" aria-labelledby="email-tab">
                        <p class="text-muted mb-3" style="font-size: 0.85rem;">Um email sera enviado com o link do relatorio.</p>
                        <button class="btn btn-primary w-100 py-2" onclick="sendEmail()" style="font-size: 0.95rem;">
                            <i class="ph-bold ph-envelope-simple me-2"></i> Enviar via Email
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<style>
    /* Minimal safe overrides */
    .accordion-button:not(.collapsed) {
        background-color: #f8f9fa;
        color: #212529;
        box-shadow: none;
    }

    .accordion-button:focus {
        box-shadow: none;
        border-color: rgba(0, 0, 0, .125);
    }

    /* Hide arrow for non-expandable conforme areas */
    .accordion-button[style*="cursor: default"]::after {
        display: none;
    }

    /* High Contrast Warning Button for Consultant (and potentially Manager if used) */
    .btn-outline-warning {
        color: #d97706 !important;
        /* Amber 600 - High Contrast */
        border-color: #d97706 !important;
    }

    .btn-outline-warning:hover,
    .btn-check:checked+.btn-outline-warning {
        background-color: #d97706 !important;
        color: white !important;
    }

    /* Auto-save Feedback styles */
    .modified-field {
        border-left: 3px solid #2563eb !important;
        /* Blue indicator for edited */
        background-color: #eff6ff;
    }

    .status-saved {
        color: #10b981;
        font-size: 0.75rem;
        font-weight: 600;
        animation: fadeIn 0.3s;
    }

    .status-saving {
        color: #64748b;
        font-size: 0.75rem;
        animation: pulse 1s infinite;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @keyframes pulse {
        0% {
            opacity: 0.6;
        }

        50% {
            opacity: 1;
        }

        100% {
            opacity: 0.6;
        }
    }
</style>

<script>
    const INSPECTION_FILE_ID = "{{ inspection.drive_file_id }}";

    function markAsModified(input) {
        if (input.value !== input.dataset.original) {
            input.classList.add('modified-field');
        } else {
            input.classList.remove('modified-field');
        }
    }

    async function autoSaveItem(input) {
        // Only save if modified
        if (input.value === input.dataset.original) return;

        const container = input.parentElement;
        const indicator = container.querySelector('.status-indicator');
        const itemId = input.dataset.itemId;

        // Show saving state
        indicator.innerHTML = '<span class="status-saving"><i class="ph-bold ph-arrows-clockwise"></i> Salvando...</span>';

        // Prepare Payload
        // We send a partial update for this item
        const payload = {
            items: [{
                id: itemId,
                // Determine field name based on input hierarchy? 
                // Or just send both potential fields, only one will change.
                // Actually safer to check which input it is.
                // Checking dataset or just sending context...
                // Simplification for MVP: We send the changed value based on mapping.
            }]
        };

        // Simple logic: check if it's "action" (textarea) or "deadline" (input)
        if (input.tagName === 'TEXTAREA') {
            payload.items[0].action = input.value;
        } else {
            payload.items[0].deadline = input.value;
        }

        try {
            const response = await fetch(`/manager/plan/${INSPECTION_FILE_ID}/save`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': "{{ csrf_token() if csrf_token else '' }}"
                },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                // success
                indicator.innerHTML = '<span class="status-saved"><i class="ph-bold ph-check"></i> Salvo</span>';
                input.dataset.original = input.value; // Update original to prevent re-save
                setTimeout(() => {
                    indicator.innerHTML = '<span class="status-saved" style="opacity:0.7"><i class="ph-fill ph-check-circle"></i></span>';
                }, 2000);
            } else {
                indicator.innerHTML = '<span class="text-danger small">Erro ao salvar</span>';
            }
        } catch (e) {
            console.error(e);
            indicator.innerHTML = '<span class="text-danger small">Erro de conexão</span>';
        }
    }

    async function approvePlan() {
        if (!confirm('Tem certeza que deseja aprovar este plano? Isso notificará o consultor.')) return;

        const btn = document.getElementById('btn-approve');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processando...';
        btn.disabled = true;

        try {
            const response = await fetch(`/manager/plan/${INSPECTION_FILE_ID}/approve`, {
                method: 'POST',
                headers: { 'X-CSRFToken': "{{ csrf_token() if csrf_token else '' }}" }
            });

            if (response.ok) {
                // Update UI in-place (stay on same page for sharing/download)
                btn.innerHTML = '<i class="ph-bold ph-check me-2"></i> Plano Validado';
                btn.className = 'btn btn-success px-4';
                btn.disabled = true;
                btn.removeAttribute('onclick');

                // Enable Share and Download buttons
                const btnShare = document.getElementById('btn-share');
                const btnDownload = document.getElementById('btn-download');
                if (btnShare) btnShare.removeAttribute('disabled');
                if (btnDownload) btnDownload.removeAttribute('disabled');

                // Success feedback
                const toast = document.createElement('div');
                toast.className = 'alert alert-success shadow-sm';
                toast.style.cssText = 'position:fixed;top:20px;right:20px;z-index:9999;min-width:300px;animation:fadeIn 0.3s;';
                toast.innerHTML = '<i class="ph-bold ph-check-circle me-2"></i> Plano Aprovado com Sucesso! Agora você pode compartilhar ou baixar o relatório.';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 5000);
            } else {
                const err = await response.json();
                alert('Erro ao aprovar: ' + (err.error || 'Erro desconhecido'));
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        } catch (e) {
            alert('Erro de conexão.');
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
    // --- Sharing Widget Logic ---
    async function saveResponsible() {
        const name = document.getElementById('shareRespName').value;
        const phone = document.getElementById('shareRespPhone').value;
        const email = document.getElementById('shareRespEmail').value;

        if (!name && !phone && !email) return alert('Preencha ao menos um campo.');

        try {
            const response = await fetch(`/manager/plan/${INSPECTION_FILE_ID}/save`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
                body: JSON.stringify({
                    responsible_name: name,
                    responsible_phone: phone,
                    responsible_email: email,
                    items: []
                })
            });
            if (response.ok) {
                alert('Dados do responsável salvos!');
            } else {
                alert('Erro ao salvar dados do responsável.');
            }
        } catch (e) {
            alert('Erro de conexão.');
        }
    }

    async function sendWhatsApp() {
        const phone = document.getElementById('shareRespPhone').value;
        const name = document.getElementById('shareRespName').value || "Responsável";

        if (!phone || phone.replace(/\D/g, '').length === 0) return alert('Preencha o telefone do responsável.');

        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enviando...';
        btn.disabled = true;

        try {
            const response = await fetch(`/api/whatsapp_plan/${INSPECTION_FILE_ID}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}'},
                body: JSON.stringify({phone: phone, name: name})
            });
            const result = await response.json();

            if (response.ok) {
                btn.innerHTML = '<i class="ph-bold ph-check me-2"></i>Enviado!';
                btn.classList.replace('btn-success', 'btn-outline-success');
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.replace('btn-outline-success', 'btn-success');
                    btn.disabled = false;
                }, 3000);
            } else {
                alert(result.error || 'Erro ao enviar WhatsApp.');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        } catch (e) {
            alert('Erro de conexão ao enviar WhatsApp.');
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    async function sendEmail() {
        const email = document.getElementById('shareRespEmail').value;
        const name = document.getElementById('shareRespName').value || "Responsável";

        if (!email) return alert('Preencha o email do responsável.');

        const originalText = event.target.innerHTML;
        event.target.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enviando...';
        event.target.disabled = true;

        try {
            const response = await fetch(`/api/email_plan/${INSPECTION_FILE_ID}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': "{{ csrf_token() if csrf_token else '' }}"
                },
                body: JSON.stringify({
                    target_email: email,
                    target_name: name
                })
            });

            const data = await response.json();
            if (response.ok) {
                alert('Email enviado com sucesso!');
                const modal = bootstrap.Modal.getInstance(document.getElementById('shareModal'));
                modal.hide();
            } else {
                alert('Erro: ' + (data.error || 'Falha no envio'));
            }
        } catch (e) {
            alert('Erro de conexão.');
        } finally {
            event.target.innerHTML = originalText;
            event.target.disabled = false;
        }
    }
</script>
{% endblock %}