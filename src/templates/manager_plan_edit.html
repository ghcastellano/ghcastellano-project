{% extends "layout.html" %}

{% block title %}Validação do Plano (Gestor){% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Process Status Stepper -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body py-3 px-4">
                    <div class="d-flex justify-content-between align-items-center position-relative">
                        <!-- Progress Line -->
                        <div class="position-absolute w-100"
                            style="top: 15px; left: 0; height: 2px; background: #e9ecef; z-index: 0;"></div>

                        <!-- Step 1: Gestor (Active) -->
                        <div class="text-center position-relative bg-white px-2" style="z-index: 2;">
                            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center mx-auto mb-2 shadow-sm"
                                style="width: 32px; height: 32px; font-weight: bold;">1</div>
                            <span class="d-block text-xs font-weight-bold text-primary text-uppercase"
                                style="font-size: 0.7rem;">Validação</span>
                        </div>

                        <!-- Step 2: Consultor -->
                        <div class="text-center position-relative bg-white px-2" style="z-index: 2;">
                            <div class="rounded-circle bg-white border d-flex align-items-center justify-content-center mx-auto mb-2"
                                style="width: 32px; height: 32px; color: #adb5bd;">2</div>
                            <span class="d-block text-xs font-weight-bold text-muted text-uppercase"
                                style="font-size: 0.7rem;">Visita</span>
                        </div>

                        <!-- Step 3: Conclusão -->
                        <div class="text-center position-relative bg-white px-2" style="z-index: 2;">
                            <div class="rounded-circle bg-white border d-flex align-items-center justify-content-center mx-auto mb-2"
                                style="width: 32px; height: 32px; color: #adb5bd;">3</div>
                            <span class="d-block text-xs font-weight-bold text-muted text-uppercase"
                                style="font-size: 0.7rem;">Fim</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Standard Header -->
    <div class="row align-items-center mb-4">
        <div class="col-md-8 d-flex align-items-center">
            <a href="{{ url_for('manager.dashboard_manager') if current_user.role == 'MANAGER' else url_for('root') }}"
                class="btn btn-link text-decoration-none text-muted p-0 me-3">
                <i class="ph-bold ph-arrow-left fa-lg"></i>
            </a>
            <div>
                <h1 class="h3 mb-1 text-gray-800">Validação do Plano</h1>
                <p class="text-muted mb-0">
                    {{ report_data.nome_estabelecimento }} • {{ report_data.data_inspecao }}
                </p>
            </div>
        </div>
        <div class="col-md-4 text-end">
            <div class="card border-0 shadow-sm d-inline-block">
                <div class="card-body py-2 px-3">
                    <span class="text-xs font-weight-bold text-muted text-uppercase d-block">Aproveitamento</span>
                    <span
                        class="h2 font-weight-bold {% if report_data.aproveitamento_geral >= 70 %}text-success{% else %}text-danger{% endif %} mb-0">
                        {{ report_data.aproveitamento_geral }}%
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Card -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white py-3">
            <h5 class="m-0 font-weight-bold text-primary">Resumo Executivo</h5>
        </div>
        <div class="card-body">
            <p class="text-muted mb-4">{{ report_data.resumo_geral }}</p>

            <div class="table-responsive">
                <table class="table table-bordered table-hover mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th>Área Auditada</th>
                            <th class="text-center">Pontuação</th>
                            <th class="text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for area in report_data.areas_inspecionadas %}
                        <tr>
                            <td class="align-middle fw-bold text-dark">{{ area.nome_area }}</td>
                            <td class="align-middle text-center">{{ area.pontuacao_obtida }} / {{ area.pontuacao_maxima
                                }}</td>
                            <td class="align-middle text-center">
                                {% if area.aproveitamento >= 100 %}
                                <span class="badge bg-success">Conforme ({{ area.aproveitamento }}%)</span>
                                {% elif area.aproveitamento > 0 %}
                                <span class="badge bg-warning text-dark">Parcialmente Conforme ({{ area.aproveitamento
                                    }}%)</span>
                                {% else %}
                                <span class="badge bg-danger">Não Conforme ({{ area.aproveitamento }}%)</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Details Section -->
    <h4 class="mb-3 text-gray-800">Detalhamento e Ações</h4>
    {# Safe access to status regardless of type (Enum/String/Dict) #}
    {% set status_raw = inspection.status if inspection.status is defined else 'PENDING' %}
    {% set status_name = status_raw.name if status_raw.name is defined else status_raw|string %}
    {% set is_locked = (status_name == 'APPROVED' or status_name == 'COMPLETED') %}

    <div class="accordion shadow-sm" id="accordionAreas">
        {% for area in report_data.areas_inspecionadas %}
        {% if area.items_nc > 0 %}
        <div class="accordion-item mb-3 border rounded overflow-hidden">
            <h2 class="accordion-header" id="heading{{ loop.index }}">
                <button class="accordion-button collapsed bg-white text-dark fw-bold" type="button"
                    data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}">
                    <div class="d-flex align-items-center w-100 me-3">
                        <span class="me-auto">{{ area.nome_area }}</span>
                        <span class="badge bg-light text-dark border me-2">{{ area.items_nc }} apontamentos</span>
                    </div>
                </button>
            </h2>
            <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#accordionAreas">
                <div class="accordion-body bg-light p-4">
                    {% for item in area.itens %}
                    {# Filter out conforming items #}
                    {% if item.status != 'Conforme' %}
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                            <div>
                                <h6 class="m-0 font-weight-bold text-dark">{{ item.item_verificado }}</h6>
                                <small class="text-muted">{{ item.fundamento_legal }}</small>
                            </div>
                            <div>
                                {% if 'parcial' in (item.status or '')|lower or (item.pontuacao|float > 0 and
                                item.pontuacao|float < area.pontuacao_maxima_item|default(10)|float) %} <span
                                    class="badge bg-warning text-dark rounded-pill px-3">Parcialmente Conforme</span>
                                    {% else %}
                                    <span class="badge bg-danger rounded-pill px-3">Não Conforme</span>
                                    {% endif %}
                                    <span class="badge bg-secondary rounded-pill ms-1">{{ item.pontuacao }} PTS</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row g-0">
                                <!-- Problem Section -->
                                <div class="col-md-5 pe-md-4 mb-3 mb-md-0 border-end">
                                    <label class="text-xs fw-bold text-muted text-uppercase mb-2">Problema
                                        Identificado</label>
                                    <div
                                        class="p-3 bg-danger bg-opacity-10 border border-danger border-opacity-25 rounded text-danger">
                                        {{ item.observacao }}
                                    </div>
                                </div>

                                <!-- Action Section -->
                                <div class="col-md-7 ps-md-4">
                                    <div class="mb-3">
                                        <label class="text-xs fw-bold text-muted text-uppercase mb-2">Ação Corretiva
                                            Sugerida</label>
                                        <div class="position-relative">
                                            <textarea class="form-control" rows="3"
                                                data-original="{{ item.acao_corretiva_sugerida }}"
                                                data-item-id="{{ item.id }}" oninput="markAsModified(this)"
                                                onblur="autoSaveItem(this)" {% if is_locked %}disabled{% endif
                                                %}>{{ item.acao_corretiva_sugerida }}</textarea>
                                            {% if not is_locked %}
                                            <div class="status-indicator position-absolute bottom-0 end-0 m-2"></div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="row align-items-center">
                                        <label
                                            class="col-auto col-form-label text-xs fw-bold text-muted text-uppercase">Prazo:</label>
                                        <div class="col position-relative">
                                            <input type="text" class="form-control" value="{{ item.prazo_sugerido }}"
                                                data-original="{{ item.prazo_sugerido }}" data-item-id="{{ item.id }}"
                                                oninput="markAsModified(this)" onblur="autoSaveItem(this)" {% if
                                                is_locked %}disabled{% endif %}>
                                            {% if not is_locked %}
                                            <div
                                                class="status-indicator position-absolute top-50 end-0 translate-middle-y me-3">
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>

    <!-- Actions Area -->
    <div class="card mt-5 mb-5 border-0 bg-white shadow-sm">
        <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div class="d-flex gap-2">
                    <!-- [UX] Updated Share Widget -->
                    <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#shareModal">
                        <i class="ph-bold ph-share-network me-2"></i> Compartilhar
                    </button>

                    <button class="btn btn-outline-primary"
                        onclick="window.open('/download_revised_pdf/{{ inspection.drive_file_id }}', '_blank')">
                        <i class="ph-bold ph-file-pdf me-2"></i> Baixar Relatório
                    </button>
                </div>
                <div>
                    {% if is_locked %}
                    <button class="btn btn-success px-4" disabled>
                        <i class="ph-bold ph-check me-2"></i> Plano Validado
                    </button>
                    {% else %}
                    {% if current_user.role != 'CONSULTANT' %}
                    <button class="btn btn-primary px-4 fw-bold" onclick="approvePlan()" id="btn-approve">
                        <i class="ph-bold ph-check-circle me-2"></i> Aprovar Plano
                    </button>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Compartilhar Plano de Ação</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs mb-3" id="shareTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="whatsapp-tab" data-bs-toggle="tab"
                            data-bs-target="#whatsapp" type="button" role="tab" aria-selected="true">
                            <i class="ph-bold ph-whatsapp-logo me-2"></i>WhatsApp
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="email-tab" data-bs-toggle="tab" data-bs-target="#email"
                            type="button" role="tab" aria-selected="false">
                            <i class="ph-bold ph-envelope-simple me-2"></i>Email
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="shareTabContent">
                    <!-- WhatsApp Tab -->
                    <div class="tab-pane fade show active" id="whatsapp" role="tabpanel" aria-labelledby="whatsapp-tab">
                        <div class="list-group mb-3">
                            <label class="list-group-item">
                                <input class="form-check-input me-1" type="radio" name="waRecipient" value="custom"
                                    checked onchange="toggleCustom('wa', true)">
                                Outro número
                            </label>
                            {% for r in recipients %}
                            {% if r.phone %}
                            <label class="list-group-item">
                                <input class="form-check-input me-1" type="radio" name="waRecipient"
                                    value="{{ r.phone }}" data-name="{{ r.name }}" onchange="toggleCustom('wa', false)">
                                <div class="d-inline-block align-middle ms-2">
                                    <strong>{{ r.name }}</strong> <span class="badge bg-light text-dark ms-1">{{ r.role
                                        }}</span><br>
                                    <small class="text-muted">{{ r.phone }}</small>
                                </div>
                            </label>
                            {% endif %}
                            {% endfor %}
                        </div>
                        <div id="waCustomInput">
                            <label class="form-label text-xs fw-bold text-uppercase">Número do WhatsApp (DDD +
                                Número)</label>
                            <input type="text" id="customPhone" class="form-control" placeholder="Ex: 11999999999">
                        </div>
                        <button class="btn btn-success w-100 mt-3" onclick="sendWhatsApp()">
                            Enviar WhatsApp <i class="ph-bold ph-paper-plane-right ms-2"></i>
                        </button>
                    </div>

                    <!-- Email Tab -->
                    <div class="tab-pane fade" id="email" role="tabpanel" aria-labelledby="email-tab">
                        <div class="list-group mb-3">
                            <label class="list-group-item">
                                <input class="form-check-input me-1" type="radio" name="emailRecipient" value="custom"
                                    checked onchange="toggleCustom('email', true)">
                                Outro email
                            </label>
                            {% for r in recipients %}
                            {% if r.email %}
                            <label class="list-group-item">
                                <input class="form-check-input me-1" type="radio" name="emailRecipient"
                                    value="{{ r.email }}" data-name="{{ r.name }}"
                                    onchange="toggleCustom('email', false)">
                                <div class="d-inline-block align-middle ms-2">
                                    <strong>{{ r.name }}</strong> <span class="badge bg-light text-dark ms-1">{{ r.role
                                        }}</span><br>
                                    <small class="text-muted">{{ r.email }}</small>
                                </div>
                            </label>
                            {% endif %}
                            {% endfor %}
                        </div>
                        <div id="emailCustomInput">
                            <label class="form-label text-xs fw-bold text-uppercase">Email do Destinatário</label>
                            <input type="email" id="customEmail" class="form-control" placeholder="nome@exemplo.com">
                        </div>
                        <button class="btn btn-primary w-100 mt-3" onclick="sendEmail()">
                            Enviar Email <i class="ph-bold ph-paper-plane-right ms-2"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<style>
    /* Minimal safe overrides */
    .accordion-button:not(.collapsed) {
        background-color: #f8f9fa;
        color: #212529;
        box-shadow: none;
    }

    .accordion-button:focus {
        box-shadow: none;
        border-color: rgba(0, 0, 0, .125);
    }

    /* High Contrast Warning Button for Consultant (and potentially Manager if used) */
    .btn-outline-warning {
        color: #d97706 !important;
        /* Amber 600 - High Contrast */
        border-color: #d97706 !important;
    }

    .btn-outline-warning:hover,
    .btn-check:checked+.btn-outline-warning {
        background-color: #d97706 !important;
        color: white !important;
    }

    /* Auto-save Feedback styles */
    .modified-field {
        border-left: 3px solid #2563eb !important;
        /* Blue indicator for edited */
        background-color: #eff6ff;
    }

    .status-saved {
        color: #10b981;
        font-size: 0.75rem;
        font-weight: 600;
        animation: fadeIn 0.3s;
    }

    .status-saving {
        color: #64748b;
        font-size: 0.75rem;
        animation: pulse 1s infinite;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @keyframes pulse {
        0% {
            opacity: 0.6;
        }

        50% {
            opacity: 1;
        }

        100% {
            opacity: 0.6;
        }
    }
</style>

<script>
    const INSPECTION_FILE_ID = "{{ inspection.drive_file_id }}";

    function markAsModified(input) {
        if (input.value !== input.dataset.original) {
            input.classList.add('modified-field');
        } else {
            input.classList.remove('modified-field');
        }
    }

    async function autoSaveItem(input) {
        // Only save if modified
        if (input.value === input.dataset.original) return;

        const container = input.parentElement;
        const indicator = container.querySelector('.status-indicator');
        const itemId = input.dataset.itemId;

        // Show saving state
        indicator.innerHTML = '<span class="status-saving"><i class="ph-bold ph-arrows-clockwise"></i> Salvando...</span>';

        // Prepare Payload
        // We send a partial update for this item
        const payload = {
            items: [{
                id: itemId,
                // Determine field name based on input hierarchy? 
                // Or just send both potential fields, only one will change.
                // Actually safer to check which input it is.
                // Checking dataset or just sending context...
                // Simplification for MVP: We send the changed value based on mapping.
            }]
        };

        // Simple logic: check if it's "action" (textarea) or "deadline" (input)
        if (input.tagName === 'TEXTAREA') {
            payload.items[0].action = input.value;
        } else {
            payload.items[0].deadline = input.value;
        }

        try {
            const response = await fetch(`/manager/plan/${INSPECTION_FILE_ID}/save`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': "{{ csrf_token() if csrf_token else '' }}"
                },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                // success
                indicator.innerHTML = '<span class="status-saved"><i class="ph-bold ph-check"></i> Salvo</span>';
                input.dataset.original = input.value; // Update original to prevent re-save
                setTimeout(() => {
                    indicator.innerHTML = '<span class="status-saved" style="opacity:0.7"><i class="ph-fill ph-check-circle"></i></span>';
                }, 2000);
            } else {
                indicator.innerHTML = '<span class="text-danger small">Erro ao salvar</span>';
            }
        } catch (e) {
            console.error(e);
            indicator.innerHTML = '<span class="text-danger small">Erro de conexão</span>';
        }
    }

    async function approvePlan() {
        if (!confirm('Tem certeza que deseja aprovar este plano? Isso notificará o consultor.')) return;

        const btn = document.getElementById('btn-approve');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processando...';
        btn.disabled = true;

        try {
            // We reuse the save endpoint or a dedicated approval endpoint?
            // "save_plan" route checks for "approved" status but doesn't transition it.
            // We need an endpoint to transition to APPROVED/PENDING_VERIFICATION.
            // Let's use a new endpoint or a flag in save.
            // For now, let's call a new endpoint '/manager/plan/<id>/approve' (Need to create it or find it).
            // Checking manager_routes... there is no specific approve route visible in previous read.
            // I will create one or use 'save' with a special flag if permitted.
            // Best practice: Dedicated route. I will use '/manager/review/approve' if it exists or create '/manager/plan/<id>/approve'.
            // For now, I'll mock the URL and implement the backend route next.

            const response = await fetch(`/manager/plan/${INSPECTION_FILE_ID}/approve`, {
                method: 'POST',
                headers: { 'X-CSRFToken': "{{ csrf_token() if csrf_token else '' }}" }
            });

            if (response.ok) {
                alert('Plano Aprovado com Sucesso!');
                window.location.reload();
            } else {
                const err = await response.json();
                alert('Erro ao aprovar: ' + (err.error || 'Erro desconhecido'));
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        } catch (e) {
            alert('Erro de conexão.');
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
    // --- Sharing Widget Logic ---
    function toggleCustom(type, isCustom) {
        const inputDiv = document.getElementById(type === 'wa' ? 'waCustomInput' : 'emailCustomInput');
        inputDiv.style.display = isCustom ? 'block' : 'none';
    }

    function sendWhatsApp() {
        const selected = document.querySelector('input[name="waRecipient"]:checked');
        if (!selected) return alert('Selecione um destinatário.');

        let phone = selected.value;
        let name = "Responsável";

        if (phone === 'custom') {
            phone = document.getElementById('customPhone').value;
            name = "Responsável";
        } else {
            name = selected.dataset.name || "Responsável";
        }

        // Clean Phone
        phone = phone.replace(/\D/g, '');
        if (phone.length === 0) return alert('Telefone inválido.');
        if (phone.length <= 11) phone = '55' + phone;

        const downloadUrl = "{{ url_for('download_revised_pdf', file_id=inspection.drive_file_id, _external=True) }}";
        const msg = `Olá ${name}, segue o link do seu Plano de Ação: ${downloadUrl}`;

        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');

        // Optional: Close modal
        // const modal = bootstrap.Modal.getInstance(document.getElementById('shareModal'));
        // modal.hide();
    }

    async function sendEmail() {
        const selected = document.querySelector('input[name="emailRecipient"]:checked');
        if (!selected) return alert('Selecione um destinatário.');

        let email = selected.value;
        let name = "Responsável";

        if (email === 'custom') {
            email = document.getElementById('customEmail').value;
            name = "Responsável";
            if (!email) return alert('Digite um email.');
        } else {
            name = selected.dataset.name || "Responsável";
        }

        const originalText = event.target.innerHTML;
        event.target.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enviando...';
        event.target.disabled = true;

        try {
            const response = await fetch(`/api/email_plan/${INSPECTION_FILE_ID}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': "{{ csrf_token() if csrf_token else '' }}"
                },
                body: JSON.stringify({
                    target_email: email,
                    target_name: name
                })
            });

            const data = await response.json();
            if (response.ok) {
                alert('Email enviado com sucesso!');
                const modal = bootstrap.Modal.getInstance(document.getElementById('shareModal'));
                modal.hide();
            } else {
                alert('Erro: ' + (data.error || 'Falha no envio'));
            }
        } catch (e) {
            alert('Erro de conexão.');
        } finally {
            event.target.innerHTML = originalText;
            event.target.disabled = false;
        }
    }
</script>
{% endblock %}