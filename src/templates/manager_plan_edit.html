{% extends "layout.html" %}

{% block title %}Verificar e Validar Plano | InspetorAI{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem;">
        <div>
            <a href="{{ url_for('manager.dashboard_manager') }}" class="text-muted text-sm"
                style="text-decoration: none;">
                <i class="ph ph-arrow-left"></i> Voltar ao Dashboard
            </a>
            <h1 class="page-title" style="margin-top: 0.5rem;">Verificar e Validar Plano</h1>
            <p class="text-muted">
                <strong>Estabelecimento:</strong> {{ inspection.establishment.name or 'Estabelecimento Desconhecido' }}
                •
                {{ inspection.created_at.strftime('%d/%m/%Y') }}
            </p>
        </div>
        <div style="text-align: right;">
            <div id="saveStatus" class="text-sm text-muted"
                style="margin-bottom: 0.5rem; opacity: 0; transition: opacity 0.3s;">
                Alterações salvas
            </div>
            {% if inspection.status.name != 'APPROVED' %}
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-secondary" onclick="savePlan(false)">
                    <i class="ph-bold ph-floppy-disk"></i> Salvar Validação
                </button>
                <button class="btn btn-success" onclick="openApprovalModal()">
                    <i class="ph-bold ph-whatsapp-logo"></i> Validar & Publicar
                </button>
            </div>
            {% else %}
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-success" onclick="openApprovalModal()">
                    <i class="ph-bold ph-whatsapp-logo"></i> Re-compartilhar WhatsApp
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Stats/Context -->
    <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 2rem;">
        <div class="stat-card">
            <span class="stat-label">Total de Itens</span>
            <span class="stat-value" id="totalItems">{{ plan.items|length }}</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Itens Críticos</span>
            <span class="stat-value" style="color: var(--danger-color);">
                {% set critical_count = 0 %}
                {% for item in plan.items %}
                {% if item.severity.name == 'CRITICAL' or item.severity == 'CRITICAL' %}
                {% set critical_count = critical_count + 1 %}
                {% endif %}
                {% endfor %}
                {{ critical_count }}
            </span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Aproveitamento Geral</span>
            <span class="stat-value"
                style="color: {% if plan.stats_json.get('percentage', 0) >= 90 %}var(--success-color){% elif plan.stats_json.get('percentage', 0) >= 70 %}var(--warning-color){% else %}var(--danger-color){% endif %};">
                {{ plan.stats_json.get('percentage', 0) }}%
            </span>
            <div class="text-xs text-muted">Nota: {{ plan.stats_json.get('score', 0) }} / {{
                plan.stats_json.get('max_score', 0) }}</div>
        </div>
        <!-- Status com cores fixas -->
        <div class="stat-card">
            <span class="stat-label">Status</span>
            {% if 'APPROVED' in inspection.status.name %}
            <span class="badge" style="background: #dcfce7; color: #166534; font-size: 1rem;">APROVADO</span>
            {% elif 'WAITING' in inspection.status.name %}
            <span class="badge" style="background: #fef9c3; color: #854d0e; font-size: 1rem;">EM ANÁLISE</span>
            {% else %}
            <span class="badge" style="background: #e2e8f0; color: #475569; font-size: 1rem;">{{ inspection.status.value
                }}</span>
            {% endif %}
        </div>
    </div>

    <!-- Area Breakdown Table (Rich Summary) -->
    {% if plan.stats_json and plan.stats_json.get('by_sector') %}
    <div class="card mb-4" style="margin-bottom: 2rem;">
        <div class="card-header">
            <h3 class="card-title">Resumo do Desempenho por Área</h3>
        </div>
        <div class="card-body" style="padding: 0;">
            <table class="table" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                        <th style="padding: 12px 1.5rem; text-align: left; width: 50%;">Área / Setor</th>
                        <th style="padding: 12px; text-align: center; width: 25%;">Nota / Máximo</th>
                        <th style="padding: 12px; text-align: center; width: 25%;">Aproveitamento</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sector_name, stats in plan.stats_json.get('by_sector', {}).items() %}
                    <tr style="border-bottom: 1px solid #f1f5f9;">
                        <td style="padding: 12px 1.5rem;">
                            <div style="font-weight: 600; color: #1e293b;">{{ sector_name }}</div>
                            <div style="font-size: 0.8rem; color: #64748b;">{{ stats.resumo_area }}</div>
                        </td>
                        <td style="padding: 12px; text-align: center;">{{ stats.pontuacao }} / {{ stats.maximo }}</td>
                        <td style="padding: 12px; text-align: center;">
                            <span class="badge"
                                style="background: {% if stats.aproveitamento >= 90 %}#dcfce7; color: #166534{% elif stats.aproveitamento >= 70 %}#fef9c3; color: #854d0e{% else %}#fee2e2; color: #991b1b{% endif %};">
                                {{ stats.aproveitamento }}%
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Summary & Strengths Section (READ ONLY) -->
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Resumo Geral da Inspeção</h3>
            </div>
            <div class="card-body">
                <div class="readonly-box">
                    {{ plan.summary_text or 'Sem resumo disponível.' }}
                </div>
                <!-- Hidden inputs for form preservation if needed, though simpler to just not edit -->
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Pontos Fortes</h3>
            </div>
            <div class="card-body">
                <div class="readonly-box">
                    {{ plan.strengths_text or 'Nenhum ponto forte registrado.' }}
                </div>
            </div>
        </div>
    </div>

    <!-- Editable Grid (Grouped by Sector) -->
    <div id="planItemsContainer">
        <!-- JS will render groups here -->
    </div>

    <!-- Hidden Data for JS -->
    <script>
        // Pass data safely to JS
        const PLAN_DATA = [
            {% for item in plan.items %}
        {
            id: "{{ item.id }}",
                problem: `{{ item.problem_description.replace('`', '').replace('"', "'") }}`,
            correction: `{{ item.corrective_action.replace('`', '').replace('"', "'") }}`,
            deadline: "{{ item.ai_suggested_deadline or 'Imediato' }}",
                deadline_date: "{{ item.deadline_date }}",
                    severity: "{{ item.severity.name if item.severity.name else item.severity }}",
                        status: "{{ item.status.name }}",
                            sector: "{{ item.sector or 'Geral' }}",
                                notes: `{{ item.manager_notes or '' }}`
        },
        {% endfor %}
        ];
    </script>
</div>

<!-- Add Item Modal (Simplified) -->
<div id="addModal" class="modal-overlay" style="display: none;">
    <div class="modal-content glass-panel" style="max-width: 600px; width: 90%;">
        <h3>Adicionar Item Manual</h3>
        <input type="text" id="newSector" class="form-control mb-2" placeholder="Setor (ex: Cozinha)">
        <input type="text" id="newProblem" class="form-control mb-2" placeholder="Descrição do Problema">
        <textarea id="newAction" class="form-control mb-2" placeholder="Ação Corretiva"></textarea>
        <div style="text-align: right; margin-top: 1rem;">
            <button class="btn btn-secondary" onclick="closeAddModal()">Cancelar</button>
            <button class="btn btn-primary" onclick="confirmAddItem()">Adicionar</button>
        </div>
    </div>
</div>

<!-- Styles -->
<style>
    .readonly-box {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 1rem;
        color: #475569;
        font-size: 0.95rem;
        line-height: 1.5;
        min-height: 100px;
    }

    .sector-group {
        margin-bottom: 2rem;
        background: white;
        border-radius: 16px;
        border: 1px solid #e2e8f0;
        overflow: hidden;
    }

    .sector-header {
        background: #f1f5f9;
        padding: 1rem 1.5rem;
        font-weight: 700;
        color: #1e293b;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .item-row {
        display: grid;
        grid-template-columns: 3fr 3fr 1.5fr 1fr;
        /* Problem | Action | Meta | Status */
        gap: 1.5rem;
        padding: 1.5rem;
        border-bottom: 1px solid #f1f5f9;
        transition: background 0.2s;
    }

    .item-row:last-child {
        border-bottom: none;
    }

    .item-row:hover {
        background: #fafafa;
    }

    .item-col h4 {
        margin: 0 0 0.5rem 0;
        font-size: 0.85rem;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .problem-text {
        font-weight: 500;
        color: #334155;
        font-size: 0.95rem;
    }

    /* Severity Indicators */
    .severity-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 6px;
    }

    .sev-CRITICAL {
        background: #ef4444;
        box-shadow: 0 0 0 2px #fee2e2;
    }

    .sev-HIGH {
        background: #f97316;
    }

    .sev-MEDIUM {
        background: #eab308;
    }

    .sev-LOW {
        background: #3b82f6;
    }

    /* Custom Form Controls for Edit grid */
    .edit-area {
        width: 100%;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 0.5rem;
        font-size: 0.9rem;
        color: #1e293b;
        resize: vertical;
        min-height: 60px;
    }

    .edit-area:focus {
        outline: 2px solid var(--accent-color);
        border-color: transparent;
    }
</style>

<script>
    // State
    let items = PLAN_DATA;

    function renderItems() {
        const container = document.getElementById('planItemsContainer');
        container.innerHTML = '';

        // Group by Sector
        const groups = {};
        items.forEach(item => {
            const sec = item.sector || 'Geral';
            if (!groups[sec]) groups[sec] = [];
            groups[sec].push(item);
        });

        // Render Groups
        Object.keys(groups).sort().forEach(sectorCode => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'sector-group';

            groupDiv.innerHTML = `
                <div class="sector-header">
                    <i class="ph ph-buildings"></i> ${sectorCode}
                </div>
            `;

            groups[sectorCode].forEach(item => {
                const row = document.createElement('div');
                row.className = 'item-row';

                // Color Logic
                let sevClass = `sev-${item.severity}`;
                let sevLabel = item.severity === 'CRITICAL' ? 'Crítico' :
                    item.severity === 'HIGH' ? 'Alto' :
                        item.severity === 'MEDIUM' ? 'Médio' : 'Baixo';

                // Deadline Display logic (Show raw string if not date, or clean format)
                let deadlineDisplay = item.deadline || 'Imediato';
                if (!deadlineDisplay.includes('dias') && !deadlineDisplay.includes('Imediato')) {
                    // Try to format if it looks like date? For now assume AI provides "7 dias" etc.
                }

                row.innerHTML = `
                    <div class="item-col">
                        <h4>Problema</h4>
                        <div style="display: flex; align-items: flex-start;">
                           <span class="severity-dot ${sevClass}" title="Gravidade: ${sevLabel}"></span>
                           <div class="problem-text">${item.problem}</div>
                        </div>
                    </div>
                    
                    <div class="item-col">
                        <h4>Ação Corretiva</h4>
                        <textarea class="edit-area" onchange="updateItem('${item.id}', 'correction', this.value)">${item.correction}</textarea>
                    </div>
                    
                    <div class="item-col">
                        <h4>Prazo & Notas</h4>
                        <input type="text" class="edit-area" style="min-height: auto; margin-bottom: 5px;" 
                               value="${deadlineDisplay}" 
                               onchange="updateItem('${item.id}', 'deadline', this.value)"
                               placeholder="Ex: 5 dias">
                        <textarea class="edit-area" placeholder="Notas do Gestor..." style="font-size: 0.8rem; min-height: 40px;"
                                  onchange="updateItem('${item.id}', 'notes', this.value)">${item.notes}</textarea>
                    </div>
                    
                    <div class="item-col" style="text-align: right;">
                        <button class="btn-icon ${item.status === 'RESOLVED' ? 'text-success' : 'text-muted'}" 
                                onclick="toggleStatus('${item.id}')"
                                title="Marcar como Resolvido">
                            <i class="ph-fill ph-check-circle" style="font-size: 1.5rem;"></i>
                        </button>
                    </div>
                `;
                groupDiv.appendChild(row);
            });

            container.appendChild(groupDiv);
        });

        // Botão Novo Item no final
        const addBtn = document.createElement('div');
        addBtn.style.textAlign = 'center';
        addBtn.style.marginTop = '1rem';
        addBtn.innerHTML = `
            <button class="btn btn-outline" style="border-style: dashed;" onclick="document.getElementById('addModal').style.display='flex'">
                <i class="ph ph-plus"></i> Adicionar Item Manual
            </button>
        `;
        container.appendChild(addBtn);
    }

    function updateItem(id, field, value) {
        const item = items.find(i => i.id === id);
        if (item) {
            item[field] = value;
            document.getElementById('saveStatus').style.opacity = '1';
            document.getElementById('saveStatus').innerText = 'Alterações não salvas...';
        }
    }

    function toggleStatus(id) {
        const item = items.find(i => i.id === id);
        if (item) {
            item.status = item.status === 'RESOLVED' ? 'OPEN' : 'RESOLVED';
            renderItems(); // Re-render to update icon color
            document.getElementById('saveStatus').style.opacity = '1';
            document.getElementById('saveStatus').innerText = 'Alterações não salvas...';
        }
    }

    async function savePlan(silent = false) {
        const btn = document.querySelector('button[onclick="savePlan(false)"]');
        if (!silent) {
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Salvando...';
        }

        try {
            const payload = {
                items: items.map(i => ({
                    id: i.id,
                    corrective_action: i.correction,
                    ai_suggested_deadline: i.deadline,
                    manager_notes: i.notes,
                    status: i.status
                }))
            };

            const res = await fetch(window.location.href, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                if (!silent) alert('Salvo com sucesso!');
                document.getElementById('saveStatus').innerText = 'Salvo ✅';
                setTimeout(() => document.getElementById('saveStatus').style.opacity = '0', 3000);
            } else {
                alert('Erro ao salvar.');
            }
        } catch (e) {
            console.error(e);
            alert('Erro de conexão.');
        } finally {
            if (!silent) {
                btn.disabled = false;
                btn.innerHTML = '<i class="ph-bold ph-floppy-disk"></i> Salvar Validação';
            }
        }
    }

    // Initial Render
    renderItems();
</script>
{% endblock %}