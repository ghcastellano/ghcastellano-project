{% extends "layout.html" %}

{% block title %}Verificar e Validar Plano | InspetorAI{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem;">
        <div>
            <a href="{{ url_for('manager.dashboard_manager') }}" class="text-muted text-sm"
                style="text-decoration: none;">
                <i class="ph ph-arrow-left"></i> Voltar ao Dashboard
            </a>
            <h1 class="page-title" style="margin-top: 0.5rem;">Verificar e Validar Plano</h1>
            <p class="text-muted">
                <strong>Estabelecimento:</strong> {{ inspection.establishment.name or 'Estabelecimento Desconhecido' }}
                •
                {{ inspection.created_at.strftime('%d/%m/%Y') }}
            </p>
        </div>
        <div style="text-align: right;">
            <div id="saveStatus" class="text-sm text-muted"
                style="margin-bottom: 0.5rem; opacity: 0; transition: opacity 0.3s;">
                Alterações salvas
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-secondary" onclick="savePlan(false)">
                    <i class="ph-bold ph-floppy-disk"></i> Salvar Validação
                </button>
                <button class="btn btn-success" onclick="openApprovalModal()">
                    <i class="ph-bold ph-whatsapp-logo"></i> Validar & Publicar
                </button>
            </div>
        </div>
    </div>

    <!-- Stats/Context -->
    <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 2rem;">
        <div class="stat-card">
            <span class="stat-label">Total de Itens</span>
            <span class="stat-value" id="totalItems">{{ plan.items|length }}</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Itens Críticos</span>
            <span class="stat-value" style="color: var(--danger-color);">
                {{ plan.items | selectattr('severity', 'equalto', 'CRITICAL') | list | length }}
            </span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Status Atual</span>
            <span class="badge badge-warning" style="font-size: 1rem;">{{ inspection.status.name }}</span>
        </div>
    </div>

    <!-- Editable Grid -->
    <div class="card">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="card-title">Verificação de Não Conformidades</h3>
            <!-- Add Item button conditionally hidden or disabled for integrity? User asked to only limit PROBLEM editing, but potentially adding items is fine? 
                 Let's keep Add Item but ensure new items can have problems edited? 
                 User said: "problem comes from report... don't let change this... ensure actions correct".
                 Allows ensuring actions, but what if IA missed something? Better allow Add Item, but block edit of existing IA items?
                 For simplicity as per prompt "Problem Read-only", we make existing READONLY. New items (if allow) would need writable.
                 The prompt implies robust enforcement. Let's make ALL problems read-only to be safe, but then "New Item" makes no sense if you can't type problem.
                 INTERPRETATION: User wants to validate IA output. Adding manual items might be out of scope or requires writable problem. 
                 Let's keep "New Item" writable but lock existing. Or lock all and remove "New Item"?
                 User said "idea is to alter only what was generated by IA".
                 Let's allow adding new items (Problem Writable) but Lock existing ones.
            -->
            <button class="btn btn-primary-sm" onclick="addItem()">
                <i class="ph-bold ph-plus"></i> Novo Item
            </button>
        </div>
        <div class="card-body" style="padding: 0;">
            <table class="modern-table" id="planTable">
                <thead>
                    <tr>
                        <th style="width: 30%;">Problema Encontrado</th>
                        <th style="width: 30%;">Ação Corretiva</th>
                        <th style="width: 15%;">Prazo</th>
                        <th style="width: 15%;">Prioridade</th>
                        <th style="width: 5%;"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in plan.items %}
                    <tr class="item-row" data-id="{{ item.id }}">
                        <td>
                            <!-- Locking existing problems -->
                            <textarea class="form-control item-problem" readonly rows="3"
                                style="background-color: #f9fafb; color: #6b7280; cursor: not-allowed;">{{ item.problem_description }}</textarea>
                        </td>
                        <td>
                            <textarea class="form-control item-action" rows="3">{{ item.corrective_action }}</textarea>
                        </td>
                        <td>
                            <input type="date" class="form-control item-deadline" value="{{ item.deadline_date }}">
                        </td>
                        <td>
                            <select class="form-control item-severity severity-select"
                                data-severity="{{ item.severity.name }}">
                                <option value="LOW" {% if item.severity.name=='LOW' %}selected{% endif %}>Baixa</option>
                                <option value="MEDIUM" {% if item.severity.name=='MEDIUM' %}selected{% endif %}>Média
                                </option>
                                <option value="HIGH" {% if item.severity.name=='HIGH' %}selected{% endif %}>Alta
                                </option>
                                <option value="CRITICAL" {% if item.severity.name=='CRITICAL' %}selected{% endif %}>
                                    Crítica</option>
                            </select>
                        </td>
                        <td class="text-center">
                            <button class="btn-delete-icon" onclick="deleteRow(this)" title="Remover Item">
                                <i class="ph-bold ph-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if not plan.items %}
            <div id="emptyState" class="text-center text-muted" style="padding: 3rem;">
                Nenhum item encontrado. Adicione um novo item acima.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Approval Modal -->
<div id="approvalModal" class="modal-overlay" style="display: none;">
    <div class="modal-card">
        <div class="modal-header">
            <h3>Aprovar & Publicar</h3>
            <button class="btn-close" onclick="closeApprovalModal()"><i class="ph-bold ph-x"></i></button>
        </div>
        <div class="modal-body">
            <p class="text-muted" style="margin-bottom: 1.5rem;">
                O plano será finalizado e um link público será gerado. Confirme o responsável para receber via WhatsApp.
            </p>

            <div style="margin-bottom: 1rem;">
                <label class="form-label">Nome do Responsável</label>
                <div class="input-group">
                    <span class="input-icon"><i class="ph-bold ph-user"></i></span>
                    <input type="text" id="respName" class="form-input" placeholder="Ex: Gerente João"
                        value="{{ inspection.establishment.responsible_name or '' }}">
                </div>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label class="form-label">WhatsApp (com DDD)</label>
                <div class="input-group">
                    <span class="input-icon"><i class="ph-bold ph-whatsapp-logo"></i></span>
                    <input type="text" id="respPhone" class="form-input" placeholder="Ex: 11999999999"
                        value="{{ inspection.establishment.responsible_phone or '' }}">
                </div>
            </div>

            <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="approveAndSend(false)">Aprovar sem Enviar</button>
                <button class="btn btn-success" onclick="approveAndSend(true)">
                    <i class="ph-bold ph-paper-plane-right"></i> Enviar WhatsApp
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .form-control {
        font-size: 0.9rem;
        padding: 0.5rem;
    }

    textarea.form-control {
        resize: vertical;
        min-height: 80px;
    }

    /* Severity Colors */
    .severity-select[data-severity="CRITICAL"] {
        color: var(--danger-color);
        font-weight: 700;
        border-color: var(--danger-color);
    }

    .severity-select[data-severity="HIGH"] {
        color: var(--warning-color);
        font-weight: 600;
        border-color: var(--warning-color);
    }

    .severity-select[data-severity="MEDIUM"] {
        color: var(--primary-color);
    }

    .severity-select[data-severity="LOW"] {
        color: var(--success-color);
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-card {
        background: white;
        border-radius: 16px;
        width: 100%;
        max-width: 450px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        animation: slideUp 0.3s ease-out;
    }

    .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .btn-close {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        color: var(--text-secondary);
    }

    @keyframes slideUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .input-group {
        position: relative;
    }

    .input-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
    }

    .form-input {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 2.5rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-family: inherit;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Constants
    const FILE_ID = "{{ inspection.drive_file_id }}";

    // Add Item Logic
    function addItem() {
        const tbody = document.querySelector('#planTable tbody');
        const emptyState = document.getElementById('emptyState');
        if (emptyState) emptyState.style.display = 'none';

        const tr = document.createElement('tr');
        tr.className = 'item-row';
        tr.innerHTML = `
            <td>
                <!-- New items are writable -->
                <textarea class="form-control item-problem" rows="3" placeholder="Descreva o problema..."></textarea>
            </td>
            <td>
                <textarea class="form-control item-action" rows="3" placeholder="Ação sugerida..."></textarea>
            </td>
            <td>
                <input type="date" class="form-control item-deadline">
            </td>
            <td>
                <select class="form-control item-severity">
                    <option value="LOW">Baixa</option>
                    <option value="MEDIUM" selected>Média</option>
                    <option value="HIGH">Alta</option>
                    <option value="CRITICAL">Crítica</option>
                </select>
            </td>
            <td class="text-center">
                <button class="btn-delete-icon" onclick="deleteRow(this)" title="Remover Item">
                    <i class="ph-bold ph-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
        updateStats();
    }

    // Delete Logic
    function deleteRow(btn) {
        if (confirm('Remover este item?')) {
            btn.closest('tr').remove();
            updateStats();
        }
    }

    // Update Stats (Client-side approximation)
    function updateStats() {
        const rows = document.querySelectorAll('.item-row');
        document.getElementById('totalItems').textContent = rows.length;
    }

    // Modal Logic
    function openApprovalModal() {
        document.getElementById('approvalModal').style.display = 'flex';
    }
    function closeApprovalModal() {
        document.getElementById('approvalModal').style.display = 'none';
    }

    // Save Logic
    async function savePlan(approve = false, sendWhatsapp = false, respName = null, respPhone = null) {
        const rows = document.querySelectorAll('.item-row');
        const items = [];

        rows.forEach(row => {
            items.push({
                id: row.dataset.id || null, // null for new items
                problem: row.querySelector('.item-problem').value,
                action: row.querySelector('.item-action').value,
                deadline: row.querySelector('.item-deadline').value,
                severity: row.querySelector('.item-severity').value
            });
        });

        const statusEl = document.getElementById('saveStatus');
        statusEl.textContent = "Salvando...";
        statusEl.style.opacity = 1;

        const payload = {
            items,
            approve,
            responsible_name: respName,
            responsible_phone: respPhone
        };

        try {
            const response = await fetch(`/manager/plan/${FILE_ID}/save`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': "{{ csrf_token() }}" },
                body: JSON.stringify(payload)
            });

            const res = await response.json();
            if (res.success) {
                statusEl.textContent = "Salvo com sucesso!";

                if (approve) {
                    if (sendWhatsapp && res.whatsapp_link) {
                        window.open(res.whatsapp_link, '_blank');
                    }
                    setTimeout(() => {
                        window.location.href = "{{ url_for('manager.dashboard_manager') }}";
                    }, 1000);
                } else {
                    setTimeout(() => { statusEl.style.opacity = 0; }, 2000);
                    // Reload to sync IDs if needed, but not strictly necessary for MVP draft
                }
            } else {
                alert('Erro ao salvar: ' + res.error);
                statusEl.textContent = "Erro ao salvar";
            }
        } catch (e) {
            console.error(e);
            alert('Erro de conexão');
        }
    }

    function approveAndSend(sendWhatsapp) {
        const name = document.getElementById('respName').value;
        const phone = document.getElementById('respPhone').value;

        if (sendWhatsapp && (!name || !phone)) {
            alert('Para enviar o WhatsApp, preencha Nome e Telefone.');
            return;
        }

        savePlan(true, sendWhatsapp, name, phone);
        closeApprovalModal();
    }

    // Dynamic Severity Colors
    document.addEventListener('change', function (e) {
        if (e.target.classList.contains('severity-select')) {
            e.target.dataset.severity = e.target.value;
        }
    });
</script>
{% endblock %}