{% extends "layout.html" %}

{% block title %}Validação do Plano (Gestor){% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Process Status Stepper -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body py-3 px-4">
                    <div class="d-flex justify-content-between align-items-center position-relative">
                        <!-- Progress Line -->
                        <div class="position-absolute w-100"
                            style="top: 15px; left: 0; height: 2px; background: #e9ecef; z-index: 0;"></div>

                        <!-- Step 1: Gestor (Active) -->
                        <div class="text-center position-relative bg-white px-2" style="z-index: 2;">
                            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center mx-auto mb-2 shadow-sm"
                                style="width: 32px; height: 32px; font-weight: bold;">1</div>
                            <span class="d-block text-xs font-weight-bold text-primary text-uppercase"
                                style="font-size: 0.7rem;">Validação</span>
                        </div>

                        <!-- Step 2: Consultor -->
                        <div class="text-center position-relative bg-white px-2" style="z-index: 2;">
                            <div class="rounded-circle bg-white border d-flex align-items-center justify-content-center mx-auto mb-2"
                                style="width: 32px; height: 32px; color: #adb5bd;">2</div>
                            <span class="d-block text-xs font-weight-bold text-muted text-uppercase"
                                style="font-size: 0.7rem;">Visita</span>
                        </div>

                        <!-- Step 3: Conclusão -->
                        <div class="text-center position-relative bg-white px-2" style="z-index: 2;">
                            <div class="rounded-circle bg-white border d-flex align-items-center justify-content-center mx-auto mb-2"
                                style="width: 32px; height: 32px; color: #adb5bd;">3</div>
                            <span class="d-block text-xs font-weight-bold text-muted text-uppercase"
                                style="font-size: 0.7rem;">Fim</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Standard Header -->
    <div class="row align-items-center mb-4">
        <div class="col-md-8">
            <h1 class="h3 mb-1 text-gray-800">Validação do Plano</h1>
            <p class="text-muted mb-0">
                {{ report_data.nome_estabelecimento }} • {{ report_data.data_inspecao }}
            </p>
        </div>
        <div class="col-md-4 text-end">
            <div class="card border-0 shadow-sm d-inline-block">
                <div class="card-body py-2 px-3">
                    <span class="text-xs font-weight-bold text-muted text-uppercase d-block">Aproveitamento</span>
                    <span
                        class="h2 font-weight-bold {% if report_data.aproveitamento_geral >= 70 %}text-success{% else %}text-danger{% endif %} mb-0">
                        {{ report_data.aproveitamento_geral }}%
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Card -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white py-3">
            <h5 class="m-0 font-weight-bold text-primary">Resumo Executivo</h5>
        </div>
        <div class="card-body">
            <p class="text-muted mb-4">{{ report_data.resumo_geral }}</p>

            <div class="table-responsive">
                <table class="table table-bordered table-hover mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th>Área Auditada</th>
                            <th class="text-center">Pontuação</th>
                            <th class="text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for area in report_data.areas_inspecionadas %}
                        {# Hide completely compliant areas #}
                        {% if area.items_nc > 0 %}
                        <tr>
                            <td class="align-middle fw-bold text-dark">{{ area.nome_area }}</td>
                            <td class="align-middle text-center">{{ area.pontuacao_obtida }} / {{ area.pontuacao_maxima
                                }}</td>
                            <td class="align-middle text-center">
                                {% if area.aproveitamento >= 100 %}
                                <span class="badge bg-success">Conforme ({{ area.aproveitamento }}%)</span>
                                {% elif area.aproveitamento > 0 %}
                                <span class="badge bg-warning text-dark">Parcialmente Conforme ({{ area.aproveitamento
                                    }}%)</span>
                                {% else %}
                                <span class="badge bg-danger">Não Conforme ({{ area.aproveitamento }}%)</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Details Section -->
    <h4 class="mb-3 text-gray-800">Detalhamento e Ações</h4>
    {# Safe access to status regardless of type (Enum/String/Dict) #}
    {% set status_raw = inspection.status if inspection.status is defined else 'PENDING' %}
    {% set status_name = status_raw.name if status_raw.name is defined else status_raw|string %}
    {% set is_locked = (status_name == 'APPROVED' or status_name == 'COMPLETED') %}

    <div class="accordion shadow-sm" id="accordionAreas">
        {% for area in report_data.areas_inspecionadas %}
        {% if area.items_nc > 0 %}
        <div class="accordion-item mb-3 border rounded overflow-hidden">
            <h2 class="accordion-header" id="heading{{ loop.index }}">
                <button class="accordion-button collapsed bg-white text-dark fw-bold" type="button"
                    data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}">
                    <div class="d-flex align-items-center w-100 me-3">
                        <span class="me-auto">{{ area.nome_area }}</span>
                        <span class="badge bg-light text-dark border me-2">{{ area.items_nc }} apontamentos</span>
                    </div>
                </button>
            </h2>
            <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#accordionAreas">
                <div class="accordion-body bg-light p-4">
                    {% for item in area.itens %}
                    {# Filter out conforming items #}
                    {% if item.status != 'Conforme' %}
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                            <div>
                                <h6 class="m-0 font-weight-bold text-dark">{{ item.item_verificado }}</h6>
                                <small class="text-muted">{{ item.fundamento_legal }}</small>
                            </div>
                            <div>
                                {% if item.pontuacao|float == 0 %}
                                <span class="badge bg-danger rounded-pill px-3">Não Conforme</span>
                                {% else %}
                                <span class="badge bg-warning text-dark rounded-pill px-3">Parcialmente Conforme</span>
                                {% endif %}
                                <span class="badge bg-secondary rounded-pill ms-1">{{ item.pontuacao }} PTS</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row g-0">
                                <!-- Problem Section -->
                                <div class="col-md-5 pe-md-4 mb-3 mb-md-0 border-end">
                                    <label class="text-xs fw-bold text-muted text-uppercase mb-2">Problema
                                        Identificado</label>
                                    <div
                                        class="p-3 bg-danger bg-opacity-10 border border-danger border-opacity-25 rounded text-danger">
                                        {{ item.observacao }}
                                    </div>
                                </div>

                                <!-- Action Section -->
                                <div class="col-md-7 ps-md-4">
                                    <div class="mb-3">
                                        <label class="text-xs fw-bold text-muted text-uppercase mb-2">Ação Corretiva
                                            Sugerida</label>
                                        <div class="position-relative">
                                            <textarea class="form-control" rows="3"
                                                data-original="{{ item.acao_corretiva_sugerida }}"
                                                data-item-id="{{ item.id }}" oninput="markAsModified(this)"
                                                onblur="autoSaveItem(this)" {% if is_locked %}disabled{% endif
                                                %}>{{ item.acao_corretiva_sugerida }}</textarea>
                                            {% if not is_locked %}
                                            <div class="status-indicator position-absolute bottom-0 end-0 m-2"></div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="row align-items-center">
                                        <label
                                            class="col-auto col-form-label text-xs fw-bold text-muted text-uppercase">Prazo:</label>
                                        <div class="col position-relative">
                                            <input type="text" class="form-control" value="{{ item.prazo_sugerido }}"
                                                data-original="{{ item.prazo_sugerido }}" data-item-id="{{ item.id }}"
                                                oninput="markAsModified(this)" onblur="autoSaveItem(this)" {% if
                                                is_locked %}disabled{% endif %}>
                                            {% if not is_locked %}
                                            <div
                                                class="status-indicator position-absolute top-50 end-0 translate-middle-y me-3">
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>

    <!-- Actions Area -->
    <div class="card mt-5 mb-5 border-0 bg-white shadow-sm">
        <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-success"
                        onclick="if(confirm('Abrir WhatsApp?')) window.open('/api/share_plan/{{ inspection.drive_file_id }}', '_blank')">
                        <i class="ph-bold ph-whatsapp-logo me-2"></i> WhatsApp
                    </button>
                    <button class="btn btn-outline-secondary" onclick="alert('Funcionalidade de Email em breve!')">
                        <i class="ph-bold ph-envelope-simple me-2"></i> Email
                    </button>
                    <button class="btn btn-outline-primary"
                        onclick="window.open('/download_pdf/{{ inspection.drive_file_id }}', '_blank')">
                        <i class="ph-bold ph-file-pdf me-2"></i> Baixar Relatório
                    </button>
                </div>
                <div>
                    {% if is_locked %}
                    <button class="btn btn-success px-4" disabled>
                        <i class="ph-bold ph-check me-2"></i> Plano Validado
                    </button>
                    {% else %}
                    <button class="btn btn-primary px-4 fw-bold" onclick="approvePlan()" id="btn-approve">
                        <i class="ph-bold ph-check-circle me-2"></i> Aprovar Plano
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Minimal safe overrides */
    .accordion-button:not(.collapsed) {
        background-color: #f8f9fa;
        color: #212529;
        box-shadow: none;
    }

    .accordion-button:focus {
        box-shadow: none;
        border-color: rgba(0, 0, 0, .125);
    }

    /* High Contrast Warning Button for Consultant (and potentially Manager if used) */
    .btn-outline-warning {
        color: #d97706 !important;
        /* Amber 600 - High Contrast */
        border-color: #d97706 !important;
    }

    .btn-outline-warning:hover,
    .btn-check:checked+.btn-outline-warning {
        background-color: #d97706 !important;
        color: white !important;
    }

    /* Auto-save Feedback styles */
    .modified-field {
        border-left: 3px solid #2563eb !important;
        /* Blue indicator for edited */
        background-color: #eff6ff;
    }

    .status-saved {
        color: #10b981;
        font-size: 0.75rem;
        font-weight: 600;
        animation: fadeIn 0.3s;
    }

    .status-saving {
        color: #64748b;
        font-size: 0.75rem;
        animation: pulse 1s infinite;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @keyframes pulse {
        0% {
            opacity: 0.6;
        }

        50% {
            opacity: 1;
        }

        100% {
            opacity: 0.6;
        }
    }
</style>

<script>
    function markAsModified(input) {
        if (input.value !== input.dataset.original) {
            input.classList.add('modified-field');
        } else {
            input.classList.remove('modified-field');
        }
    }

    function autoSaveItem(input) {
        // Only save if modified
        if (input.value === input.dataset.original) return;

        const container = input.parentElement;
        const indicator = container.querySelector('.status-indicator');

        // Show saving state
        indicator.innerHTML = '<span class="status-saving"><i class="ph-bold ph-arrows-clockwise"></i> Salvando...</span>';

        // Mock API call delay
        setTimeout(() => {
            // Show saved state
            indicator.innerHTML = '<span class="status-saved"><i class="ph-bold ph-check"></i> Salvo</span>';

            // Optional: Hide after 3 seconds
            setTimeout(() => {
                // Keep the "Modified" style but hide the text to reduce clutter? 
                // Or keep "Salvo" visible? User said "saiba que aquele item foi editado".
                // Let's keep "Salvo" visible or just the blue border. 
                // The blue border ('modified-field') remains as the persistent "Edited" indicator.
                indicator.innerHTML = '<span class="status-saved" style="opacity:0.7"><i class="ph-fill ph-check-circle"></i></span>';
            }, 2000);

            // Update "original" so it doesn't re-save next blur unless changed again? 
            // Usually in auto-save, we treat current as new original only if confirmed. 
            // For now, we leave it to allow further edits.

        }, 800);
    }
    function finishReview() {
        // Change button state
        const btn = document.getElementById('btn-finish');
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Salvando...';
        btn.disabled = true;

        // Mock save delay
        setTimeout(() => {
            alert('Plano Aprovado com Sucesso! O Consultor será notificado.');
            window.location.reload();
        }, 1500);
    }

    function shareAction(platform) {
        alert(`Compartilhando via ${platform}... (Mock)`);
    }

    function exportPDF() {
        alert('Gerando PDF atualizado... (Mock)');
    }
</script>
{% endblock %}