{% extends "layout.html" %}

{% block title %}Dashboard Gestor | InspetorAI{% endblock %}

{% block content %}


<style>
    /* Critical Grid Layout Force - Zero Defect */
    .admin-wrapper-grid {
        display: grid !important;
        grid-template-columns: 280px 1fr !important;
        min-height: calc(100vh - 72px) !important;
        width: 100% !important;
        background: #f8fafc;
    }

    .admin-sidebar-cell {
        background: white;
        border-right: 1px solid #e2e8f0;
        height: calc(100vh - 72px);
        position: sticky;
        top: 72px;
        overflow-y: auto;
    }

    .admin-content-cell {
        padding: 0;
        overflow-x: hidden;
        width: 100% !important;
    }

    @media (max-width: 1024px) {
        .admin-wrapper-grid {
            grid-template-columns: 1fr !important;
        }

        .admin-sidebar-cell {
            display: none;
        }

        /* Mobile implementation pending, keep simple for now */
    }

    /* Tabela Profissional - Zero Defect Alignment */
    .modern-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 1rem;
    }

    .modern-table th {
        background: #f1f5f9;
        padding: 0.75rem 1rem;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        color: var(--text-light);
        letter-spacing: 0.05em;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
    }

    .modern-table td {
        padding: 1rem;
        vertical-align: middle;
        border-bottom: 1px solid #f1f5f9;
        font-size: 0.9rem;
        color: var(--text-primary);
    }

    .modern-table tr:last-child td {
        border-bottom: none;
    }

    .modern-table tr:hover td {
        background: #f8fafc;
    }

    .text-right {
        text-align: right !important;
    }

    .text-center {
        text-align: center !important;
    }

    .user-avatar-sm {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: linear-gradient(135deg, var(--accent-color), #6366f1);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.85rem;
    }

    .btn-icon-group {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
    }

    .btn-action {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #e2e8f0;
        background: white;
        color: var(--text-secondary);
        transition: all 0.2s;
        cursor: pointer;
    }

    .btn-action:hover {
        border-color: var(--accent-color);
        color: var(--accent-color);
        background: #f5f3ff;
    }

    .btn-action-delete:hover {
        border-color: var(--danger-color);
        color: var(--danger-color);
        background: #fef2f2;
    }
</style>

<div class="admin-wrapper-grid">
    <!-- Sidebar -->
    <aside class="admin-sidebar-cell admin-sidebar">
        <h3
            style="margin-bottom: 2rem; font-size: 1.1rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
            <i class="ph-fill ph-briefcase" style="color: var(--accent-color);"></i>
            Gest√£o
        </h3>

        <div class="sidebar-header">Principal</div>
        <ul class="sidebar-menu">
            <li class="sidebar-item active" id="menu-overview" onclick="showSection('overview', this)">
                <div class="sidebar-dot"></div> Vis√£o Geral
            </li>
            <li class="sidebar-item" id="menu-management" onclick="showSection('management', this)">
                <div class="sidebar-dot"></div> Cadastros
            </li>
        </ul>

        <!-- Filter (moved to sidebar bottom area) -->
        <div style="margin-top: auto; padding-top: 2rem;">
            <form id="filterForm" action="{{ url_for('manager.dashboard_manager') }}" method="GET">
                <label class="form-label" style="font-size: 0.75rem; color: var(--text-light);">FILTRAR POR LOJA</label>
                <select name="establishment_id" onchange="handleFilterChange(this)" class="form-control"
                    style="font-size: 0.85rem;">
                    <option value="">Todas as Lojas</option>
                    {% for est in all_establishments %}
                    <option value="{{ est.id }}" {% if selected_est_id==est.id|string %}selected{% endif %}>
                        {{ est.name }}
                    </option>
                    {% endfor %}
                </select>
            </form>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-content-cell admin-main">
        <div class="content-wrapper">
            <!-- 1. Overview Section -->
            <div id="overview" class="section-view active">
                <!-- ... content ... -->
                <!-- (Mantendo o conte√∫do interno existente, apenas ajustando o wrapper) -->

                <!-- Modern Header -->
                <div style="margin-bottom: 2.5rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <div>
                            <span
                                style="font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: var(--accent-color); letter-spacing: 0.05em; display: block; margin-bottom: 0.25rem;">Painel
                                do Gestor v2.0 NEW</span>
                            <h1
                                style="font-size: 2.5rem; font-weight: 700; color: var(--text-primary); letter-spacing: -0.02em; margin: 0;">
                                Ol√°, {{ current_user.name.split()[0] }} <span
                                    style="animation: wave 2s infinite; display: inline-block; transform-origin: 70% 70%;">üëã</span>
                            </h1>
                        </div>
                        <div style="text-align: right;">
                            <div
                                style="background: white; padding: 0.5rem 1rem; border-radius: 50px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; font-weight: 500; color: var(--text-secondary); border: 1px solid rgba(0,0,0,0.02);">
                                <i class="ph-fill ph-calendar-blank" style="color: var(--accent-color);"></i>
                                <span style="text-transform: capitalize;">
                                    <script>document.write(new Date().toLocaleDateString('pt-BR', { weekday: 'short', day: 'numeric', month: 'long' }))</script>
                                </span>
                            </div>
                        </div>
                    </div>
                    <!-- <p class="text-muted">Gerencie sua equipe e estabelecimentos.</p> -->
                </div>

                <style>
                    @keyframes wave {
                        0% {
                            transform: rotate(0.0deg)
                        }

                        10% {
                            transform: rotate(14.0deg)
                        }

                        20% {
                            transform: rotate(-8.0deg)
                        }

                        30% {
                            transform: rotate(14.0deg)
                        }

                        40% {
                            transform: rotate(-4.0deg)
                        }

                        50% {
                            transform: rotate(10.0deg)
                        }

                        60% {
                            transform: rotate(0.0deg)
                        }

                        100% {
                            transform: rotate(0.0deg)
                        }
                    }
                </style>

                <div class="stats-grid">
                    <div class="stat-card" onclick="document.getElementById('menu-management').click()">
                        <span class="stat-label">Estabelecimentos</span>
                        <span class="stat-value">{{ establishments|length if establishments else 0 }}</span>
                        <div class="stat-trend trend-up"><i class="ph-bold ph-trend-up"></i> Conectados</div>
                    </div>
                    <div class="stat-card" onclick="document.getElementById('menu-management').click()">
                        <span class="stat-label">Consultores</span>
                        <span class="stat-value">{{ consultants|length if consultants else 0 }}</span>
                        <div class="stat-trend trend-up"><i class="ph-bold ph-users"></i> Ativos</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--accent-color); background: #EFF6FF;"
                        onclick="document.getElementById('home-processing').scrollIntoView({behavior: 'smooth'})">
                        <span class="stat-label" style="color: var(--accent-color);">Em Processamento</span>
                        <span class="stat-value" id="stat-pending" style="color: var(--accent-color);">0</span>
                        <div class="stat-trend" style="color: var(--accent-color);"><i class="ph-bold ph-hourglass"></i>
                            Ver
                            Status</div>
                    </div>
                </div>

                <!-- ÔøΩ New: Itens em Processamento section -->
                <div id="home-processing" class="card" style="margin-top: 2.5rem; display: none;">
                    <div class="card-header" style="background: #f0f9ff; border-bottom: 1px solid #e0f2fe;">
                        <h3 class="card-title" style="color: #0369a1;"><i
                                class="ph-bold ph-arrows-clockwise ph-spin"></i> Em Processamento pela IA</h3>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div id="home-processing-list">
                            <!-- Populated via JS -->
                        </div>
                    </div>
                </div>

                <!-- üöÄ New: A√ß√µes Pendentes section -->
                <div id="home-pendencies" class="card" style="margin-top: 1.5rem; display: none;">
                    <div class="card-header" style="background: #fff5f5; border-bottom: 1px solid #fee2e2;">
                        <h3 class="card-title" style="color: #dc2626;"><i class="ph-bold ph-warning-circle"></i> A√ß√µes
                            Pendentes de Valida√ß√£o</h3>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div id="home-pendencies-list">
                            <!-- Populated via JS -->
                        </div>
                    </div>
                </div>



                <!-- üìä Vistorias Realizadas section (Primary Focus) -->
                <div class="card" style="margin-top: 2rem; min-height: 400px;">
                    <div class="card-header">
                        <h3 class="card-title">Hist√≥rico de Vistorias</h3>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                            <i class="ph-fill ph-circle" style="color: var(--success-color); font-size: 0.6rem;"></i>
                            Tempo Real
                        </div>
                    </div>
                    <div id="list-pending-container"
                        style="padding: 1rem; background: #F8FAFC; border-bottom: 1px solid var(--border-color); display:none;">
                    </div>
                    <div class="card-body" style="padding:0;">
                        <div class="table-container">
                            <table class="modern-table">
                                <thead>
                                    <tr>
                                        <th>Estabelecimento</th>
                                        <th>Data/Hora</th>
                                        <th>Status</th>
                                        <th>A√ß√£o</th>
                                    </tr>
                                </thead>
                                <tbody id="list-processed-tbody">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted" style="padding: 2rem;">
                                            Carregando vistorias...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>


            </div>

            <div id="management" class="section-view">
                <h1 style="font-size: 1.8rem; margin-bottom: 2rem;">Gerenciar Cadastros</h1>

                <div class="card" style="margin-bottom: 2rem; border-top: 1px solid #e2e8f0; background: #ffff;">
                    <div class="card-body">
                        <style>
                            .action-tabs {
                                display: flex;
                                border-bottom: 1px solid var(--border-color);
                                margin-bottom: 1.5rem;
                            }

                            .action-tab {
                                padding: 0.75rem 1.5rem;
                                cursor: pointer;
                                font-weight: 500;
                                color: var(--text-secondary);
                                border-bottom: 2px solid transparent;
                            }

                            .action-tab.active {
                                color: var(--primary-color);
                                border-bottom-color: var(--accent-color);
                            }

                            .action-content {
                                display: none;
                            }

                            .action-content.active {
                                display: block;
                            }
                        </style>
                        <div class="action-tabs">
                            <div class="action-tab active" onclick="switchTab('tab-consultant', this)">Novo Consultor
                            </div>
                            <div class="action-tab" onclick="switchTab('tab-est', this)">Novo Estabelecimento</div>
                        </div>

                        <!-- New Consultant -->
                        <div id="tab-consultant" class="action-content active">
                            <form id="formCreateConsultant">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                <div
                                    style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                                    <div class="form-group" style="margin:0;">
                                        <input type="text" name="name" placeholder="Nome" class="form-control" required>
                                    </div>
                                    <div class="form-group" style="margin:0;">
                                        <input type="email" name="email" placeholder="Email" class="form-control"
                                            required>
                                    </div>
                                    <div class="form-group" style="margin:0;">
                                        <select name="establishment_ids" class="form-control" multiple
                                            style="height: 100px; padding: 0.25rem;" title="Segure Ctrl para m√∫ltiplos"
                                            required>
                                            {% for est in all_establishments %}
                                            <option value="{{ est.id }}">{{ est.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-primary"
                                        id="btnCreateConsultant">Criar</button>
                                </div>
                                <small class="text-muted" style="display:block; margin-top:0.5rem;">* Segure Ctrl/Cmd
                                    para selecionar m√∫ltiplas lojas. A senha padr√£o ser√° enviada por email.</small>
                            </form>
                        </div>

                        <!-- New Establishment -->
                        <div id="tab-est" class="action-content">
                            <form id="formCreateEst">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                <div
                                    style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: end;">
                                    <div class="form-group" style="margin:0;">
                                        <input type="text" name="name" placeholder="Nome da Loja" class="form-control"
                                            required>
                                    </div>
                                    <div class="form-group" style="margin:0;">
                                        <input type="text" name="code" placeholder="C√≥digo (Opcional)"
                                            class="form-control">
                                    </div>
                                    <button type="submit" class="btn btn-accent" id="btnCreateEst">Adicionar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Edit Modals -->
                <!-- Edit Consultant Modal -->
                <div class="card" id="editConsultantCard"
                    style="margin-bottom: 2rem; display: none; border: 1px solid #3b82f6;">
                    <div class="card-header" style="background:none; padding-bottom:0;">
                        <h4 style="margin:0; color:#1e40af;">Editar Consultor</h4>
                    </div>
                    <div class="card-body">
                        <form id="editConsultantForm" onsubmit="handleUpdateConsultant(event)">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <input type="hidden" name="user_id" id="edit_consultant_id">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">Nome</label>
                                    <input type="text" name="name" id="edit_consultant_name" class="form-control"
                                        required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="email" name="email" id="edit_consultant_email" class="form-control"
                                        required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Lojas Vinculadas</label>
                                <select name="establishment_ids" id="edit_consultant_ests" class="form-control" multiple
                                    style="height: 100px;">
                                    {% for est in all_establishments %}
                                    <option value="{{ est.id }}">{{ est.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Nova Senha (Opcional)</label>
                                <input type="password" name="password" class="form-control">
                            </div>
                            <div style="text-align: right;">
                                <button type="button" class="btn btn-secondary"
                                    onclick="document.getElementById('editConsultantCard').style.display='none'">Cancelar</button>
                                <button type="submit" class="btn btn-primary" id="btnUpdateConsultant">Salvar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Edit Est Modal -->
                <div class="card" id="editEstCard"
                    style="margin-bottom: 2rem; display: none; border: 1px solid #3b82f6;">
                    <div class="card-header" style="background:none; padding-bottom:0;">
                        <h4 style="margin:0; color:#1e40af;">Editar Estabelecimento</h4>
                    </div>
                    <div class="card-body">
                        <form id="editEstForm" onsubmit="handleUpdateEst(event)">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <input type="hidden" name="est_id" id="edit_est_id">
                            <div
                                style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: end;">
                                <div class="form-group" style="margin:0;">
                                    <label class="form-label">Nome</label>
                                    <input type="text" name="name" id="edit_est_name" class="form-control" required>
                                </div>
                                <div class="form-group" style="margin:0;">
                                    <label class="form-label">C√≥digo</label>
                                    <input type="text" name="code" id="edit_est_code" class="form-control">
                                </div>
                            </div>
                            <!-- Responsible Edit -->
                            <div class="row g-2 mt-2">
                                <div class="col-6">
                                    <label class="form-label text-xs fw-bold text-muted">Respons√°vel</label>
                                    <input type="text" name="responsible_name" id="edit_est_resp_name"
                                        class="form-control">
                                </div>
                                <div class="col-6">
                                    <label class="form-label text-xs fw-bold text-muted">WhatsApp</label>
                                    <input type="text" name="responsible_phone" id="edit_est_resp_phone"
                                        class="form-control">
                                </div>
                            </div>
                            <div class="mt-3 text-end">
                                <button type="button" class="btn btn-secondary"
                                    onclick="closeEditModal('editEstCard')">Cancelar</button>
                                <button type="submit" class="btn btn-primary" id="btnUpdateEst">Salvar</button>
                            </div>
                    </div>
                    </form>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr; gap: 2rem;">
                <!-- Consultants Table -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Consultores</h3>
                    </div>
                    <div class="table-container">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Email</th>
                                    <th class="text-right">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="table-consultants-body">
                                {% for consultant in consultants %}
                                <tr id="row-consultant-{{ consultant.id }}">
                                    <td>
                                        <div style="display:flex; align-items:center; gap:0.75rem;">
                                            <div class="user-avatar-sm">{{ consultant.name[0].upper() }}</div>
                                            <div style="font-weight: 600;">{{ consultant.name }}</div>
                                        </div>
                                    </td>
                                    <td style="color: var(--text-secondary);">{{ consultant.email }}</td>
                                    <td class="text-right">
                                        <div class="btn-icon-group">
                                            <button class="btn-action" data-id="{{ consultant.id }}"
                                                data-name="{{ consultant.name }}" data-email="{{ consultant.email }}"
                                                data-stores='[{% for est in consultant.establishments %}"{{ est.id }}"{{ "," if not loop.last }}{% endfor %}]'
                                                onclick="openEditConsultant(this.dataset.id, this.dataset.name, this.dataset.email, this.dataset.stores)"
                                                title="Editar">
                                                <i class="ph ph-pencil-simple"></i>
                                            </button>
                                            <button class="btn-action btn-action-delete"
                                                onclick="if(confirm('Tem certeza?')) deleteConsultant('{{ consultant.id }}')"
                                                title="Remover">
                                                <i class="ph ph-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">Nenhum consultor.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Establishments Table (New View for Management) -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Estabelecimentos</h3>
                    </div>
                    <div class="table-container">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>C√≥digo</th>
                                    <th class="text-right">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="table-establishments-body">
                                {% for est in establishments %}
                                <tr id="row-est-{{ est.id }}">
                                    <td>
                                        <div style="display:flex; align-items:center; gap:0.75rem;">
                                            <div class="user-avatar-sm"
                                                style="background: linear-gradient(135deg, #10b981, #059669);">
                                                <i class="ph ph-storefront"></i>
                                            </div>
                                            <div style="font-weight: 600;">{{ est.name }}</div>
                                        </div>
                                    </td>
                                    <td style="font-family: monospace; color: var(--text-secondary);">{{ est.code or
                                        '-' }}</td>
                                    <td class="text-right">
                                        <div class="btn-icon-group">
                                            <button class="btn-action" data-id="{{ est.id }}" data-name="{{ est.name }}"
                                                data-code="{{ est.code or '' }}"
                                                onclick="openEditEst(this.dataset.id, this.dataset.name, this.dataset.code)"
                                                title="Editar">
                                                <i class="ph ph-pencil-simple"></i>
                                            </button>
                                            <button class="btn-action btn-action-delete"
                                                onclick="if(confirm('Tem certeza?')) deleteEstablishment('{{ est.id }}')"
                                                title="Remover">
                                                <i class="ph ph-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>



</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

</div>
</div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        // Attach Event Listeners
        const formConsultant = document.getElementById('formCreateConsultant');
        if (formConsultant) formConsultant.addEventListener('submit', handleCreateConsultant);

        const formEst = document.getElementById('formCreateEst');
        if (formEst) formEst.addEventListener('submit', handleCreateEstablishment);

        // Edit Forms are in modals
        const formEditConsultant = document.getElementById('editConsultantForm');
        if (formEditConsultant) {
            formEditConsultant.onsubmit = null;
            formEditConsultant.addEventListener('submit', handleUpdateConsultant);
        }

        const formEditEst = document.getElementById('editEstForm');
        if (formEditEst) {
            formEditEst.onsubmit = null;
            formEditEst.addEventListener('submit', handleUpdateEst);
        }

        // Initialize View (Critical for Navigation)
        const menuOverview = document.getElementById('menu-overview');
        if (menuOverview) showSection('overview', menuOverview);

        // Start Polling
        updateLists();
        setInterval(updateLists, 30000);

        // Inject Loading Overlay
        const loaderHTML = `
            <div id="premium-loader" style="display:none; position:fixed; inset:0; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); z-index: 10000; align-items:center; justify-content:center; flex-direction:column; animation: fadeIn 0.3s ease;">
                <div style="width: 50px; height: 50px; border: 4px solid #e2e8f0; border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <div style="margin-top:1.5rem; font-weight:600; color:var(--text-primary); font-size: 1.1rem; letter-spacing: -0.02em;">Atualizando...</div>
            </div>
            <style>@keyframes spin { to { transform: rotate(360deg); } } @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }<` + `/style>
        `;
        document.body.insertAdjacentHTML('beforeend', loaderHTML);
    });

    window.showLoading = function () {
        const loader = document.getElementById('premium-loader');
        if (loader) loader.style.display = 'flex';
    };

    window.handleFilterChange = function (select) {
        showLoading();
        if (select.value === "") {
            window.location.href = "{{ url_for('manager.dashboard_manager') }}";
        } else {
            select.form.submit();
        }
    };

    // Validations & Logic
    function showSection(sectionId, element) {
        document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
        if (element) element.classList.add('active');
        document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
        const target = document.getElementById(sectionId);
        if (target) target.classList.add('active');
    }

    // Explicitly expose to window since they are called from inline onclicks (HTML attributes)
    window.showSection = showSection;

    function switchTab(tabId, element) {
        document.querySelectorAll('.action-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.action-tab').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        if (element) element.classList.add('active');
    }
    window.switchTab = switchTab;

    function openEditConsultant(id, name, email, storesJson) {
        document.getElementById('editConsultantCard').style.display = 'block';
        document.getElementById('edit_consultant_id').value = id;
        document.getElementById('edit_consultant_name').value = name;
        document.getElementById('edit_consultant_email').value = email;

        // Logic for Select Multiple
        const select = document.getElementById('edit_consultant_ests');
        if (select) {
            // Reset selection
            Array.from(select.options).forEach(opt => opt.selected = false);

            try {
                let stores = [];
                if (storesJson) {
                    if (typeof storesJson === 'string') stores = JSON.parse(storesJson);
                    else stores = storesJson;
                }

                if (Array.isArray(stores)) {
                    stores.forEach(estId => {
                        // Loose equality to handle int/string diffs
                        const opt = Array.from(select.options).find(o => o.value == estId);
                        if (opt) opt.selected = true;
                    });
                }
            } catch (e) {
                console.error("Error parsing stores:", e);
            }
        }

        window.scrollTo(0, 0);
    }
    window.openEditConsultant = openEditConsultant;

    function openEditEst(id, name, code, respName, respPhone) {
        document.getElementById('editEstCard').style.display = 'block';
        document.getElementById('edit_est_id').value = id;
        document.getElementById('edit_est_name').value = name;
        document.getElementById('edit_est_code').value = code;
        document.getElementById('edit_est_resp_name').value = respName || '';
        document.getElementById('edit_est_resp_phone').value = respPhone || '';
        window.scrollTo(0, 0);
    }
    window.openEditEst = openEditEst;

    // Modal Helpers
    let createConsultantModal, createEstModal;
    document.addEventListener('DOMContentLoaded', () => {
        const elC = document.getElementById('createConsultantModal');
        if (elC) createConsultantModal = new bootstrap.Modal(elC);

        const elE = document.getElementById('createEstModal');
        if (elE) createEstModal = new bootstrap.Modal(elE);
    });

    window.openCreateConsultantModal = () => createConsultantModal?.show();
    window.openCreateEstModal = () => createEstModal?.show();
    window.closeEditModal = (id) => document.getElementById(id).style.display = 'none';


    // --- TOAST NOTIFICATION SYSTEM ---
    function showToast(message, type = 'success') {
        const toastId = 'toast-' + Math.random().toString(36).substr(2, 9);
        const color = type === 'success' ? '#10b981' : '#ef4444';
        const bg = type === 'success' ? '#ecfdf5' : '#fef2f2';

        const html = `
            <div id="${toastId}" style="
                position: fixed; top: 20px; right: 20px; z-index: 9999;
                background: ${bg}; border-left: 4px solid ${color};
                padding: 1rem 1.5rem; border-radius: 6px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
                display: flex; align-items: center; gap: 12px;
                transform: translateX(100%); transition: transform 0.3s ease-out;
            ">
                <i class="ph-bold ${type === 'success' ? 'ph-check-circle' : 'ph-warning-circle'}" style="color: ${color}; font-size: 1.2rem;"></i>
                <div style="font-weight: 500; color: #1f2937;">${message}</div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', html);

        setTimeout(() => {
            const el = document.getElementById(toastId);
            if (el) el.style.transform = 'translateX(0)';
        }, 100);

        setTimeout(() => {
            const el = document.getElementById(toastId);
            if (el) {
                el.style.transform = 'translateX(120%)';
                setTimeout(() => el.remove(), 300);
            }
        }, 4000);
    }
    window.showToast = showToast; // Good practice to expose if needed, though internal mostly

    // --- CREATE ACTIONS ---
    async function handleCreateConsultant(e) {
        e.preventDefault();
        const form = e.target;
        const btn = document.getElementById('btnCreateConsultant');
        if (btn) { btn.disabled = true; btn.innerHTML = 'Criando...'; }

        try {
            const formData = new FormData(form);
            const res = await fetch("{{ url_for('manager.create_consultant') }}", {
                method: 'POST', body: formData, headers: { 'Accept': 'application/json' }
            });
            const data = await res.json();

            if (res.ok) {
                showToast(data.message, 'success');
                form.reset();
                // Add row to table
                const tbody = document.getElementById('table-consultants-body');
                if (tbody) {
                    const c = data.consultant;
                    if (tbody.innerHTML.includes('Nenhum consultor')) tbody.innerHTML = '';

                    const newRow = `
                        <tr id="row-consultant-${c.id}" style="animation: fadeIn 0.5s;">
                            <td>
                                <div style="display:flex; align-items:center; gap:0.75rem;">
                                    <div class="user-avatar-sm">${c.name[0].toUpperCase()}</div>
                                    <div style="font-weight: 600;">${c.name}</div>
                                </div>
                            </td>
                            <td style="color: var(--text-secondary);">${c.email}</td>
                            <td class="text-right">
                                <div class="btn-icon-group">
                                    <button class="btn-action" data-id="${c.id}" data-name="${c.name}" data-email="${c.email}"
                                        onclick="openEditConsultant(this.dataset.id, this.dataset.name, this.dataset.email)" title="Editar">
                                        <i class="ph ph-pencil-simple"></i>
                                    </button>
                                    <button class="btn-action btn-action-delete"
                                        onclick="if(confirm('Tem certeza?')) deleteConsultant('${c.id}')" title="Remover">
                                        <i class="ph ph-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', newRow);
                }
            } else {
                showToast(data.error || 'Erro desconhecido', 'error');
            }
        } catch (err) {
            console.error(err);
            showToast('Erro de conex√£o', 'error');
        } finally {
            if (btn) { btn.disabled = false; btn.innerHTML = 'Criar'; }
        }
    }

    async function handleCreateEstablishment(e) {
        e.preventDefault();
        const form = e.target;
        const btn = document.getElementById('btnCreateEst');
        if (btn) { btn.disabled = true; btn.innerHTML = 'Adicionando...'; }

        try {
            const formData = new FormData(form);
            const res = await fetch("{{ url_for('manager.create_establishment') }}", {
                method: 'POST', body: formData, headers: { 'Accept': 'application/json' }
            });
            const data = await res.json();

            if (res.ok) {
                showToast(data.message, 'success');
                form.reset();

                // Add row to table management
                const tbody = document.getElementById('table-establishments-body');
                if (tbody) {
                    const est = data.establishment;
                    const newRow = `
                        <tr id="row-est-${est.id}" style="animation: fadeIn 0.5s;">
                            <td>
                                <div style="display:flex; align-items:center; gap:0.75rem;">
                                    <div class="user-avatar-sm" style="background: linear-gradient(135deg, #10b981, #059669);">
                                        <i class="ph ph-storefront"></i>
                                    </div>
                                    <div style="font-weight: 600; font-size:1rem;">${est.name}</div>
                                </div>
                            </td>
                            <td style="font-family: monospace; color: var(--text-secondary);">${est.code || '-'}</td>
                            <td class="text-right">
                                <div class="btn-icon-group">
                                    <button class="btn-action" data-id="${est.id}" data-name="${est.name}" data-code="${est.code || ''}"
                                        onclick="openEditEst(this.dataset.id, this.dataset.name, this.dataset.code)" title="Editar">
                                        <i class="ph ph-pencil-simple"></i>
                                    </button>
                                    <button class="btn-action btn-action-delete"
                                        onclick="if(confirm('Tem certeza?')) deleteEstablishment('${est.id}')" title="Remover">
                                        <i class="ph ph-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', newRow);

                    // Update Dropdowns
                    document.querySelectorAll('select[name="establishment_ids"]').forEach(sel => {
                        const opt = new Option(est.name, est.id);
                        sel.add(opt);
                    });
                }
            } else {
                showToast(data.error || 'Erro desconhecido', 'error');
            }
        } catch (err) {
            console.error(err);
            showToast('Erro de conex√£o', 'error');
        } finally {
            if (btn) { btn.disabled = false; btn.innerHTML = 'Adicionar'; }
        }
    }


    async function handleUpdateConsultant(e) {
        e.preventDefault();
        const id = document.getElementById('edit_consultant_id').value;
        const form = e.target;
        const btn = document.getElementById('btnUpdateConsultant');
        const nameInput = document.getElementById('edit_consultant_name');
        const emailInput = document.getElementById('edit_consultant_email');

        if (btn) { btn.disabled = true; btn.innerHTML = 'Salvando...'; }

        try {
            const formData = new FormData(form);
            const res = await fetch(`/manager/consultant/${id}/update`, { method: 'POST', body: formData });

            if (res.ok) {
                const data = await res.json(); // Get JSON response
                showToast('Consultor atualizado com sucesso!', 'success');
                document.getElementById('editConsultantCard').style.display = 'none';

                // Update DOM Row with Server Data
                const row = document.getElementById(`row-consultant-${id}`);
                if (row && data.consultant) {
                    const c = data.consultant;
                    row.querySelector('div[style*="font-weight: 600"]').textContent = c.name;
                    row.querySelector('.user-avatar-sm').textContent = c.name[0].toUpperCase();
                    row.cells[1].textContent = c.email;

                    const editBtn = row.querySelector('button[title="Editar"]');
                    if (editBtn) {
                        editBtn.dataset.name = c.name;
                        editBtn.dataset.email = c.email;
                        // Update stores dataset so the button opens with new data
                        editBtn.dataset.stores = JSON.stringify(c.establishment_ids || []);
                        // No need to update onclick string if it uses this.dataset references, 
                        // but if we do, we must include stores. 
                        // It is safer to rely on the original onclick="openEditConsultant(this.dataset.id...)"
                        // which reads the updated dataset values.
                    }
                }
            }
            else {
                // Handle error
                const errData = await res.json().catch(() => ({}));
                showToast(errData.error || 'Erro ao atualizar', 'error');
            }
        } catch (err) { console.error(err); showToast('Erro', 'error'); }
        finally { if (btn) { btn.disabled = false; btn.innerHTML = 'Salvar'; } }
    }

    async function handleUpdateEst(e) {
        e.preventDefault();
        const id = document.getElementById('edit_est_id').value;
        const form = e.target;
        const btn = document.getElementById('btnUpdateEst');

        if (btn) { btn.disabled = true; btn.innerHTML = 'Salvando...'; }

        try {
            const formData = new FormData(form);
            const res = await fetch(`/manager/establishment/${id}/update`, { method: 'POST', body: formData });

            if (res.ok) {
                const data = await res.json();
                showToast('Estabelecimento atualizado com sucesso!', 'success');
                document.getElementById('editEstCard').style.display = 'none';

                const row = document.getElementById(`row-est-${id}`);
                if (row && data.establishment) {
                    const est = data.establishment;
                    // Update Name
                    const nameDiv = row.querySelector('div[style*="font-weight: 600"]');
                    if (nameDiv) nameDiv.textContent = est.name;

                    // Update Code
                    if (row.cells[1]) row.cells[1].textContent = est.code || '-';

                    // Update Edit Button Data
                    const editBtn = row.querySelector('button[title="Editar"]');
                    if (editBtn) {
                        editBtn.dataset.name = est.name;
                        editBtn.dataset.code = est.code || '';
                    }
                }
            }
            else {
                const errData = await res.json().catch(() => ({}));
                showToast(errData.error || 'Erro ao atualizar', 'error');
            }
        } catch (err) { console.error(err); showToast('Erro', 'error'); }
        finally { if (btn) { btn.disabled = false; btn.innerHTML = 'Salvar'; } }
    }

    async function deleteConsultant(id) {
        if (!confirm('Tem certeza que deseja remover este consultor?')) return;
        try {
            const token = document.querySelector('input[name="csrf_token"]').value;
            const res = await fetch(`/manager/consultant/${id}/delete`, {
                method: 'POST',
                headers: { 'X-CSRFToken': token }
            });
            const data = await res.json();
            if (res.ok) {
                showToast('Consultor removido', 'success');
                const row = document.getElementById(`row-consultant-${id}`);
                if (row) row.remove();
            }
            else showToast(data.error || 'Erro ao remover', 'error');
        } catch (err) { console.error(err); showToast('Erro de conex√£o', 'error'); }
    }
    window.deleteConsultant = deleteConsultant;

    async function deleteEstablishment(id) {
        if (!confirm('Tem certeza que deseja remover este estabelecimento?')) return;
        try {
            const token = document.querySelector('input[name="csrf_token"]').value;
            const res = await fetch(`/manager/establishment/${id}/delete`, {
                method: 'POST',
                headers: { 'X-CSRFToken': token }
            });
            const data = await res.json();
            if (res.ok) {
                showToast('Estabelecimento removido', 'success');
                const row = document.getElementById(`row-est-${id}`);
                if (row) row.remove();
            }
            else showToast(data.error || 'Erro ao remover', 'error');
        } catch (err) { console.error(err); showToast('Erro de conex√£o', 'error'); }
    }
    window.deleteEstablishment = deleteEstablishment;

    // Helper for Status Badges
    function getStatusBadge(status) {
        const s = status || 'UNKNOWN';
        if (s === 'PROCESSING') return '<span class="badge badge-warning">Processando</span>';
        if (s === 'PENDING_MANAGER_REVIEW') return '<span class="badge badge-info">Aguardando Valida√ß√£o</span>';
        if (s === 'APPROVED') return '<span class="badge badge-success">Aprovado</span>';
        if (s === 'COMPLETED') return '<span class="badge badge-success">Conclu√≠do</span>';
        return '<span class="badge badge-secondary">' + s + '</span>';
    }

    // Polling Logic
    async function updateLists() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const estId = urlParams.get('establishment_id') || '';
            const response = await fetch(`/api/status?establishment_id=${estId}&v=` + new Date().getTime());
            const data = await response.json();

            // Pending
            const pendingDiv = document.getElementById('list-pending-container');
            if (pendingDiv && data.pending) {
                if (data.pending.length > 0) {
                    pendingDiv.innerHTML = data.pending.map(item => `
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; font-size: 0.9rem;">
                            <div class="spinner" style="width: 16px; height: 16px; border: 2px solid var(--text-light); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <span style="font-weight: 500; color: var(--text-primary);">${item.name}</span>
                            <span class="badge badge-warning" style="margin-left: auto;">Processando</span>
                        </div>
                    `).join('');
                    const stat = document.getElementById('stat-pending');
                    if (stat) stat.textContent = data.pending.length;
                } else {
                    pendingDiv.innerHTML = '';
                    const stat = document.getElementById('stat-pending');
                    if (stat) stat.textContent = '0';
                }
            }

            // Pending / Processing (Home)
            const homeProcessing = document.getElementById('home-processing');
            const homeProcessingList = document.getElementById('home-processing-list');

            if (homeProcessing && homeProcessingList && data.pending) {
                if (data.pending.length > 0) {
                    homeProcessing.style.display = 'block';
                    homeProcessingList.innerHTML = data.pending.map(item => `
                        <div style="padding: 1rem; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary);">${item.name}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">Iniciado h√° alguns instantes...</div>
                            </div>
                            <span class="badge badge-info">Processando...</span>
                        </div>
                    `).join('');
                } else {
                    homeProcessing.style.display = 'none';
                }
            }

            // Processed
            const tbody = document.getElementById('list-processed-tbody');

            if (tbody && data.processed_raw && data.processed_raw.length > 0) {
                // Main Table
                tbody.innerHTML = data.processed_raw.map(item => `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar avatar-xs bg-light-primary text-primary rounded-circle mr-3">
                                    <i class="ph-bold ph-storefront"></i>
                                </div>
                                <span class="font-weight-medium">${item.establishment}</span>
                            </div>
                        </td>
                        <td>${item.date}</td>
                        <td>${getStatusBadge(item.status)}</td>
                        <td>
                            <a href="${item.review_link}" class="btn btn-sm btn-white border shadow-sm">
                                <i class="ph-bold ph-pencil-simple text-primary"></i> Validar
                            </a>
                        </td>
                    </tr>
                `).join('');

                // ... Home Pendencies logic (condensed for brevity, already robust in previous version, just ensure ID checks)
                const homePendencies = document.getElementById('home-pendencies');
                const homeList = document.getElementById('home-pendencies-list');

                const pendingValidation = data.processed_raw.filter(i =>
                    i.status === 'PENDING_MANAGER_REVIEW' || i.status === 'WAITING_APPROVAL'
                );

                if (homePendencies && homeList) {
                    if (pendingValidation.length > 0) {
                        homePendencies.style.display = 'block';
                        homeList.innerHTML = pendingValidation.map(item => `
                            <div style="padding: 1rem; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary);">${item.establishment}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Realizada em ${item.date}</div>
                                </div>
                                <a href="${item.review_link}" class="btn btn-sm btn-accent">
                                    <i class="ph ph-check-square-offset"></i> Validar Agora
                                </a>
                            </div>
                        `).join('');
                    } else {
                        homePendencies.style.display = 'none';
                    }
                }
            } else if (tbody) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">Nenhuma vistoria encontrada.</td></tr>';
            }

        } catch (e) {
            console.error("Erro no polling:", e);
            const tbody = document.getElementById('list-processed-tbody');
            // Show error only if we were still loading or if data is missing
            if (tbody && (tbody.innerText.includes('Carregando') || tbody.innerText.trim() === '')) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-danger"><i class="ph-bold ph-warning-circle"></i> Erro de conex√£o. <a href="#" onclick="updateLists(); return false;">Tentar novamente</a></td></tr>`;
            }
        }
    }

    function getStatusBadge(status) {
        // Map backend enum to UI Badge
        const map = {
            'PROCESSING': { class: 'badge-primary', text: 'Processando' },
            'PENDING_MANAGER_REVIEW': { class: 'badge-warning', text: 'Aguardando Aprova√ß√£o' },
            'WAITING_APPROVAL': { class: 'badge-warning', text: 'Aguardando Aprova√ß√£o' },
            'APPROVED': { class: 'badge-success', text: 'Aprovado' },
            'PENDING_VERIFICATION': { class: 'badge-info', text: 'Em Verifica√ß√£o' },
            'COMPLETED': { class: 'badge-success', text: 'Conclu√≠do' },
            'REJECTED': { class: 'badge-danger', text: 'Rejeitado' }
        };

        const badge = map[status] || { class: 'badge-secondary', text: status || 'Desconhecido' };
        return `<span class="badge ${badge.class}">${badge.text}</span>`;
    }

    // Iniciar Polling
    updateLists();
    setInterval(updateLists, 15000);
</script>

<style>
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>

{% endblock %}