{% extends "layout.html" %}

{% block title %}Dashboard Gestor | InspetorAI{% endblock %}

{% block content %}


<style>
    /* Critical Grid Layout Force - Zero Defect */
    .admin-wrapper-grid {
        display: grid !important;
        grid-template-columns: 280px 1fr !important;
        min-height: calc(100vh - 72px) !important;
        width: 100% !important;
        background: #f8fafc;
    }

    .admin-sidebar-cell {
        background: white;
        border-right: 1px solid #e2e8f0;
        height: calc(100vh - 72px);
        position: sticky;
        top: 72px;
        overflow-y: auto;
    }

    .admin-content-cell {
        padding: 2rem;
        /* Added padding to fix overflow */
        overflow-x: hidden;
        width: 100% !important;
    }

    @media (max-width: 1024px) {
        .admin-wrapper-grid {
            grid-template-columns: 1fr !important;
        }

        .admin-sidebar-cell {
            display: none;
        }

        /* Mobile implementation pending, keep simple for now */
    }

    /* Tabela Profissional - Zero Defect Alignment */
    .modern-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 1rem;
    }

    .modern-table th {
        background: #f1f5f9;
        padding: 0.75rem 1rem;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        color: var(--text-light);
        letter-spacing: 0.05em;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
    }

    .modern-table td {
        padding: 1rem;
        vertical-align: middle;
        border-bottom: 1px solid #f1f5f9;
        font-size: 0.9rem;
        color: var(--text-primary);
    }

    .modern-table tr:last-child td {
        border-bottom: none;
    }

    .modern-table tr:hover td {
        background: #f8fafc;
    }

    .text-right {
        text-align: right !important;
    }

    .text-center {
        text-align: center !important;
    }

    .user-avatar-sm {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: linear-gradient(135deg, var(--accent-color), #6366f1);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.85rem;
    }

    .btn-icon-group {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
    }

    /* Local action icons replaced by global btn-icon classes in style.css */
</style>
<script>
    // ... previous scripts ...

    window.openEditEst = function (id, name, code, respName, respEmail, respPhone) {
        document.getElementById('createEstCard').style.display = 'none';
        const card = document.getElementById('editEstCard');
        card.style.display = 'block';

        document.getElementById('edit_est_id').value = id;
        document.getElementById('edit_est_name').value = name;
        document.getElementById('edit_est_code').value = code || '';
        document.getElementById('edit_est_resp_name').value = respName || '';
        document.getElementById('edit_est_resp_email').value = respEmail || ''; // Populating Email
        document.getElementById('edit_est_resp_phone').value = respPhone || '';

        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    // Update DOM after Save
    // Inside handleUpdateEst...
    // if (row && data.establishment) {
    //    ...
    //    // Update Edit Button Data
    //    const editBtn = row.querySelector('button[title="Editar"]');
    //    if (editBtn) {
    //        editBtn.dataset.name = est.name;
    //        ...
    //        editBtn.dataset.respEmail = est.responsible_email || ''; // Update Dataset
    //    }
    // }
</script>

<div class="admin-wrapper-grid">
    <!-- Sidebar -->
    <aside class="admin-sidebar-cell admin-sidebar">
        <h3
            style="margin-bottom: 2rem; font-size: 1.1rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
            <i class="ph-fill ph-briefcase" style="color: var(--accent-color);"></i>
            Gest√£o
        </h3>

        <div class="sidebar-header">Principal</div>
        <ul class="sidebar-menu">
            <li class="sidebar-item active" id="menu-overview" onclick="showSection('overview', this)">
                <div class="sidebar-dot"></div> Vis√£o Geral
            </li>
            <li class="sidebar-item" id="menu-est" onclick="showSection('establishments-view', this)">
                <div class="sidebar-dot"></div> Lojas
            </li>
            <li class="sidebar-item" id="menu-consultant" onclick="showSection('consultants-view', this)">
                <div class="sidebar-dot"></div> Consultores
            </li>
        </ul>

        <!-- Filter (moved to sidebar bottom area) -->
        <div style="margin-top: auto; padding-top: 2rem;">
            <form id="filterForm" action="{{ url_for('manager.dashboard_manager') }}" method="GET">
                <label class="form-label" style="font-size: 0.75rem; color: var(--text-light);">FILTRAR POR LOJA</label>
                <select name="establishment_id" onchange="handleFilterChange(this)" class="form-control"
                    style="font-size: 0.85rem;">
                    <option value="">Todas as Lojas</option>
                    {% for est in all_establishments %}
                    <option value="{{ est.id }}" {% if selected_est_id==est.id|string %}selected{% endif %}>
                        {{ est.name }}
                    </option>
                    {% endfor %}
                </select>
            </form>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-content-cell admin-main">
        <div class="content-wrapper">
            <!-- 1. Overview Section -->
            <div id="overview" class="section-view active">
                <!-- ... content ... -->
                <!-- (Mantendo o conte√∫do interno existente, apenas ajustando o wrapper) -->

                <!-- Modern Header -->
                <div style="margin-bottom: 2.5rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <div>
                            <span
                                style="font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: var(--accent-color); letter-spacing: 0.05em; display: block; margin-bottom: 0.25rem;">
                                {% set selected_name = 'Painel do Gestor' %}
                                {% if selected_est_id %}
                                {% for est in all_establishments %}
                                {% if est.id|string == selected_est_id %}
                                {% set selected_name = 'Loja: ' ~ est.name %}
                                {% endif %}
                                {% endfor %}
                                {% endif %}
                                {{ selected_name }}
                            </span>
                            <h1
                                style="font-size: 2.5rem; font-weight: 700; color: var(--text-primary); letter-spacing: -0.02em; margin: 0;">
                                Ol√°, {{ current_user.name.split()[0] }} <span
                                    style="animation: wave 2s infinite; display: inline-block; transform-origin: 70% 70%;">üëã</span>
                            </h1>
                        </div>
                        <div style="text-align: right;">
                            <div
                                style="background: white; padding: 0.5rem 1rem; border-radius: 50px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; font-weight: 500; color: var(--text-secondary); border: 1px solid rgba(0,0,0,0.02);">
                                <i class="ph-fill ph-calendar-blank" style="color: var(--accent-color);"></i>
                                <span style="text-transform: capitalize;">
                                    <script>document.write(new Date().toLocaleDateString('pt-BR', { weekday: 'short', day: 'numeric', month: 'long' }))</script>
                                </span>
                            </div>
                        </div>
                    </div>
                    <!-- <p class="text-muted">Gerencie sua equipe e estabelecimentos.</p> -->
                </div>

                <style>
                    @keyframes wave {
                        0% {
                            transform: rotate(0.0deg)
                        }

                        10% {
                            transform: rotate(14.0deg)
                        }

                        20% {
                            transform: rotate(-8.0deg)
                        }

                        30% {
                            transform: rotate(14.0deg)
                        }

                        40% {
                            transform: rotate(-4.0deg)
                        }

                        50% {
                            transform: rotate(10.0deg)
                        }

                        60% {
                            transform: rotate(0.0deg)
                        }

                        100% {
                            transform: rotate(0.0deg)
                        }
                    }
                </style>

                <!-- üö® NOVO: Card de Urg√™ncia para Planos Pendentes -->
                <div id="urgent-approval-card" class="card"
                    style="margin-bottom: 2rem; border: 2px solid #dc2626; background: linear-gradient(135deg, #fef2f2 0%, #fff 100%); display: none; animation: pulse 2s infinite;">
                    <div class="card-body" style="padding: 1.5rem;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div
                                    style="width: 60px; height: 60px; border-radius: 50%; background: #dc2626; display: flex; align-items: center; justify-content: center; animation: shake 0.5s infinite;">
                                    <i class="ph-fill ph-warning-circle" style="font-size: 2rem; color: white;"></i>
                                </div>
                                <div>
                                    <h3 style="margin: 0; color: #dc2626; font-size: 1.3rem; font-weight: 700;">Planos
                                        de A√ß√£o Aguardando Aprova√ß√£o</h3>
                                    <p style="margin: 0.25rem 0 0 0; color: #991b1b; font-size: 0.95rem;">
                                        <span id="urgent-count">0</span> plano(s) precisam da sua an√°lise urgente
                                    </p>
                                </div>
                            </div>
                            <button onclick="scrollToApprovals()" class="btn"
                                style="background: #dc2626; color: white; padding: 0.75rem 1.5rem; font-weight: 600; border: none; cursor: pointer; border-radius: 8px; animation: pulse 1.5s infinite;">
                                <i class="ph-bold ph-check-circle"></i> Aprovar Agora
                            </button>
                        </div>
                    </div>
                </div>

                <style>
                    @keyframes pulse {

                        0%,
                        100% {
                            transform: scale(1);
                        }

                        50% {
                            transform: scale(1.02);
                        }
                    }

                    @keyframes shake {

                        0%,
                        100% {
                            transform: rotate(0deg);
                        }

                        25% {
                            transform: rotate(-5deg);
                        }

                        75% {
                            transform: rotate(5deg);
                        }
                    }
                </style>

                <div class="stats-grid">
                    <div class="stat-card" onclick="document.getElementById('menu-est').click()">
                        <span class="stat-label">Estabelecimentos</span>
                        <span class="stat-value">{{ establishments|length if establishments else 0 }}</span>
                        <div class="stat-trend trend-up"><i class="ph-bold ph-trend-up"></i> Conectados</div>
                    </div>
                    <div class="stat-card" onclick="document.getElementById('menu-consultant').click()">
                        <span class="stat-label">Consultores</span>
                        <span class="stat-value">{{ consultants|length if consultants else 0 }}</span>
                        <div class="stat-trend trend-up"><i class="ph-bold ph-users"></i> Ativos</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--accent-color); background: #EFF6FF;"
                        onclick="document.getElementById('home-processing').scrollIntoView({behavior: 'smooth'})">
                        <span class="stat-label" style="color: var(--accent-color);">Em Processamento</span>
                        <span class="stat-value" id="stat-pending" style="color: var(--accent-color);">0</span>
                        <div class="stat-trend" style="color: var(--accent-color);"><i class="ph-bold ph-hourglass"></i>
                            Ver
                            Status</div>
                    </div>
                    <!-- NOVO: Card de Pendentes -->
                    <div class="stat-card" id="stat-card-approvals"
                        style="border-color: #dc2626; background: #fef2f2; cursor: pointer; display: none;"
                        onclick="scrollToApprovals()">
                        <span class="stat-label" style="color: #dc2626;">Aguardando Aprova√ß√£o</span>
                        <span class="stat-value" id="stat-approvals" style="color: #dc2626;">0</span>
                        <div class="stat-trend" style="color: #dc2626;"><i class="ph-bold ph-warning"></i> Urgente</div>
                    </div>
                </div>

                <!-- ÔøΩ New: Itens em Processamento section -->
                <div id="home-processing" class="card" style="margin-top: 2.5rem; display: none;">
                    <div class="card-header" style="background: #f0f9ff; border-bottom: 1px solid #e0f2fe;">
                        <h3 class="card-title" style="color: #0369a1;"><i
                                class="ph-bold ph-arrows-clockwise ph-spin"></i> Em Processamento pela IA</h3>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div id="home-processing-list">
                            <!-- Populated via JS -->
                        </div>
                    </div>
                </div>

                <!-- REMOVIDO: A√ß√µes Pendentes de Valida√ß√£o (Redundante) -->
                <div id="home-pendencies" style="display: none !important;"></div>



                <!-- üìä Vistorias Realizadas section (Primary Focus) -->
                <div class="card" style="margin-top: 2rem; min-height: 400px;">
                    <div class="card-header">
                        <h3 class="card-title">Hist√≥rico de Vistorias</h3>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                            <i class="ph-fill ph-circle" style="color: var(--success-color); font-size: 0.6rem;"></i>
                            Tempo Real
                        </div>
                    </div>
                    <div id="list-pending-container"
                        style="padding: 1rem; background: #F8FAFC; border-bottom: 1px solid var(--border-color); display:none;">
                    </div>
                    <div class="card-body" style="padding:0;">
                        <div class="table-container" id="tabela-planos">
                            <table class="modern-table">
                                <thead>
                                    <tr>
                                        <th>Estabelecimento</th>
                                        <th>Data/Hora</th>
                                        <th>Status</th>
                                        <th>A√ß√£o</th>
                                    </tr>
                                </thead>
                                <tbody id="list-processed-tbody">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted" style="padding: 2rem;">
                                            Carregando vistorias...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>


            </div>

            <!-- 2. Establishments Section -->
            <div id="establishments-view" class="section-view">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 2rem;">
                    <h1 style="font-size: 1.8rem; margin:0;">Gerenciar Lojas</h1>
                    <button class="btn btn-accent" onclick="toggleCreateEst()">
                        <i class="ph-bold ph-storefront"></i> Nova Loja
                    </button>
                </div>

                <!-- Create Est Card -->
                <div class="card" id="createEstCard" style="display:none; margin-bottom:2rem;">
                    <div class="card-body">
                        <form id="formCreateEst" class="no-ajax" onsubmit="handleCreateEstablishment(event)">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem;">
                                <div><label class="form-label">Nome</label><input name="name" class="form-control"
                                        required placeholder="Ex: Matriz"></div>
                                <div><label class="form-label">C√≥digo</label><input name="code" class="form-control"
                                        placeholder="LOJA-01"></div>
                            </div>
                            <hr style="margin:1rem 0; border-color:#f1f5f9;">
                            <h6 style="color:var(--text-secondary); margin-bottom:1rem; font-size:0.85rem;">Respons√°vel
                                (Contato)</h6>
                            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:1rem;">
                                <div><label class="form-label">Nome</label><input name="responsible_name"
                                        class="form-control"></div>
                                <div><label class="form-label">Email (Recebimento de Relat√≥rios)</label><input
                                        type="email" name="responsible_email" class="form-control"
                                        placeholder="email@loja.com"></div>
                                <div><label class="form-label">Telefone</label><input name="responsible_phone"
                                        class="form-control"></div>
                            </div>
                            <div class="text-right" style="margin-top:1rem;">
                                <button type="button" class="btn btn-secondary"
                                    onclick="toggleCreateEst()">Cancelar</button>
                                <button type="submit" class="btn btn-accent" id="btnCreateEst">Salvar Loja</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Edit Est Card -->
                <div class="card" id="editEstCard" style="display:none; margin-bottom:2rem; border:1px solid #3b82f6;">
                    <div class="card-header" style="background:none; padding-bottom:0;">
                        <h4 style="margin:0; color:#1e40af;">Editar Loja</h4>
                    </div>
                    <div class="card-body">
                        <form id="editEstForm" onsubmit="handleUpdateEst(event)">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" id="edit_est_id">
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem;">
                                <div><label class="form-label">Nome</label><input id="edit_est_name" name="name"
                                        class="form-control" required></div>
                                <div><label class="form-label">C√≥digo</label><input id="edit_est_code" name="code"
                                        class="form-control"></div>
                            </div>
                            <hr style="margin:1rem 0; border-color:#e2e8f0;">
                            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:1rem;">
                                <div><label class="form-label">Nome Resp.</label><input id="edit_est_resp_name"
                                        name="responsible_name" class="form-control"></div>
                                <div><label class="form-label">Email (Relat√≥rios)</label><input id="edit_est_resp_email"
                                        name="responsible_email" class="form-control"></div>
                                <div><label class="form-label">Tel Resp.</label><input id="edit_est_resp_phone"
                                        name="responsible_phone" class="form-control"></div>
                            </div>
                            <div class="text-right" style="margin-top:1rem;">
                                <button type="button" class="btn btn-secondary"
                                    onclick="document.getElementById('editEstCard').style.display='none'">Cancelar</button>
                                <button type="submit" class="btn btn-primary" id="btnUpdateEst">Atualizar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>C√≥digo</th>
                                    <th class="text-right">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="table-establishments-body">
                                {% for est in establishments %}
                                <tr id="row-est-{{ est.id }}">
                                    <td>
                                        <div style="display:flex; align-items:center; gap:0.75rem;">
                                            <div class="user-avatar-sm"
                                                style="background: linear-gradient(135deg, #10b981, #059669);">
                                                <i class="ph ph-storefront"></i>
                                            </div>
                                            <div style="font-weight: 600;">{{ est.name }}</div>
                                        </div>
                                    </td>
                                    <td style="font-family: monospace; color: var(--text-secondary);">{{ est.code or '-'
                                        }}</td>
                                    <td class="text-right">
                                        <div class="btn-icon-group">
                                            <button class="btn-icon btn-icon-edit" data-id="{{ est.id }}"
                                                data-name="{{ est.name }}" data-code="{{ est.code or '' }}"
                                                data-resp-name="{{ est.responsible_name or '' }}"
                                                data-resp-email="{{ est.responsible_email or '' }}"
                                                data-resp-phone="{{ est.responsible_phone or '' }}"
                                                onclick="openEditEst(this.dataset.id, this.dataset.name, this.dataset.code, this.dataset.respName, this.dataset.respEmail, this.dataset.respPhone)"
                                                title="Editar">
                                                <i class="ph-bold ph-pencil-simple"></i>
                                            </button>
                                            <button class="btn-icon btn-icon-delete"
                                                onclick="deleteEstablishment('{{ est.id }}', '{{ est.name }}')"
                                                title="Remover">
                                                <i class="ph-bold ph-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. Consultants Section -->
        <div id="consultants-view" class="section-view">
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 2rem; margin-top: 1rem;">
                <h1 style="font-size: 1.8rem; margin:0;">Gerenciar Consultores</h1>
                <button class="btn btn-primary" onclick="toggleCreateConsultant()">
                    <i class="ph-bold ph-user-plus"></i> Novo Consultor
                </button>
            </div>

            <!-- Create Consultant Card -->
            <div class="card" id="createConsultantCard" style="display:none; margin-bottom:2rem;">
                <div class="card-body">
                    <form id="formCreateConsultant" class="no-ajax" onsubmit="handleCreateConsultant(event)">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem;">
                            <div><label class="form-label">Nome</label><input name="name" class="form-control" required>
                            </div>
                            <div><label class="form-label">Email</label><input type="email" name="email"
                                    class="form-control" required></div>
                        </div>
                        <div style="margin-top:1rem;">
                            <label class="form-label">Vincular Lojas</label>
                            <div
                                style="max-height:150px; overflow-y:auto; border:1px solid #e2e8f0; padding:0.5rem; border-radius:4px;">
                                {% for est in all_establishments %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="establishment_ids"
                                        value="{{ est.id }}" id="chk-{{ est.id }}">
                                    <label class="form-check-label" for="chk-{{ est.id }}">{{ est.name }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="text-right" style="margin-top:1rem;">
                            <button type="button" class="btn btn-secondary"
                                onclick="toggleCreateConsultant()">Cancelar</button>
                            <button type="submit" class="btn btn-primary" id="btnCreateConsultant">Salvar</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Edit Consultant Card -->
            <div class="card" id="editConsultantCard"
                style="display:none; margin-bottom:2rem; border:1px solid #3b82f6;">
                <div class="card-header" style="background:none; padding-bottom:0;">
                    <h4 style="margin:0; color:#1e40af;">Editar Consultor</h4>
                </div>
                <div class="card-body">
                    <form id="editConsultantForm" onsubmit="handleUpdateConsultant(event)">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" id="edit_consultant_id">
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem;">
                            <div><label class="form-label">Nome</label><input id="edit_consultant_name" name="name"
                                    class="form-control" required></div>
                            <div><label class="form-label">Email</label><input id="edit_consultant_email" name="email"
                                    class="form-control" required></div>
                        </div>
                        <div style="margin-top:1rem;">
                            <label class="form-label">Lojas Vinculadas</label>
                            <select id="edit_consultant_ests" name="establishment_ids" class="form-control" multiple
                                style="height:120px;">
                                {% for est in all_establishments %}
                                <option value="{{ est.id }}">{{ est.name }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Segure Ctrl/Cmd para selecionar m√∫ltiplas.</small>
                        </div>
                        <div style="margin-top:1rem;">
                            <label class="form-label">Nova Senha (Opcional)</label>
                            <input type="password" name="password" class="form-control"
                                placeholder="Deixar em branco para manter">
                        </div>
                        <div class="text-right" style="margin-top:1rem;">
                            <button type="button" class="btn btn-secondary"
                                onclick="document.getElementById('editConsultantCard').style.display='none'">Cancelar</button>
                            <button type="submit" class="btn btn-primary" id="btnUpdateConsultant">Atualizar</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="table-container">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th class="text-right">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="table-consultants-body">
                            {% for consultant in consultants %}
                            <tr id="row-consultant-{{ consultant.id }}">
                                <td>
                                    <div style="display:flex; align-items:center; gap:0.75rem;">
                                        <div class="user-avatar-sm">{{ consultant.name[0].upper() }}</div>
                                        <div style="font-weight: 600;">{{ consultant.name }}</div>
                                    </div>
                                </td>
                                <td style="color: var(--text-secondary);">{{ consultant.email }}</td>
                                <td class="text-right">
                                    <div class="btn-icon-group">
                                        <button class="btn-icon btn-icon-edit" data-id="{{ consultant.id }}"
                                            data-name="{{ consultant.name }}" data-email="{{ consultant.email }}"
                                            data-stores='[{% for est in consultant.establishments %}"{{ est.id }}"{{ "," if not loop.last }}{% endfor %}]'
                                            onclick="openEditConsultant(this.dataset.id, this.dataset.name, this.dataset.email, this.dataset.stores)"
                                            title="Editar">
                                            <i class="ph-bold ph-pencil-simple"></i>
                                        </button>
                                        <button class="btn-icon btn-icon-delete"
                                            onclick="deleteConsultant('{{ consultant.id }}', '{{ consultant.name }}')"
                                            title="Remover">
                                            <i class="ph-bold ph-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="3" class="text-center text-muted">Nenhum consultor.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
</div>



</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

</div>
</div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        // Attach Event Listeners
        const formConsultant = document.getElementById('formCreateConsultant');
        // formConsultant already has onsubmit in HTML
        // if (formConsultant) formConsultant.addEventListener('submit', handleCreateConsultant);

        // formCreateEst already has onsubmit in HTML - do NOT add duplicate listener
        // const formEst = document.getElementById('formCreateEst');
        // if (formEst) formEst.addEventListener('submit', handleCreateEstablishment);

        // Edit Forms are in modals
        const formEditConsultant = document.getElementById('editConsultantForm');
        if (formEditConsultant) {
            formEditConsultant.onsubmit = null;
            formEditConsultant.addEventListener('submit', handleUpdateConsultant);
        }

        const formEditEst = document.getElementById('editEstForm');
        if (formEditEst) {
            formEditEst.onsubmit = null;
            formEditEst.addEventListener('submit', handleUpdateEst);
        }

        // Initialize View (Critical for Navigation)
        const menuOverview = document.getElementById('menu-overview');
        if (menuOverview) showSection('overview', menuOverview);

        // Initial Load Only (No Polling)
        updateLists();

        // Inject Loading Overlay
        const loaderHTML = `
        <div id="premium-loader" style="display:none; position:fixed; inset:0; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); z-index: 10000; align-items:center; justify-content:center; flex-direction:column; animation: fadeIn 0.3s ease;">
            <div style="width: 50px; height: 50px; border: 4px solid #e2e8f0; border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <div style="margin-top:1.5rem; font-weight:600; color:var(--text-primary); font-size: 1.1rem; letter-spacing: -0.02em;">Atualizando...</div>
        </div>
        <style>@keyframes spin { to { transform: rotate(360deg); } } @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }<` + `/style>
    `;
        document.body.insertAdjacentHTML('beforeend', loaderHTML);

        // --- PREMIUM UI: INPUT MASKS & VALIDATION ---
        // Phone Mask (Celular/Fixo)
        const phoneInputs = document.querySelectorAll('input[name="responsible_phone"]');
        phoneInputs.forEach(input => {
            input.placeholder = "(00) 00000-0000";
            input.addEventListener('input', function (e) {
                let v = e.target.value.replace(/\D/g, "");

                // Limit length (11 digits for cell, 10 for landline)
                if (v.length > 11) v = v.substring(0, 11);

                if (v.length > 10) {
                    // Cell: (11) 91234-5678
                    v = v.replace(/^(\d\d)(\d{5})(\d{4}).*/, "($1) $2-$3");
                } else if (v.length > 5) {
                    v = v.replace(/^(\d\d)(\d{4})(\d{0,4}).*/, "($1) $2-$3");
                } else if (v.length > 2) {
                    v = v.replace(/^(\d\d)(\d{0,5}).*/, "($1) $2");
                } else {
                    v = v.replace(/^(\d*)/, "($1");
                }

                e.target.value = v;

                // Visual Feedback
                if (v.length >= 14) { // Min length for valid mask
                    input.style.borderColor = '#10B981';
                    input.style.backgroundColor = '#ecfdf5';
                } else {
                    input.style.borderColor = '';
                    input.style.backgroundColor = '';
                }
            });
        });
    });

    window.showLoading = function () {
        const loader = document.getElementById('premium-loader');
        if (loader) loader.style.display = 'flex';
    };

    window.handleFilterChange = function (select) {
        showLoading();
        if (select.value === "") {
            window.location.href = "{{ url_for('manager.dashboard_manager') }}";
        } else {
            select.form.submit();
        }
    };

    // Validations & Logic
    function showSection(sectionId, element) {
        document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
        if (element) element.classList.add('active');
        document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
        const target = document.getElementById(sectionId);
        if (target) target.classList.add('active');
    }

    // Explicitly expose to window since they are called from inline onclicks (HTML attributes)
    window.showSection = showSection;

    function switchTab(tabId, element) {
        document.querySelectorAll('.action-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.action-tab').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        if (element) element.classList.add('active');
    }
    window.switchTab = switchTab;

    function openEditConsultant(id, name, email, storesJson) {
        document.getElementById('editConsultantCard').style.display = 'block';
        document.getElementById('edit_consultant_id').value = id;
        document.getElementById('edit_consultant_name').value = name;
        document.getElementById('edit_consultant_email').value = email;

        // Logic for Select Multiple
        const select = document.getElementById('edit_consultant_ests');
        if (select) {
            // Reset selection
            Array.from(select.options).forEach(opt => opt.selected = false);

            try {
                let stores = [];
                if (storesJson) {
                    if (typeof storesJson === 'string') stores = JSON.parse(storesJson);
                    else stores = storesJson;
                }

                if (Array.isArray(stores)) {
                    stores.forEach(estId => {
                        // Loose equality to handle int/string diffs
                        const opt = Array.from(select.options).find(o => o.value == estId);
                        if (opt) opt.selected = true;
                    });
                }
            } catch (e) {
                console.error("Error parsing stores:", e);
            }
        }

        window.scrollTo(0, 0);
    }
    window.openEditConsultant = openEditConsultant;

    function openEditEst(id, name, code, respName, respEmail, respPhone) {
        document.getElementById('editEstCard').style.display = 'block';
        document.getElementById('edit_est_id').value = id;
        document.getElementById('edit_est_name').value = name;
        document.getElementById('edit_est_code').value = code;
        document.getElementById('edit_est_resp_name').value = respName || '';
        document.getElementById('edit_est_resp_email').value = respEmail || ''; // [FIX] Populate Email
        document.getElementById('edit_est_resp_phone').value = respPhone || '';
        window.scrollTo(0, 0);
    }
    window.openEditEst = openEditEst;

    // Modal Helpers
    let createConsultantModal, createEstModal;
    document.addEventListener('DOMContentLoaded', () => {
        const elC = document.getElementById('createConsultantModal');
        if (elC) createConsultantModal = new bootstrap.Modal(elC);

        const elE = document.getElementById('createEstModal');
        if (elE) createEstModal = new bootstrap.Modal(elE);
    });

    // Simplified Toggle Logic (No Modals)
    window.toggleCreateEst = function () {
        const el = document.getElementById('createEstCard');
        const editEl = document.getElementById('editEstCard');
        if (el.style.display === 'none') {
            el.style.display = 'block';
            editEl.style.display = 'none';
        } else {
            el.style.display = 'none';
        }
    };

    window.toggleCreateConsultant = function () {
        const el = document.getElementById('createConsultantCard');
        const editEl = document.getElementById('editConsultantCard');
        if (el.style.display === 'none') {
            el.style.display = 'block';
            editEl.style.display = 'none';
        } else {
            el.style.display = 'none';
        }
    };

    window.openEditEst = function (id, name, code, respName, respEmail, respPhone) {
        document.getElementById('createEstCard').style.display = 'none';
        const card = document.getElementById('editEstCard');
        card.style.display = 'block';

        document.getElementById('edit_est_id').value = id;
        document.getElementById('edit_est_name').value = name;
        document.getElementById('edit_est_code').value = code || '';
        document.getElementById('edit_est_resp_name').value = respName || '';
        document.getElementById('edit_est_resp_email').value = respEmail || '';
        document.getElementById('edit_est_resp_phone').value = respPhone || '';

        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    window.openEditConsultant = function (id, name, email, storesJson) {
        document.getElementById('createConsultantCard').style.display = 'none';
        const card = document.getElementById('editConsultantCard');
        card.style.display = 'block';

        document.getElementById('edit_consultant_id').value = id;
        document.getElementById('edit_consultant_name').value = name;
        document.getElementById('edit_consultant_email').value = email;

        // Handle Multi-Select (Select element now)
        const select = document.getElementById('edit_consultant_ests');
        if (select) {
            Array.from(select.options).forEach(opt => opt.selected = false);
            try {
                let stores = [];
                if (storesJson) {
                    if (typeof storesJson === 'string') stores = JSON.parse(storesJson);
                    else stores = storesJson;
                }
                if (Array.isArray(stores)) {
                    stores.forEach(estId => {
                        const opt = Array.from(select.options).find(o => o.value == estId);
                        if (opt) opt.selected = true;
                    });
                }
            } catch (e) { console.error(e); }
        }
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };


    // --- TOAST NOTIFICATION SYSTEM ---
    function showToast(message, type = 'success') {
        const toastId = 'toast-' + Math.random().toString(36).substr(2, 9);
        const color = type === 'success' ? '#10b981' : '#ef4444';
        const bg = type === 'success' ? '#ecfdf5' : '#fef2f2';

        const html = `
            <div id="${toastId}" style="
                position: fixed; top: 20px; right: 20px; z-index: 9999;
                background: ${bg}; border-left: 4px solid ${color};
                padding: 1rem 1.5rem; border-radius: 6px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
                display: flex; align-items: center; gap: 12px;
                transform: translateX(100%); transition: transform 0.3s ease-out;
            ">
                <i class="ph-bold ${type === 'success' ? 'ph-check-circle' : 'ph-warning-circle'}" style="color: ${color}; font-size: 1.2rem;"></i>
                <div style="font-weight: 500; color: #1f2937;">${message}</div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', html);

        setTimeout(() => {
            const el = document.getElementById(toastId);
            if (el) el.style.transform = 'translateX(0)';
        }, 100);

        setTimeout(() => {
            const el = document.getElementById(toastId);
            if (el) {
                el.style.transform = 'translateX(120%)';
                setTimeout(() => el.remove(), 300);
            }
        }, 4000);
    }
    window.showToast = showToast; // Good practice to expose if needed, though internal mostly

    // --- CREATE ACTIONS ---
    async function handleCreateConsultant(e) {
        e.preventDefault();
        const form = e.target;
        const btn = document.getElementById('btnCreateConsultant');
        if (btn) { btn.disabled = true; btn.innerHTML = 'Criando...'; }

        try {
            const formData = new FormData(form);
            const token = document.querySelector('input[name="csrf_token"]').value;
            const res = await fetch("{{ url_for('manager.create_consultant') }}", {
                method: 'POST',
                body: formData,
                headers: {
                    'Accept': 'application/json',
                    'X-CSRFToken': token
                }
            });
            const data = await res.json();

            if (res.ok) {
                showToast(data.message, 'success');
                form.reset();
                // Explicitly hide instead of toggle
                const card = document.getElementById('createConsultantCard');
                if (card) {
                    card.style.display = 'none';
                    // Reset button text/icon if needed, though toggle handles text usually. 
                    // Let's call toggle IF it checks display, but cleaner to just hide.
                    // If toggle logic depends on checking display, calling it again might show it if we just hid it? 
                    // Let's use the explicit logic the user asked for: "somente abrir se ele clicar novamente"
                    const btn = document.getElementById('btnToggleConsultant');
                    if (btn) btn.innerHTML = '<i class="ph-bold ph-plus"></i> Novo Consultor';
                }
                // Add row to table
                const tbody = document.getElementById('table-consultants-body');
                if (tbody) {
                    const c = data.consultant;
                    if (tbody.innerHTML.includes('Nenhum consultor')) tbody.innerHTML = '';

                    const newRow = `
                        <tr id="row-consultant-${c.id}" style="animation: fadeIn 0.5s;">
                            <td>
                                <div style="display:flex; align-items:center; gap:0.75rem;">
                                    <div class="user-avatar-sm">${c.name[0].toUpperCase()}</div>
                                    <div style="font-weight: 600;">${c.name}</div>
                                </div>
                            </td>
                            <td style="color: var(--text-secondary);">${c.email}</td>
                            <td class="text-right">
                                <div class="btn-icon-group">
                                    <button class="btn-icon btn-icon-edit" data-id="${c.id}" data-name="${c.name}" data-email="${c.email}"
                                        data-stores='${JSON.stringify(c.establishment_ids || [])}'
                                        onclick="openEditConsultant(this.dataset.id, this.dataset.name, this.dataset.email, this.dataset.stores)" title="Editar">
                                        <i class="ph-bold ph-pencil-simple"></i>
                                    </button>
                                    <button class="btn-icon btn-icon-delete"
                                        onclick="deleteConsultant('${c.id}', '${c.name}')" title="Remover">
                                        <i class="ph-bold ph-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', newRow);
                }
            } else {
                showToast(data.error || 'Erro desconhecido', 'error');
            }
        } catch (err) {
            console.error(err);
            showToast('Erro de conex√£o: ' + err.message, 'error');
        } finally {
            if (btn) { btn.disabled = false; btn.innerHTML = 'Salvar'; }
        }
    }

    async function handleCreateEstablishment(e) {
        e.preventDefault();
        const form = e.target;
        const btn = document.getElementById('btnCreateEst');
        if (btn) { btn.disabled = true; btn.innerHTML = 'Adicionando...'; }

        try {
            const formData = new FormData(form);
            const token = document.querySelector('input[name="csrf_token"]').value;
            const res = await fetch("{{ url_for('manager.create_establishment') }}", {
                method: 'POST',
                body: formData,
                headers: {
                    'Accept': 'application/json',
                    'X-CSRFToken': token
                }
            });
            const data = await res.json();

            if (res.ok) {
                showToast(data.message, 'success');
                form.reset();
                // Explicitly hide
                const card = document.getElementById('createEstCard');
                if (card) {
                    card.style.display = 'none';
                    const btn = document.getElementById('btnToggleEst');
                    if (btn) btn.innerHTML = '<i class="ph-bold ph-plus"></i> Nova Loja';
                }

                // Add row to table management
                const tbody = document.getElementById('table-establishments-body');
                if (tbody) {
                    const est = data.establishment;
                    const newRow = `
                        <tr id="row-est-${est.id}" style="animation: fadeIn 0.5s;">
                            <td>
                                <div style="display:flex; align-items:center; gap:0.75rem;">
                                    <div class="user-avatar-sm" style="background: linear-gradient(135deg, #10b981, #059669);">
                                        <i class="ph ph-storefront"></i>
                                    </div>
                                    <div style="font-weight: 600; font-size:1rem;">${est.name}</div>
                                </div>
                            </td>
                            <td style="font-family: monospace; color: var(--text-secondary);">${est.code || '-'}</td>
                            <td class="text-right">
                                <div class="btn-icon-group">
                                    <button class="btn-icon btn-icon-edit" data-id="${est.id}" data-name="${est.name}" data-code="${est.code || ''}"
                                        data-resp-name="${est.responsible_name || ''}"
                                        data-resp-email="${est.responsible_email || ''}"
                                        data-resp-phone="${est.responsible_phone || ''}"
                                        onclick="openEditEst(this.dataset.id, this.dataset.name, this.dataset.code, this.dataset.respName, this.dataset.respEmail, this.dataset.respPhone)"
                                        title="Editar">
                                        <i class="ph-bold ph-pencil-simple"></i>
                                    </button>
                                    <button class="btn-icon btn-icon-delete"
                                        onclick="deleteEstablishment('${est.id}', '${est.name}')" title="Remover">
                                        <i class="ph-bold ph-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', newRow);

                    // Update Dropdowns & Checkbox Lists
                    // 1. Update Selects (if any)
                    document.querySelectorAll('select[name="establishment_ids"]').forEach(sel => {
                        const opt = new Option(est.name, est.id);
                        sel.add(opt);
                    });

                    // 2. Update Checkbox List in Create Consultant Modal
                    const modalCheckList = document.querySelector('#createConsultantCard .form-check'); // Improve selector if needed, currently assumes structure
                    // More robust search for the container div inside formCreateConsultant
                    const checkContainer = document.querySelector('#formCreateConsultant div[style*="overflow-y"]');
                    if (checkContainer) {
                        const div = document.createElement('div');
                        div.className = 'form-check';
                        div.innerHTML = `
                            <input class="form-check-input" type="checkbox" name="establishment_ids"
                                value="${est.id}" id="chk-${est.id}">
                            <label class="form-check-label" for="chk-${est.id}">
                                ${est.name}
                            </label>
                        `;
                        checkContainer.appendChild(div);
                    }
                }
            } else {
                showToast(data.error || 'Erro desconhecido', 'error');
            }
        } catch (err) {
            console.error(err);
            showToast('Erro de conex√£o: ' + err.message, 'error');
        } finally {
            if (btn) { btn.disabled = false; btn.innerHTML = 'Adicionar'; }
        }
    }


    async function handleUpdateConsultant(e) {
        e.preventDefault();
        const id = document.getElementById('edit_consultant_id').value;
        const form = e.target;
        const btn = document.getElementById('btnUpdateConsultant');

        if (btn) { btn.disabled = true; btn.innerHTML = 'Salvando...'; }

        try {
            const formData = new FormData(form);
            const token = document.querySelector('input[name="csrf_token"]').value;
            const res = await fetch(`/manager/consultant/${id}/update`, {
                method: 'POST',
                body: formData,
                headers: {
                    'Accept': 'application/json',
                    'X-CSRFToken': token
                }
            });

            if (res.ok) {
                const data = await res.json(); // Get JSON response
                showToast('Consultor atualizado com sucesso!', 'success');
                document.getElementById('editConsultantCard').style.display = 'none';

                // Update DOM Row with Server Data
                const row = document.getElementById(`row-consultant-${id}`);
                if (row && data.consultant) {
                    const c = data.consultant;
                    const nameDiv = row.querySelector('div[style*="font-weight: 600"]');
                    if (nameDiv) nameDiv.textContent = c.name;

                    const avatarDiv = row.querySelector('.user-avatar-sm');
                    if (avatarDiv) avatarDiv.textContent = c.name[0].toUpperCase();

                    if (row.cells[1]) row.cells[1].textContent = c.email;

                    const editBtn = row.querySelector('.btn-icon-edit');
                    if (editBtn) {
                        editBtn.dataset.id = c.id;
                        editBtn.dataset.name = c.name;
                        editBtn.dataset.email = c.email;
                        editBtn.dataset.stores = JSON.stringify(c.establishment_ids || []);
                    }
                }
            }
            else {
                // Handle error
                const errData = await res.json().catch(() => ({}));
                showToast(errData.error || 'Erro ao atualizar', 'error');
            }
        } catch (err) { console.error(err); showToast('Erro: ' + err.message, 'error'); }
        finally { if (btn) { btn.disabled = false; btn.innerHTML = 'Atualizar'; } }
    }

    async function handleUpdateEst(e) {
        e.preventDefault();
        const id = document.getElementById('edit_est_id').value;
        const form = e.target;
        const btn = document.getElementById('btnUpdateEst');

        if (btn) { btn.disabled = true; btn.innerHTML = 'Salvando...'; }

        try {
            const formData = new FormData(form);
            const token = document.querySelector('input[name="csrf_token"]').value;
            const res = await fetch(`/manager/establishment/${id}/update`, {
                method: 'POST',
                body: formData,
                headers: {
                    'Accept': 'application/json',
                    'X-CSRFToken': token
                }
            });

            if (res.ok) {
                const data = await res.json();
                showToast('Estabelecimento atualizado com sucesso!', 'success');
                document.getElementById('editEstCard').style.display = 'none';

                const row = document.getElementById(`row-est-${id}`);
                if (row && data.establishment) {
                    const est = data.establishment;
                    // Update Name
                    const nameDiv = row.querySelector('div[style*="font-weight: 600"]');
                    if (nameDiv) nameDiv.textContent = est.name;

                    // Update Code
                    if (row.cells[1]) row.cells[1].textContent = est.code || '-';

                    // Update Edit Button Data
                    const editBtn = row.querySelector('.btn-icon-edit');
                    if (editBtn) {
                        editBtn.dataset.name = est.name;
                        editBtn.dataset.code = est.code || '';
                        editBtn.dataset.respName = est.responsible_name || '';
                        editBtn.dataset.respEmail = est.responsible_email || '';
                        editBtn.dataset.respPhone = est.responsible_phone || '';
                    }
                }
            }
            else {
                const errData = await res.json().catch(() => ({}));
                showToast(errData.error || 'Erro ao atualizar', 'error');
            }
        } catch (err) { console.error(err); showToast('Erro: ' + err.message, 'error'); }
        finally { if (btn) { btn.disabled = false; btn.innerHTML = 'Salvar'; } }
    }





    // Helper for Status Badges
    // Old getStatusBadge removed (duplicate). Using the robust one below.
    // ensure clear mapping in the main function.

    // Polling Logic
    async function updateLists() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const estId = urlParams.get('establishment_id') || '';
            const response = await fetch(`/api/status?establishment_id=${estId}&v=` + new Date().getTime());
            const data = await response.json();

            // Pending
            const pendingDiv = document.getElementById('list-pending-container');
            if (pendingDiv && data.pending) {
                if (data.pending.length > 0) {
                    pendingDiv.innerHTML = data.pending.map(item => `
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; font-size: 0.9rem;">
                            <div class="spinner" style="width: 16px; height: 16px; border: 2px solid var(--text-light); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <span style="font-weight: 500; color: var(--text-primary);">${item.name}</span>
                            <span class="badge badge-warning" style="margin-left: auto; cursor: pointer;" onclick="openTracker('${item.id}'); event.stopPropagation();">Processando</span>
                        </div>
                    `).join('');
                    const stat = document.getElementById('stat-pending');
                    if (stat) stat.textContent = data.pending.length;
                } else {
                    pendingDiv.innerHTML = '';
                    const stat = document.getElementById('stat-pending');
                    if (stat) stat.textContent = '0';
                }
            }

            // Pending / Processing (Home)
            const homeProcessing = document.getElementById('home-processing');
            const homeProcessingList = document.getElementById('home-processing-list');

            if (homeProcessing && homeProcessingList && data.pending) {
                if (data.pending.length > 0) {
                    homeProcessing.style.display = 'block';
                    homeProcessingList.innerHTML = data.pending.map(item => {
                        if (item.error) {
                            return `
                                <div style="padding: 1rem; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600; color: #ef4444;">
                                            <i class="ph-bold ph-warning-circle"></i> Erro: ${item.name}
                                        </div>
                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">${item.message || 'Falha no processamento.'}</div>
                                    </div>
                                    <span class="badge badge-danger">Falha</span>
                                </div>
                            `;
                        } else {
                            return `
                                <div style="padding: 1rem; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-primary);">${item.name}</div>
                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Iniciado h√° alguns instantes...</div>
                                    </div>
                                    <span class="badge badge-info" style="cursor: pointer;" onclick="openTracker('${item.id}'); event.stopPropagation();">Processando...</span>
                                </div>
                            `;
                        }
                    }).join('');
                } else {
                    homeProcessing.style.display = 'none';
                }
            }

            // Processed
            const tbody = document.getElementById('list-processed-tbody');
            const urgentCard = document.getElementById('urgent-approval-card');
            const urgentCount = document.getElementById('urgent-count');
            const statApprovals = document.getElementById('stat-approvals');
            const statCardApprovals = document.getElementById('stat-card-approvals');

            if (tbody && data.processed_raw && data.processed_raw.length > 0) {
                // Filter for urgent items
                const urgentItems = data.processed_raw.filter(item =>
                    item.status === 'PENDING_MANAGER_REVIEW'
                );

                // Update Urgent Card
                if (urgentItems.length > 0) {
                    if (urgentCard) urgentCard.style.display = 'block';
                    if (urgentCount) urgentCount.textContent = urgentItems.length;

                    if (statCardApprovals) statCardApprovals.style.display = 'flex';
                    if (statApprovals) statApprovals.textContent = urgentItems.length;
                } else {
                    if (urgentCard) urgentCard.style.display = 'none';
                    if (statCardApprovals) statCardApprovals.style.display = 'none';
                }

                // Main Table with Enhanced UI
                tbody.innerHTML = data.processed_raw.map(item => `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar avatar-xs bg-light-primary text-primary rounded-circle mr-3">
                                    <i class="ph-bold ph-storefront"></i>
                                </div>
                                <span class="font-weight-medium">${item.establishment}</span>
                            </div>
                        </td>
                        <td>${item.date}</td>
                        <td>${getStatusBadge(item.status, item.id)}</td>
                        <td>
                            <a href="${item.review_link}" class="btn btn-sm ${getActionButtonStyle(item.status)} shadow-sm">
                                ${getActionButtonIcon(item.status)} ${getActionButtonText(item.status)}
                            </a>
                        </td>
                    </tr>
                `).join('');

                // ... Home Pendencies logic (condensed for brevity, already robust in previous version, just ensure ID checks)
                const homePendencies = document.getElementById('home-pendencies');
                const homeList = document.getElementById('home-pendencies-list');

                const pendingValidation = data.processed_raw.filter(i =>
                    i.status === 'PENDING_MANAGER_REVIEW'
                );

                if (homePendencies && homeList) {
                    if (pendingValidation.length > 0) {
                        homePendencies.style.display = 'block';
                        homeList.innerHTML = pendingValidation.map(item => `
                            <div style="padding: 1rem; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary);">${item.establishment}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Realizada em ${item.date}</div>
                                </div>
                                <a href="${item.review_link}" class="btn btn-sm btn-accent">
                                    <i class="ph ph-check-square-offset"></i> Validar Agora
                                </a>
                            </div>
                        `).join('');
                    } else {
                        homePendencies.style.display = 'none';
                    }
                }
            } else if (tbody) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">Nenhuma vistoria encontrada.</td></tr>';
                if (urgentCard) urgentCard.style.display = 'none';
            }

        } catch (e) {
            console.error("Erro no polling:", e);
            const tbody = document.getElementById('list-processed-tbody');
            // Show error only if we were still loading or if data is missing
            if (tbody && (tbody.innerText.includes('Carregando') || tbody.innerText.trim() === '')) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-danger"><i class="ph-bold ph-warning-circle"></i> Erro de conex√£o. <a href="#" onclick="updateLists(); return false;">Tentar novamente</a></td></tr>`;
            }
        }
    }

    // Helper: Button Style based on Status
    function getActionButtonStyle(status) {
        if (status === 'PENDING_MANAGER_REVIEW') return 'btn-danger text-white'; // Urgent
        if (status === 'PROCESSING') return 'btn-white border disabled';
        return 'btn-white border'; // Default
    }

    // Helper: Button Icon
    function getActionButtonIcon(status) {
        if (status === 'PENDING_MANAGER_REVIEW') return '<i class="ph-bold ph-warning-circle"></i>';
        if (status === 'APPROVED') return '<i class="ph-bold ph-pencil-simple"></i>';
        return '<i class="ph-bold ph-eye"></i>';
    }

    // Helper: Button Text
    function getActionButtonText(status) {
        if (status === 'PENDING_MANAGER_REVIEW') return 'Validar Agora';
        if (status === 'APPROVED') return 'Visualizar';
        return 'Detalhes';
    }

    function getStatusBadge(status, id) {
        // Map backend enum to UI Badge
        const map = {
            'PROCESSING': { class: 'badge-primary', text: 'Processando AI' },
            'PENDING': { class: 'badge-secondary', text: 'Aguardando' },
            'PENDING_MANAGER_REVIEW': { class: 'badge-danger', text: 'Pendente Aprova√ß√£o' }, // Red for Urgency

            'APPROVED': { class: 'badge-success', text: 'Aprovado' },
            'PENDING_CONSULTANT_VERIFICATION': { class: 'badge-info', text: 'Em Verifica√ß√£o' },
            'COMPLETED': { class: 'badge-success', text: 'Conclu√≠do' },
            'REJECTED': { class: 'badge-dark', text: 'Rejeitado' },
            'FAILED': { class: 'badge-dark', text: 'Falha' }
        };

        const badge = map[status] || { class: 'badge-secondary', text: status || 'Desconhecido' };
        // Clickable badge logic
        if (id) {
            return `<span class="badge ${badge.class}" onclick="openTracker('${id}'); event.stopPropagation();" style="cursor: pointer;" title="Ver Status">${badge.text}</span>`;
        }
        return `<span class="badge ${badge.class}">${badge.text}</span>`;
    }

    // Format Currency (Simple BRL estimation)
    function formatMoney(val) {
        if (val === null || val === undefined) return '-';
        // Assume val is already in USD or needs conversion
        // If val < 10, it's likely USD. Let's show both or just BRL est.
        // User requested "dolar do dia". Without API, we use fixed rate 6.0 safe margin.
        const usd = parseFloat(val);
        const brl = usd * 6.0;
        return `R$ ${brl.toFixed(4)}`;
    }

    // Iniciar Polling
    updateLists();
    // Iniciar Polling (Otimizado para 60s para reduzir custos de BD)
    // setInterval(updateLists, 60000); // Removido para Zero Cost / Sob Demanda
</script>

<style>
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>

<!-- MODALS (Re-injected) -->
<script>
    // --- GENERIC AJAX FORM HANDLER (Applied to Manager Dashboard) ---
    document.addEventListener('DOMContentLoaded', () => {
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            if (form.getAttribute('action') && !form.classList.contains('no-ajax')) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const submitBtn = form.querySelector('button[type="submit"]');
                    const originalText = submitBtn ? submitBtn.innerHTML : '';

                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="ph-bold ph-spinner spin-anim"></i> Processando...';
                    }

                    try {
                        const formData = new FormData(form);
                        const res = await fetch(form.action, {
                            method: form.method || 'POST',
                            body: formData,
                            headers: { 'Accept': 'application/json', 'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value }
                        });

                        let data;
                        try { data = await res.json(); } catch (e) { data = { error: 'Resposta inv√°lida.' }; }

                        if (res.ok) {
                            showToast(data.message || 'Sucesso!', 'success');
                            form.reset();

                            // Close any parent card/modal
                            const parentCard = form.closest('.card');
                            if (parentCard && (parentCard.id.includes('create') || parentCard.id.includes('edit'))) {
                                parentCard.style.display = 'none';
                            }

                            // Reload for speed sensation + data consistency
                            setTimeout(() => window.location.reload(), 500);
                        } else {
                            showToast(data.error || 'Erro ao processar', 'error');
                        }
                    } catch (err) {
                        console.error(err);
                        showToast('Erro de conex√£o.', 'error');
                    } finally {
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalText;
                        }
                    }
                });
            }
        });
    });

    // --- UPDATED DELETE FUNCTIONS (With Toast + Delay) ---
    function getCsrfToken() {
        const input = document.querySelector('input[name="csrf_token"]');
        return input ? input.value : null;
    }

    async function deleteConsultant(id, name) {
        if (!confirm(`Remover consultor ${name}?`)) return;

        const token = getCsrfToken();
        if (!token) {
            alert('Erro: Token de seguran√ßa n√£o encontrado. Atualize a p√°gina.');
            return;
        }

        try {
            const res = await fetch(`/manager/consultant/${id}/delete`, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'X-CSRFToken': token
                }
            });

            const contentType = res.headers.get("content-type");
            let data;
            if (contentType && contentType.indexOf("application/json") !== -1) {
                data = await res.json();
            } else {
                throw new Error("Erro no servidor (n√£o retornou JSON).");
            }

            if (res.ok) {
                showToast('Consultor removido!', 'success');
                const row = document.getElementById(`row-consultant-${id}`);
                if (row) {
                    row.style.background = '#fee2e2';
                    setTimeout(() => row.remove(), 500);
                }
            } else {
                showToast(data.error || 'Erro ao remover', 'error');
            }
        } catch (err) {
            console.error(err);
            showToast('Erro de conex√£o ou servidor.', 'error');
        }
    }

    async function deleteEstablishment(id, name) {
        if (!confirm(`Remover loja ${name}?`)) return;

        const token = getCsrfToken();
        if (!token) {
            alert('Erro: Token de seguran√ßa n√£o encontrado. Atualize a p√°gina.');
            return;
        }

        try {
            const res = await fetch(`/manager/establishment/${id}/delete`, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'X-CSRFToken': token
                }
            });

            const contentType = res.headers.get("content-type");
            let data;
            if (contentType && contentType.indexOf("application/json") !== -1) {
                data = await res.json();
            } else {
                throw new Error("Erro no servidor (n√£o retornou JSON).");
            }

            if (res.ok) {
                showToast('Loja removida!', 'success');
                const row = document.getElementById(`row-est-${id}`);
                if (row) {
                    row.style.background = '#fee2e2';
                    setTimeout(() => row.remove(), 500);
                }
            } else {
                showToast(data.error || 'Erro ao remover', 'error');
            }
        } catch (err) {
            console.error(err);
            showToast('Erro de conex√£o ou servidor.', 'error');
        }
    }
</script>
<!-- TRACKER MODAL (Premium) -->
<div id="trackerModal" class="modal-overlay"
    style="display: none; z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
    <div class="modal-content glass-panel" style="max-width: 600px; width: 90%; position: relative; padding: 2rem;">
        <button onclick="document.getElementById('trackerModal').style.display='none'"
            style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748B;">&times;</button>

        <div style="text-align: center; margin-bottom: 2rem;">
            <h3 style="margin:0; color: #1e293b; font-weight: 700;">Status do Processamento</h3>
            <p id="trackerFile" style="color: #64748b; font-size: 0.9rem; margin-top: 0.5rem;">Carregando...</p>
        </div>

        <!-- Stepper -->
        <div class="tracker-stepper"
            style="display: flex; justify-content: space-between; position: relative; margin-bottom: 2rem;">
            <!-- Line -->
            <div
                style="position: absolute; top: 15px; left: 0; right: 0; height: 3px; background: #e2e8f0; z-index: 0;">
            </div>
            <div id="trackerProgressLine"
                style="position: absolute; top: 15px; left: 0; width: 0%; height: 3px; background: #10b981; z-index: 0; transition: width 0.5s;">
            </div>

            <!-- Steps (Generated via JS) -->
            <div class="step-item" style="z-index: 1; text-align: center; background: white; padding: 0 5px;">
                <div class="step-circle"
                    style="width: 32px; height: 32px; background: #10b981; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; font-weight: bold;">
                    1</div>
                <div class="step-label" style="font-size: 0.8rem; margin-top: 5px; color: #10b981;">Upload</div>
            </div>
            <!-- More steps... -->
        </div>

        <div id="trackerLogs"
            style="background: #f8fafc; padding: 1rem; border-radius: 8px; font-family: monospace; font-size: 0.8rem; color: #475569; max-height: 150px; overflow-y: auto;">
            <div style="color: #94a3b8;">Aguardando detalhes...</div>
        </div>

        <div style="text-align: center; margin-top: 2rem;">
            <button onclick="document.getElementById('trackerModal').style.display='none'" class="btn btn-primary"
                style="padding: 0.5rem 2rem;">Fechar</button>
        </div>
    </div>
</div>

<script>
    async function openTracker(inspId) {
        const modal = document.getElementById('trackerModal');
        const titleEl = document.getElementById('trackerFile');
        const logsEl = document.getElementById('trackerLogs');
        const stepperEl = document.querySelector('.tracker-stepper');

        modal.style.display = 'flex';
        titleEl.innerText = "Buscando informa√ß√µes...";
        logsEl.innerHTML = '<div style="color: #94a3b8;">Carregando...</div>';

        try {
            const res = await fetch(`/api/tracker/${inspId}`);
            const data = await res.json();

            if (data.error) {
                titleEl.innerText = "Erro ao carregar";
                logsEl.innerHTML = `<div style="color: red;">${data.error}</div>`;
                return;
            }

            titleEl.innerText = data.filename;

            // Render Logs
            if (data.logs && data.logs.length > 0) {
                logsEl.innerHTML = data.logs.map(l => `<div>‚Ä¢ ${l}</div>`).join('');
            } else {
                logsEl.innerHTML = '<div style="color: #94a3b8;">Nenhum log recente.</div>';
            }

            // Render Steps
            // Order: upload, ai_process, db_save, plan_gen, analysis
            const order = ['upload', 'ai_process', 'db_save', 'plan_gen', 'analysis'];
            let html = '';
            let activeCount = 0; // For progress line

            // Background Line
            html += '<div style="position: absolute; top: 15px; left: 10px; right: 10px; height: 3px; background: #e2e8f0; z-index: 0;"></div>';

            // Calculate progress width
            // If 5 steps, 100% / 4 gaps = 25% per gap.

            order.forEach((key, idx) => {
                const s = data.steps[key];
                let color = '#e2e8f0'; // Gray
                let icon = idx + 1;
                let labelColor = '#94a3b8';

                if (s.status === 'completed') {
                    color = '#10b981'; // Green
                    icon = '‚úì';
                    labelColor = '#059669';
                    activeCount = idx;
                } else if (s.status === 'current') {
                    color = '#3b82f6'; // Blue
                    icon = '<i class="ph-bold ph-spinner ph-spin"></i>';
                    labelColor = '#1e40af';
                    activeCount = idx; // Partial?
                } else if (s.status === 'error') {
                    color = '#ef4444'; // Red
                    icon = '!';
                    labelColor = '#dc2626';
                }

                html += `
            <div class="step-item" style="z-index: 1; text-align: center; flex:1; position: relative;">
                <div class="step-circle" style="width: 32px; height: 32px; background: ${color}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    ${icon}
                </div>
                <div class="step-label" style="font-size: 0.75rem; margin-top: 8px; font-weight: 600; color: ${labelColor};">
                    ${s.label}
                </div>
            </div>`;
            });

            // Progress Line
            const progressPct = (activeCount / (order.length - 1)) * 100;
            html += `<div style="position: absolute; top: 15px; left: 10px; width: ${progressPct}%; height: 3px; background: #10b981; z-index: 0; transition: width 0.5s;"></div>`;

            stepperEl.innerHTML = html;

        } catch (e) {
            console.error(e);
            titleEl.innerText = "Erro de conex√£o";
        }
    }
    // Expose
    window.openTracker = openTracker;
    // [FIX] Scroll Function exposed globally
    window.scrollToApprovals = function () {
        console.log("Scrolling to approvals...");
        const el = document.getElementById('tabela-planos');
        if (el) {
            el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            el.classList.add('highlight-section');
            setTimeout(() => el.classList.remove('highlight-section'), 2000);
        } else {
            console.warn("Elemento 'tabela-planos' n√£o encontrado");
        }
    }
</script>
{% endblock %}